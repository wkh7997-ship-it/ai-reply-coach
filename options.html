<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AI 피부 코치 - 고민 선택</title>
    <style>
        :root {
          --primary: #c7b3ff;
          --primary-strong: #8f7bff;
          --bg-deep: #05040b;
          --bg-top: #111322;
          --glass: rgba(8, 10, 24, 0.92);
          --text-main: #f9fafb;
          --text-sub: #cbd5f5;
          --text-muted: #9ca3c9;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
          font-family: -apple-system, BlinkMacSystemFont, "Pretendard", system-ui, sans-serif;
          min-height: 100vh;
          background:
            radial-gradient(circle at top, rgba(129,140,248,0.32) 0, transparent 55%),
            radial-gradient(circle at bottom, rgba(15,23,42,0.75) 0, transparent 62%),
            linear-gradient(160deg, var(--bg-top), var(--bg-deep));
          color: var(--text-main);
          display: flex;
          align-items: center;
          justify-content: center;
          padding: 18px 16px;
        }

        .shell { width: 100%; max-width: 440px; }

        .card {
          position: relative;
          background: var(--glass);
          border-radius: 26px;
          padding: 16px 16px 18px;
          border: 1px solid rgba(148,163,255,0.24);
          box-shadow: 0 20px 45px rgba(0,0,0,0.75),
                      0 0 0 1px rgba(15,23,42,0.7);
          backdrop-filter: blur(18px);
          overflow: hidden;
        }

        .top-accent {
          position: absolute;
          left: 12%;
          right: 12%;
          top: 10px;
          height: 1px;
          background: linear-gradient(90deg, transparent, rgba(244,229,200,0.75), transparent);
          opacity: 0.9;
        }

        /* 상단 헤더 */
        .top-bar {
          display: flex;
          align-items: center;
          justify-content: space-between;
          margin-bottom: 12px;
          margin-top: 6px;
        }

        .back-btn {
          background: transparent;
          border: none;
          color: var(--text-sub);
          font-size: 0.82rem;
          cursor: pointer;
        }

        .step-pill {
          padding: 3px 9px;
          border-radius: 999px;
          border: 1px solid rgba(148,163,255,0.65);
          font-size: 0.72rem;
          color: var(--text-sub);
          background: rgba(10,16,36,0.9);
        }

        .title {
          font-size: 1.32rem;
          font-weight: 750;
          text-align: center;
          margin-bottom: 4px;
        }

        .subtitle {
          font-size: 0.82rem;
          color: var(--text-muted);
          text-align: center;
          margin-bottom: 14px;
          line-height: 1.4;
        }

        /* 옵션 그리드 */
        .options-grid {
          display: grid;
          grid-template-columns: repeat(2, 1fr);
          gap: 8px;
          margin-bottom: 12px;
        }

        .option-chip {
          padding: 10px 10px;
          border-radius: 14px;
          border: 1px solid rgba(148,163,255,0.55);
          background: rgba(15,23,42,0.88);
          color: var(--text-sub);
          font-size: 0.78rem;
          cursor: pointer;
          transition: 0.18s;
          user-select: none;
        }

        .option-chip.selected {
          background:
            radial-gradient(circle at top left, rgba(199,179,255,0.28), transparent 55%),
            linear-gradient(135deg, rgba(129,140,248,0.25), rgba(15,23,42,0.98));
          border-color: rgba(248,250,252,0.9);
          color: #fff;
          box-shadow: 0 0 0 1px rgba(199,179,255,0.7),
                      0 10px 20px rgba(0,0,0,0.85);
        }

        .custom-input {
          width: 100%;
          border-radius: 12px;
          border: 1px solid rgba(148,163,255,0.45);
          background: rgba(2,6,23,0.95);
          color: #fff;
          padding: 7px 10px;
          font-size: 0.8rem;
          min-height: 42px;
          margin-top: 4px;
        }

        .btn {
          width: 100%;
          padding: 12px 0;
          border-radius: 999px;
          border: none;
          font-size: 0.95rem;
          font-weight: 650;
          cursor: pointer;
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 8px;
          margin-top: 10px;
        }

        .btn-primary {
          background: linear-gradient(135deg, var(--primary-strong), var(--primary));
          color: #fff;
        }

        .btn-secondary {
          background: transparent;
          border: 1px solid rgba(148,163,255,0.6);
          color: var(--text-sub);
        }

        .warning-text {
          color: #ff8f8f;
          font-size: 0.75rem;
          margin-top: 6px;
          height: 14px;
          text-align: center;
        }
    </style>
</head>

<body>
<div class="shell">
    <div class="card">
        <div class="top-accent"></div>

        <div class="top-bar">
            <button class="back-btn" onclick="goBack()">← 뒤로</button>
            <div></div>
            <div class="step-pill">STEP 3 / 4</div>
        </div>

        <div class="title">피부 고민을 알려주세요</div>
        <div class="subtitle">신경 쓰이는 고민을 <strong>최대 3개</strong> 선택해 주세요.</div>

        <div class="options-grid" id="options-grid">
            <div class="option-chip" data-value="여드름·뾰루지">여드름 · 뾰루지</div>
            <div class="option-chip" data-value="편평사마귀·사마귀">편평사마귀 · 사마귀</div>
            <div class="option-chip" data-value="모공·블랙헤드·피지">모공 · 블랙헤드 · 피지</div>
            <div class="option-chip" data-value="붉은기·홍조·민감 피부">붉은기 · 홍조 · 민감 피부</div>
            <div class="option-chip" data-value="잡티·기미·색소침착">잡티 · 기미 · 색소침착</div>
            <div class="option-chip" data-value="건조함·각질·피부 당김">건조함 · 각질 · 피부 당김</div>
            <div class="option-chip" data-value="주름·탄력 저하">주름 · 탄력 저하</div>
        </div>

        <textarea id="custom-concern" class="custom-input" placeholder="기타 고민 (선택)"></textarea>

        <div class="warning-text" id="warning-text"></div>

        <button class="btn btn-primary" id="next-btn" onclick="submitConcerns()">➡️ 다음 단계로</button>
        <button class="btn btn-secondary" onclick="goBack()">↩ 이전 단계로</button>
    </div>
</div>

<script>
    const warningEl = document.getElementById("warning-text");

    // 옵션 선택 처리
    document.querySelectorAll(".option-chip").forEach(chip => {
      chip.addEventListener("click", () => {
        const selectedCount = document.querySelectorAll(".option-chip.selected").length;

        if (chip.classList.contains("selected")) {
          chip.classList.remove("selected");
          warningEl.textContent = "";
          return;
        }

        if (selectedCount >= 3) {
          warningEl.textContent = "고민은 최대 3개까지 선택할 수 있어요.";
          return;
        }

        chip.classList.add("selected");
        warningEl.textContent = "";
      });
    });

    function goBack() {
      window.location.href = "confirm.html";
    }

    // AI 분석 서버 호출
    async function submitConcerns() {
      const selected = Array.from(document.querySelectorAll(".option-chip.selected"))
        .map(el => el.getAttribute("data-value"));

      const custom = document.getElementById("custom-concern").value.trim();
      if (custom) selected.push("기타: " + custom);

      if (selected.length === 0) {
        warningEl.textContent = "최소 1개의 고민을 선택해 주세요.";
        return;
      }

      sessionStorage.setItem("userConcerns", JSON.stringify(selected));

      const nextBtn = document.getElementById("next-btn");
      nextBtn.disabled = true;
      nextBtn.textContent = "AI 분석 중...";

      try {
        const res = await fetch("https://ai-reply-coach-3.onrender.com/api/analyze", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            skin_type: "unknown",
            problem_area: "얼굴 전체",
            concerns: selected
          })
        });

        if (!res.ok) {
          alert("AI 분석 서버 오류: " + res.status);
          nextBtn.disabled = false;
          nextBtn.textContent = "다음 단계로";
          return;
        }

        const data = await res.json();
        sessionStorage.setItem("aiSkinResult", JSON.stringify(data));
        window.location.href = "result.html";

      } catch (err) {
        alert("네트워크 오류가 발생했습니다.");
        nextBtn.disabled = false;
        nextBtn.textContent = "다음 단계로";
      }
    }
</script>

</body>
</html>
