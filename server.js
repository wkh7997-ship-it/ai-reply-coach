import express from "express";
import cors from "cors";
import bodyParser from "body-parser";
import path from "path";
import { fileURLToPath } from "url";
import OpenAI from "openai";

const app = express();

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ê²½ë¡œ ì„¤ì •
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// OpenAI í´ë¼ì´ì–¸íŠ¸
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Middlewares
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
app.use(cors());
app.use(bodyParser.json({ limit: "10mb" }));

// ì •ì  íŒŒì¼ ì œê³µ (index.html, confirm.html, result.html, chat.html ë“±)
app.use(express.static(__dirname));

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// 1) /api/analyze : í”¼ë¶€ ë¶„ì„ (ì´ì œ ì§„ì§œ OpenAI ì—°ë™)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// 1) /api/analyze : í”¼ë¶€ ë¶„ì„ (OpenAI)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
app.post("/api/analyze", async (req, res) => {
  try {
    console.log("ğŸŸ£ /api/analyze í˜¸ì¶œë¨");

    const { skin_type, problem_area, concerns, notes } = req.body || {};

    const concernsText = Array.isArray(concerns) ? concerns.join(", ") : "";

    // ğŸŸ¡ 1) ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸: ì—­í•  + "í…œí”Œë¦¿ì²˜ëŸ¼ ë°˜ë³µ ê¸ˆì§€" ê°•ì¡°
    const systemPrompt =
      "ë„ˆëŠ” í•œêµ­ì–´ë¡œë§Œ ëŒ€ë‹µí•˜ëŠ” ì „ë¬¸ 'AI í”¼ë¶€ ì½”ì¹˜'ì•¼. " +
      "ì‚¬ìš©ìì˜ í”¼ë¶€ ìƒíƒœë¥¼ ë³´ê³  í˜„ì‹¤ì ì¸ ì ìˆ˜ì™€ ê³ ë¯¼ í¬ì¸íŠ¸ë¥¼ ì •ë¦¬í•´ ì£¼ê³ , " +
      "ì¼ìƒì—ì„œ ë°”ë¡œ ì‹¤ì²œ ê°€ëŠ¥í•œ ê´€ë¦¬ ë£¨í‹´ì„ ì•Œë ¤ì¤˜.\n\n" +
      "- ê°™ì€ ì…ë ¥ì´ë¼ë„ í•­ìƒ ë˜‘ê°™ì€ ë¬¸ì¥ì„ ë°˜ë³µí•˜ì§€ ë§ê³ , í‘œí˜„ê³¼ ì˜ˆì‹œë¥¼ ë‹¤ì–‘í•˜ê²Œ ë°”ê¿”ì„œ ì„¤ëª…í•´.\n" +
      "- ëª¨ë“  ì‚¬ìš©ìê°€ ì„œë¡œ ë‹¤ë¥¸ ì‚¬ëŒì´ë¼ê³  ê°€ì •í•˜ê³ , ë§¤ë²ˆ ì¡°ê¸ˆì”© ë‹¤ë¥¸ ê´€ì ê³¼ ì¡°ì–¸ í¬ì¸íŠ¸ë¥¼ ì¡ì•„ ì¤˜.\n" +
      "- ë¬¸ì¥ì€ ìì—°ìŠ¤ëŸ½ê³  ë§ ê±¸ë“¯í•œ í†¤ìœ¼ë¡œ ì¨ì¤˜ (ì¡´ëŒ“ë§).";

    // ğŸŸ¡ 2) ìœ ì € í”„ë¡¬í”„íŠ¸: ì´ë²ˆ ì‚¬ìš©ìì˜ ì •ë³´ + JSON í˜•ì‹ ìš”êµ¬
    const userPrompt =
      "ë‹¤ìŒì€ ì´ë²ˆ ì‚¬ìš©ìì˜ í”¼ë¶€ ê´€ë ¨ ì •ë³´ì•¼. ì´ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ í”¼ë¶€ ìƒíƒœ ë¦¬í¬íŠ¸ë¥¼ ë§Œë“¤ì–´ ì¤˜.\n\n" +
      `- ì‚¬ìš©ìê°€ ê¸°ë¡í•œ í”¼ë¶€ íƒ€ì…: ${skin_type || "ì •ë³´ ì—†ìŒ"}\n` +
      `- ê³ ë¯¼ ë¶€ìœ„: ${problem_area || "ì •ë³´ ì—†ìŒ"}\n` +
      `- ì£¼ìš” ê³ ë¯¼ë“¤: ${concernsText || "ì •ë³´ ì—†ìŒ"}\n` +
      `- ê¸°íƒ€ ë©”ëª¨/ì´ë¯¸ì§€ ì„¤ëª…(ì¼ë¶€): ${(notes || "").slice(0, 400)}\n\n` +
      "ë°˜ë“œì‹œ ì•„ë˜ JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µí•´. ì„¤ëª… ë¬¸ì¥ ì—†ì´ JSONë§Œ ë°˜í™˜í•´ì•¼ í•´.\n\n" +
      "{\n" +
      '  "score": 0ì—ì„œ 100 ì‚¬ì´ì˜ ìˆ«ì,\n' +
      '  "skinType": "ì˜ˆ: ê±´ì„±/ì§€ì„±/ë³µí•©ì„±/ì¤‘ì„±/ë¯¼ê°ì„±" ì¤‘ í•˜ë‚˜ ë˜ëŠ” ì¡°í•©,\n' +
      '  "riskLevel": "low" ë˜ëŠ” "mid" ë˜ëŠ” "high",\n' +
      '  "issues": ["ì£¼ìš” ê³ ë¯¼1", "ì£¼ìš” ê³ ë¯¼2" ...],\n' +
      '  "summary": "ë‘ì„¸ ë¬¸ì¥ìœ¼ë¡œ ì „ì²´ í•œ ì¤„ ìš”ì•½ (í•­ìƒ í‘œí˜„ì„ ì¡°ê¸ˆì”© ë‹¤ë¥´ê²Œ)",\n' +
      '  "detailAdvice": "ì¼ìƒ ê´€ë¦¬ ê°€ì´ë“œ, ë£¨í‹´ ë° ì£¼ì˜ì‚¬í•­ ë“±ì„ 5~8ë¬¸ì¥ ì •ë„ë¡œ ìì„¸íˆ. ' +
      'í•­ìƒ ê°™ì€ ë¬¸ì¥ì„ ë°˜ë³µí•˜ì§€ ë§ê³ , ë¹„ìŠ·í•œ ìƒí™©ì´ë¼ë„ ì˜ˆì‹œì™€ ì„¤ëª… ìˆœì„œë¥¼ ì¡°ê¸ˆì”© ë°”ê¿” ì¤˜."\n' +
      "}";

    // ğŸ”¥ OpenAI í˜¸ì¶œ: temperatureë¥¼ ì˜¬ë ¤ì„œ ë‹¤ì–‘ì„± í™•ë³´
    const aiRes = await openai.responses.create({
      model: "gpt-4.1-mini",
      temperature: 1.1,     // â† ì´ ê°’ì´ ë†’ì„ìˆ˜ë¡ ë‚´ìš©ì´ ë” ë‹¬ë¼ì§ (0.7~1.3 ì‚¬ì´ ì¶”ì²œ)
      top_p: 0.95,
      input: [
        { role: "system", content: systemPrompt },
        { role: "user", content: userPrompt },
      ],
    });

    const rawText = aiRes.output?.[0]?.content?.[0]?.text?.trim() || "";
    console.log("ğŸŸ¢ OpenAI ì›ë³¸ ì‘ë‹µ í…ìŠ¤íŠ¸:", rawText);

    let parsed;
    try {
      parsed = JSON.parse(rawText);
    } catch (e) {
      console.warn("âš  JSON íŒŒì‹± ì‹¤íŒ¨, fallback ì‚¬ìš©:", e);
      parsed = {
        score: 70,
        skinType: skin_type || "ë³µí•©ì„±",
        riskLevel: "mid",
        issues: Array.isArray(concerns) && concerns.length ? concerns : ["ëª¨ê³µ", "í”¼ì§€"],
        summary: "ì „ë°˜ì ìœ¼ë¡œ ë¬´ë‚œí•œ í”¼ë¶€ ìƒíƒœì§€ë§Œ ì¼ë¶€ ë¶€ìœ„ì˜ ìœ ë¶„Â·ê±´ì¡° ë°¸ëŸ°ìŠ¤ë¥¼ ì¡°ê¸ˆ ë” ë§ì¶°ì£¼ë©´ ì¢‹ì•„ìš”.",
        detailAdvice:
          rawText ||
          "ì„¸ì•ˆì œëŠ” ìê·¹ì´ ì ì€ ì•½ì‚°ì„± ì œí’ˆì„ ì‚¬ìš©í•˜ì‹œê³ , Tì¡´ì€ ìœ ë¶„ ì¡°ì ˆ, Uì¡´ì€ ë³´ìŠµ ìœ„ì£¼ë¡œ ë‚˜ëˆ  ê´€ë¦¬í•´ ë³´ì„¸ìš”. ë‚®ì—ëŠ” ìì™¸ì„  ì°¨ë‹¨ì œë¥¼ ê¼¼ê¼¼íˆ ë°”ë¥´ê³ , ë°¤ì—ëŠ” ê³¼í•œ ê°ì§ˆ ì œê±°ë³´ë‹¤ëŠ” ì§„ì •Â·ë³´ìŠµ ìœ„ì£¼ì˜ ë£¨í‹´ì„ ìœ ì§€í•˜ëŠ” ê²Œ ì¢‹ìŠµë‹ˆë‹¤.",
      };
    }

    const scoreNum = Number(parsed.score);
    const score =
      Number.isFinite(scoreNum) ? Math.min(Math.max(scoreNum, 0), 100) : 70;

    const risk =
      parsed.riskLevel === "low" || parsed.riskLevel === "high"
        ? parsed.riskLevel
        : "mid";

    const issues = Array.isArray(parsed.issues) ? parsed.issues : [];

    const result = {
      score,
      skinType: parsed.skinType || "ë³µí•©ì„±",
      riskLevel: risk,
      issues,
      summary:
        parsed.summary ||
        "ì „ë°˜ì ìœ¼ë¡œ ë¬´ë‚œí•œ í”¼ë¶€ ìƒíƒœì…ë‹ˆë‹¤. íŠ¹ì • ë¶€ìœ„ ê´€ë¦¬ì— ì¡°ê¸ˆ ë” ì‹ ê²½ ì¨ì£¼ë©´ ì¢‹ì•„ìš”.",
      detailAdvice:
        parsed.detailAdvice ||
        "ì„¸ì•ˆ í›„ í”¼ë¶€ íƒ€ì…ì— ë§ëŠ” ë³´ìŠµì œë¥¼ ì¶©ë¶„íˆ ì‚¬ìš©í•˜ê³ , ë‚®ì—ëŠ” ìì™¸ì„  ì°¨ë‹¨ì œë¥¼ ê¼¼ê¼¼íˆ ë°”ë¥´ëŠ” ê²ƒë§Œìœ¼ë¡œë„ í° ë„ì›€ì´ ë©ë‹ˆë‹¤.",
    };

    return res.json(result);
  } catch (err) {
    console.error("âŒ /api/analyze OpenAI ë¶„ì„ ì˜¤ë¥˜:", err);
    return res.status(500).json({
      error: "AI ë¶„ì„ ì¤‘ ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.",
    });
  }
});
