<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AI í”¼ë¶€ ì½”ì¹˜ - ì¶”ì²œ ì œí’ˆ</title>

  <style>
    :root {
      --primary: #9b8bff;
      --primary-strong: #5c6bff;
      --bg-deep: #050616;
      --bg-top: #11152b;
      --glass: rgba(10, 14, 32, 0.95);
      --text-main: #f9fafb;
      --text-sub: #cbd5f5;
      --border-soft: rgba(148, 163, 255, 0.35);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: Pretendard, -apple-system, BlinkMacSystemFont, sans-serif;
      min-height: 100vh;
      background:
        radial-gradient(circle at top, rgba(88,101,242,0.32) 0, transparent 55%),
        radial-gradient(circle at bottom, rgba(59,130,246,0.26) 0, transparent 62%),
        linear-gradient(160deg, var(--bg-top), var(--bg-deep));
      color: var(--text-main);
      display: flex;
      justify-content: center;
      padding: 14px;
    }

    .shell {
      width: 100%;
      max-width: 440px;
    }

    .card {
      background: var(--glass);
      border-radius: 26px;
      padding: 18px 16px 18px;
      border: 1px solid var(--border-soft);
      box-shadow:
        0 22px 50px rgba(0, 0, 0, 0.9),
        0 0 0 1px rgba(15, 23, 42, 0.7);
      backdrop-filter: blur(18px);
      overflow-y: auto;
      max-height: calc(100vh - 28px);
    }

    .top-accent {
      position: absolute;
      left: 14%;
      right: 14%;
      top: 10px;
      height: 1px;
      background: linear-gradient(
        90deg,
        transparent,
        rgba(148,163,255,0.7),
        transparent
      );
    }

    .header {
      text-align: center;
      margin-bottom: 16px;
    }

    .title {
      font-size: 1.45rem;
      font-weight: 750;
      letter-spacing: 0.04em;
    }

    .subtitle {
      margin-top: 6px;
      color: var(--text-sub);
      font-size: 0.85rem;
      line-height: 1.4;
    }

    /* íƒœê·¸ */
    .context-block {
      margin-top: 12px;
      margin-bottom: 12px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .tag-chip {
      font-size: 0.78rem;
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(148,163,255,0.45);
      color: #e5e7ef;
    }

    /* êµ¬ë¶„ ë¼ë²¨ */
    .section-label {
      font-size: 0.9rem;
      font-weight: 700;
      margin: 14px 0 8px;
      padding-left: 6px;
      border-left: 3px solid rgba(148,163,255,0.7);
    }

    /* ì œí’ˆ ì¹´ë“œ */
    .product-card {
      background: rgba(15, 23, 42, 0.92);
      border-radius: 18px;
      padding: 12px;
      margin-bottom: 12px;
      border: 1px solid rgba(148,163,255,0.45);
      box-shadow: 0 6px 18px rgba(0,0,0,0.45);
    }

    .product-main {
      display: flex;
      gap: 10px;
      align-items: flex-start;
    }

    .product-thumb {
      width: 62px;
      height: 62px;
      border-radius: 14px;
      overflow: hidden;
      background: rgba(15,23,42,0.8);
      border: 1px solid rgba(148,163,255,0.4);
      flex-shrink: 0;
    }

    .product-thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .product-text { flex: 1; }

    .product-name {
      font-size: 0.95rem;
      font-weight: 700;
      color: #fdfcff;
    }

    .product-desc {
      margin-top: 4px;
      font-size: 0.80rem;
      color: var(--text-sub);
      line-height: 1.45;
    }

    .product-link-wrap { margin-top: 8px; }

    .product-link-btn {
      display: inline-block;
      padding: 7px 12px;
      border-radius: 999px;
      background: linear-gradient(135deg, var(--primary-strong), var(--primary));
      color: white;
      font-size: 0.82rem;
      font-weight: 650;
      text-decoration: none;
      box-shadow: 0 10px 22px rgba(88,81,233,0.55);
    }

    .btn-wrap {
      margin-top: 16px;
    }

    .back-btn {
      width: 100%;
      padding: 12px 0;
      border-radius: 18px;
      background: transparent;
      border: 1px solid rgba(148,163,255,0.5);
      color: var(--text-main);
      font-size: 0.95rem;
      font-weight: 650;
      cursor: pointer;
    }
  </style>
</head>

<body>
<div class="shell">
  <div class="card">
    <div class="top-accent"></div>

    <div class="header">
      <div class="title">ì¶”ì²œ ì œí’ˆ ëª©ë¡</div>
      <div class="subtitle">
        ë°©ê¸ˆ ì§„ë‹¨í•œ í”¼ë¶€ ìƒíƒœì— ë§ì¶°<br />
        AIê°€ ìƒí’ˆì„ ìë™ ì¶”ì²œí•´ ë“œë ¤ìš”.
      </div>
    </div>

    <div id="context-tags" class="context-block"></div>

    <div class="section-label">ê¸°ë³¸ ë£¨í‹´ ì¶”ì²œ</div>
    <div id="essential-list"></div>

    <div class="section-label">ì§‘ì¤‘ ì¼€ì–´ ì¶”ì²œ</div>
    <div id="focus-list"></div>

    <div class="btn-wrap">
      <button class="back-btn" onclick="goBack()">ì´ì „ ê²°ê³¼ë¡œ ëŒì•„ê°€ê¸°</button>
    </div>
  </div>
</div>
<script>
  /* ---------------------------------------
     1) ì´ì „ ì§„ë‹¨ ì •ë³´ + ê³ ë¯¼ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°
  --------------------------------------- */
  function loadContext() {
    const tagsWrap = document.getElementById("context-tags");
    tagsWrap.innerHTML = "";

    // ì €ì¥ëœ ì§„ë‹¨ ì •ë³´
    const historyRaw = localStorage.getItem("diagnosisHistory");
    let latest = null;
    if (historyRaw) {
      try {
        const history = JSON.parse(historyRaw);
        latest = Array.isArray(history) && history.length > 0 ? history[0] : null;
      } catch (e) {
        console.error("diagnosisHistory íŒŒì‹± ì˜¤ë¥˜:", e);
      }
    }

    // ì €ì¥ëœ ê³ ë¯¼ ì •ë³´
    const concernsRaw = sessionStorage.getItem("userConcerns");
    let concerns = [];
    if (concernsRaw) {
      try {
        concerns = JSON.parse(concernsRaw);
      } catch (e) {
        console.error("userConcerns íŒŒì‹± ì˜¤ë¥˜:", e);
      }
    }

    // íƒœê·¸ í‘œì‹œ
    if (latest && latest.skinType) {
      const chip = document.createElement("span");
      chip.className = "tag-chip";
      chip.innerText = `í”¼ë¶€ íƒ€ì…: ${latest.skinType}`;
      tagsWrap.appendChild(chip);
    }

    if (concerns.length > 0) {
      concerns.forEach((c) => {
        const chip = document.createElement("span");
        chip.className = "tag-chip";
        chip.innerText = c;
        tagsWrap.appendChild(chip);
      });
    }

    return { latest, concerns };
  }

  /* ---------------------------------------
     2) Coupang ë§í¬ JSON ë¶ˆëŸ¬ì˜¤ê¸°
  --------------------------------------- */
  async function loadLinks() {
    try {
      const res = await fetch("/data/coupang-links.json");
      if (!res.ok) throw new Error("HTTP " + res.status);
      return await res.json();
    } catch (e) {
      console.error("coupang-links.json ë¡œë“œ ì‹¤íŒ¨:", e);
      return {};
    }
  }

  /* ---------------------------------------
     3) ëœë¤ ì œí’ˆ ì„ íƒ
  --------------------------------------- */
  function pickRandomProduct(category) {
    if (!category || !Array.isArray(category.items) || category.items.length === 0) {
      return null;
    }
    const idx = Math.floor(Math.random() * category.items.length);
    return category.items[idx];
  }

  /* ---------------------------------------
     4) ì¶”ì²œ êµ¬ì„± (ë£¨í‹´ + ê³ ë¯¼ë³„ ì¼€ì–´)
  --------------------------------------- */
  function buildRecommendations(context, links) {
    const { latest, concerns } = context;
    const skinType = latest?.skinType || "ë³µí•©ì„±";
    const concernText = (concerns || []).join(" ");

    const essential = [];
    const focus = [];

    /* ---------- ğŸ§´ 1) ê¸°ë³¸ ë£¨í‹´ êµ¬ì„± ---------- */

    // í´ë Œì €
    const cleanserItem = pickRandomProduct(links.cleanser);
    essential.push({
      name: "í´ë Œì €",
      desc: "ìê·¹ì€ ì¤„ì´ê³  í”¼ë¶€ ì¥ë²½ì€ ì§€ì¼œì£¼ëŠ” ì•½ì‚°ì„± í´ë Œì €ê°€ ì¢‹ì•„ìš”.",
      image: cleanserItem?.image || null,
      url: cleanserItem?.url || null
    });

    // í† ë„ˆ
    const tonerItem = pickRandomProduct(links.toner);
    essential.push({
      name: "í† ë„ˆ",
      desc: "ì„¸ì•ˆ í›„ ë‹¹ê¹€ì„ ì™„í™”í•˜ê³  í”¼ë¶€ ë°¸ëŸ°ìŠ¤ë¥¼ ì¡ì•„ì£¼ëŠ” ê¸°ë³¸ ë³´ìŠµ í† ë„ˆ.",
      image: tonerItem?.image || null,
      url: tonerItem?.url || null
    });

    // ì¥ë²½ í¬ë¦¼
    const ceramideItem = pickRandomProduct(links.ceramideCream);
    essential.push({
      name: "ì¥ë²½ í¬ë¦¼",
      desc: "ì„¸ë¼ë§ˆì´ë“œ ê¸°ë°˜ ë³´ìŠµ í¬ë¦¼ìœ¼ë¡œ í”¼ë¶€ë¥¼ ê²¬ê³ í•˜ê²Œ ë³´í˜¸í•´ ì¤ë‹ˆë‹¤.",
      image: ceramideItem?.image || null,
      url: ceramideItem?.url || null
    });

    // ì„ í¬ë¦¼
    const sunItem = pickRandomProduct(links.sunscreen);
    essential.push({
      name: "ì„ í¬ë¦¼",
      desc: "ìì™¸ì„ ì€ ëª¨ë“  í”¼ë¶€ ë¬¸ì œì˜ ì›ì¸ì´ ë  ìˆ˜ ìˆì–´ìš”. SPF 50 ê¶Œì¥!",
      image: sunItem?.image || null,
      url: sunItem?.url || null
    });

    /* ---------- ğŸ¯ 2) ê³ ë¯¼ ê¸°ë°˜ ì§‘ì¤‘ ì¼€ì–´ ---------- */

    const hasAcne = /ì—¬ë“œë¦„|ë¾°ë£¨ì§€/i.test(concernText);
    const hasPore = /ëª¨ê³µ|í”¼ì§€|ë¸”ë™í—¤ë“œ/i.test(concernText);
    const hasPigment = /ê¸°ë¯¸|ì¡í‹°|ìƒ‰ì†Œ/i.test(concernText);
    const hasRed = /ë¶‰ì€ê¸°|í™ì¡°|ë¯¼ê°/i.test(concernText);

    // ì—¬ë“œë¦„ ì¼€ì–´
    if (hasAcne) {
      const item = pickRandomProduct(links.acne);
      focus.push({
        name: "ì—¬ë“œë¦„ ìŠ¤íŒŸ ì¼€ì–´",
        desc: "í™œì„± ì—¬ë“œë¦„ ë¶€ìœ„ì—ë§Œ ì†ŒëŸ‰ ì‚¬ìš©í•˜ëŠ” êµ­ì†Œ ì¼€ì–´ ì œí’ˆì…ë‹ˆë‹¤.",
        image: item?.image || null,
        url: item?.url || null
      });
    }

    // ëª¨ê³µÂ·í”¼ì§€ ì¼€ì–´
    if (hasPore) {
      const item = pickRandomProduct(links.pore);
      focus.push({
        name: "ëª¨ê³µÂ·í”¼ì§€ ì¼€ì–´",
        desc: "ë¸”ë™í—¤ë“œì™€ ëª¨ê³µ ê´€ë¦¬ì— íš¨ê³¼ì ì¸ ì €ìê·¹ í•„ë§ë¥˜ì…ë‹ˆë‹¤.",
        image: item?.image || null,
        url: item?.url || null
      });
    }

    // ìƒ‰ì†Œì¹¨ì°©Â·ì¡í‹° ì¼€ì–´
    if (hasPigment) {
      const item = pickRandomProduct(links.pigment);
      focus.push({
        name: "ìƒ‰ì†Œì¹¨ì°© ì¼€ì–´",
        desc: "ê¸°ë¯¸Â·ì¡í‹° ì™„í™”ì— ë„ì›€ì„ ì£¼ëŠ” ë¯¸ë°± ê¸°ëŠ¥ì„± ì—ì„¼ìŠ¤ ê³„ì—´ì…ë‹ˆë‹¤.",
        image: item?.image || null,
        url: item?.url || null
      });
    }

    // ì§„ì •Â·ë¶‰ì€ê¸° ì¼€ì–´
    if (hasRed) {
      const item = pickRandomProduct(links.soothing);
      focus.push({
        name: "ì§„ì • ì¼€ì–´",
        desc: "í”¼ë¶€ ì—´ê°ê³¼ ë¶‰ì€ê¸°ë¥¼ ì™„í™”ì‹œí‚¤ëŠ” ì§„ì • ì„±ë¶„ ì œí’ˆì´ì—ìš”.",
        image: item?.image || null,
        url: item?.url || null
      });
    }

    return { essential, focus };
  }

  /* ---------------------------------------
     5) ì œí’ˆ ì¹´ë“œ ìƒì„±
  --------------------------------------- */
  function createProductCard(item) {
    const card = document.createElement("div");
    card.className = "product-card";

    const imgHTML = item.image
      ? `<div class="product-thumb"><img src="${item.image}" alt=""></div>`
      : `<div class="product-thumb" style="background:#222"></div>`;

    const linkHTML = item.url
      ? `<div class="product-link-wrap">
           <a href="${item.url}" target="_blank" class="product-link-btn">ì¿ íŒ¡ì—ì„œ ë³´ê¸°</a>
         </div>`
      : "";

    card.innerHTML = `
      <div class="product-main">
        ${imgHTML}
        <div class="product-text">
          <div class="product-name">${item.name}</div>
          <div class="product-desc">${item.desc}</div>
        </div>
      </div>
      ${linkHTML}
    `;

    return card;
  }

  /* ---------------------------------------
     6) ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
  --------------------------------------- */
  function renderLists(essential, focus) {
    const es = document.getElementById("essential-list");
    const fc = document.getElementById("focus-list");

    es.innerHTML = "";
    fc.innerHTML = "";

    essential.forEach((p) => es.appendChild(createProductCard(p)));
    focus.forEach((p) => fc.appendChild(createProductCard(p)));
  }

  /* ---------------------------------------
     7) ë’¤ë¡œê°€ê¸°
  --------------------------------------- */
  function goBack() {
    window.location.href = "result.html";
  }

  /* ---------------------------------------
     8) ì‹¤í–‰ ì‹œì‘
  --------------------------------------- */
  window.addEventListener("DOMContentLoaded", async () => {
    const context = loadContext();
    const links = await loadLinks();
    const { essential, focus } = buildRecommendations(context, links);
    renderLists(essential, focus);
  });
</script>
</body>
</html>
