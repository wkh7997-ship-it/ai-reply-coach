<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AI í”¼ë¶€ ì½”ì¹˜ - ì¶”ì²œ ì œí’ˆ</title>
  <style>
    :root {
      --primary: #9b8bff;
      --primary-strong: #5c6bff;
      --bg-deep: #050616;
      --bg-top: #11152b;
      --glass: rgba(10, 14, 32, 0.96);
      --text-main: #f9fafb;
      --text-sub: #cbd5f5;
      --border-soft: rgba(148, 163, 255, 0.35);
      --badge-bg: rgba(15, 23, 42, 0.9);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: Pretendard, -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
      min-height: 100vh;
      background:
        radial-gradient(circle at top, rgba(148,163,255,0.32) 0, transparent 55%),
        radial-gradient(circle at bottom, rgba(59,130,246,0.26) 0, transparent 62%),
        linear-gradient(160deg, var(--bg-top), var(--bg-deep));
      color: var(--text-main);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px 14px;
    }

    .shell { width: 100%; max-width: 440px; }

    .card {
      background: var(--glass);
      border-radius: 26px;
      padding: 14px 16px 14px;
      border: 1px solid var(--border-soft);
      box-shadow:
        0 22px 50px rgba(0,0,0,0.9),
        0 0 0 1px rgba(15,23,42,0.7);
      backdrop-filter: blur(18px);
      position: relative;
      overflow: hidden;
      max-height: calc(100vh - 32px);
      display: flex;
      flex-direction: column;
    }

    .card-inner-scroll {
      overflow-y: auto;
      padding-right: 2px;
      margin-right: -4px;
      flex: 1;
    }

    .top-accent {
      position: absolute;
      left: 14%; right: 14%; top: 10px;
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(148,163,255,0.9), transparent);
      opacity: 0.95;
    }

    .top-bar {
      position: relative;
      z-index: 2;
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 6px;
      margin-bottom: 8px;
    }

    .top-bar-left,
    .top-bar-center,
    .top-bar-right {
      display: flex;
      align-items: center;
    }

    .top-bar-left { min-width: 70px; justify-content: flex-start; }
    .top-bar-center { flex: 1; justify-content: center; font-size: 0.9rem; font-weight: 600; }
    .top-bar-right { min-width: 70px; justify-content: flex-end; }

    .back-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      background: transparent;
      border: none;
      font-size: 0.82rem;
      color: var(--text-sub);
      cursor: pointer;
      padding: 4px 6px;
    }

    .step-pill {
      padding: 3px 9px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,255,0.7);
      font-size: 0.72rem;
      color: rgba(203,213,255,0.95);
      background: rgba(10,16,40,0.95);
      white-space: nowrap;
    }

    .header-wrap {
      margin-bottom: 8px;
    }

    .header-title {
      font-size: 1.3rem;
      font-weight: 750;
      line-height: 1.2;
    }

    .header-sub {
      font-size: 0.8rem;
      color: var(--text-sub);
      margin-top: 4px;
      line-height: 1.5;
    }

    .badge-row {
      margin-top: 6px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .badge {
      font-size: 0.72rem;
      padding: 3px 7px;
      border-radius: 999px;
      background: var(--badge-bg);
      border: 1px solid rgba(148,163,255,0.4);
      color: rgba(226,232,255,0.96);
    }

    .loading {
      text-align: center;
      font-size: 0.85rem;
      color: var(--text-sub);
      padding: 12px 6px;
    }

    .product-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 6px;
      margin-bottom: 8px;
    }

    .product-card {
      border-radius: 18px;
      padding: 10px 11px;
      background: rgba(11,17,38,0.96);
      border: 1px solid rgba(148,163,255,0.3);
      display: flex;
      gap: 10px;
    }

    .product-thumb {
      width: 64px;
      height: 64px;
      border-radius: 16px;
      background: radial-gradient(circle at top left, rgba(148,163,255,0.3), transparent 60%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.6rem;
    }

    .product-thumb img {
      width: 100%;
      height: 100%;
      border-radius: inherit;
      object-fit: cover;
      display: block;
    }

    .product-body {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .product-name {
      font-size: 0.92rem;
      font-weight: 650;
      line-height: 1.3;
    }

    .product-summary {
      font-size: 0.8rem;
      color: var(--text-sub);
      line-height: 1.4;
    }

    .product-tags {
      margin-top: 3px;
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }

    .tag-pill {
      font-size: 0.72rem;
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(30,64,175,0.9);
      border: 1px solid rgba(191,219,254,0.75);
      color: #e0f2fe;
    }

    .product-footer {
      margin-top: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .match-text {
      font-size: 0.74rem;
      color: rgba(196,181,253,0.95);
    }

    .link-btn {
      padding: 7px 10px;
      border-radius: 999px;
      border: none;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      background: linear-gradient(135deg, #f97316, #ea580c);
      color: #fff7ed;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }

    .link-btn span {
      font-size: 1rem;
    }

    .footer-note {
      font-size: 0.72rem;
      color: rgba(148,163,255,0.9);
      text-align: center;
      margin-top: 4px;
      margin-bottom: 2px;
      line-height: 1.4;
    }

    .btn-wrap {
      margin-top: 8px;
      padding-top: 6px;
      border-top: 1px solid rgba(15,23,42,0.9);
    }

    .nav-btn {
      width: 100%;
      padding: 11px 12px;
      border-radius: 18px;
      border: 1px solid rgba(148,163,255,0.45);
      background:
        radial-gradient(circle at top left, rgba(148,163,255,0.18), transparent 60%),
        rgba(12,16,40,0.95);
      color: #e5e7ff;
      font-size: 0.9rem;
      font-weight: 620;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      cursor: pointer;
      box-shadow:
        0 6px 18px rgba(0,0,0,0.45),
        0 0 0 1px rgba(15,23,42,0.8);
      margin-bottom: 6px;
    }
  </style>
</head>

<body>
<div class="shell">
  <div class="card">
    <div class="top-accent"></div>

    <div class="top-bar">
      <div class="top-bar-left">
        <button class="back-btn" onclick="goBack()">â† ê²°ê³¼ë¡œ</button>
      </div>
      <div class="top-bar-center">
        ì¶”ì²œ ì œí’ˆ ë³´ê¸°
      </div>
      <div class="top-bar-right">
        <div class="step-pill">STEP 4 Â· ì¶”ì²œ</div>
      </div>
    </div>

    <div class="header-wrap" id="header-info">
      <div class="header-title">ì˜¤ëŠ˜ ì§„ë‹¨ì— ë§ëŠ” ì œí’ˆ</div>
      <div class="header-sub">
        ê°€ì¥ ìµœê·¼ AI í”¼ë¶€ ì§„ë‹¨ ê²°ê³¼ë¥¼ ê¸°ë°˜ìœ¼ë¡œ<br />
        ì¿ íŒ¡íŒŒíŠ¸ë„ˆìŠ¤ ìƒí’ˆì„ ì¶”ì²œí•´ ë“œë¦½ë‹ˆë‹¤.
      </div>
      <div class="badge-row" id="badge-row"></div>
    </div>

    <div class="card-inner-scroll">
      <div id="loading" class="loading">ì¶”ì²œ ì œí’ˆì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>
      <div id="product-list" class="product-list" style="display:none;"></div>

      <div class="footer-note">
        * ë§í¬ëŠ” ì¿ íŒ¡íŒŒíŠ¸ë„ˆìŠ¤ ì œíœ´ ë§í¬ì¼ ìˆ˜ ìˆìœ¼ë©°, êµ¬ë§¤ ì‹œ ì†Œì •ì˜ ìˆ˜ìˆ˜ë£Œë¥¼ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br/>
        * ì‹¤ì œ í”¼ë¶€ ìƒíƒœì™€ ë§ì§€ ì•Šê±°ë‚˜ ìê·¹ì´ ëŠê»´ì§ˆ ê²½ìš° ì‚¬ìš©ì„ ì¤‘ë‹¨í•˜ê³  ì „ë¬¸ê°€ì™€ ìƒë‹´í•˜ì„¸ìš”.
      </div>
    </div>

    <div class="btn-wrap">
      <button class="nav-btn" onclick="goHome()">
        <span>ğŸ </span>
        <span>ì²« í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ê¸°</span>
      </button>
    </div>
  </div>
</div>

<script>
  const API_BASE = "https://ai-reply-coach-3.onrender.com";

  function getLatestDiagnosis() {
    try {
      const raw = localStorage.getItem("diagnosisHistory");
      if (!raw) return null;
      const arr = JSON.parse(raw);
      return Array.isArray(arr) && arr.length ? arr[0] : null;
    } catch {
      return null;
    }
  }

  function renderHeaderBadges(diag) {
    const row = document.getElementById("badge-row");
    row.innerHTML = "";

    if (!diag) {
      row.innerHTML =
        '<span class="badge">ìµœê·¼ ì§„ë‹¨ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</span>';
      return;
    }

    const items = [
      diag.skinType ? `í”¼ë¶€ íƒ€ì…: ${diag.skinType}` : "",
      typeof diag.score === "number" ? `ì ìˆ˜: ${diag.score}ì ` : "",
      diag.riskLevel ? `ìœ„í—˜ë„: ${diag.riskLevel}` : ""
    ].filter(Boolean);

    if (!items.length) {
      row.innerHTML =
        '<span class="badge">ìµœê·¼ ì§„ë‹¨ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì™”ì–´ìš”.</span>';
      return;
    }

    row.innerHTML = items
      .map((t) => `<span class="badge">${t}</span>`)
      .join("");
  }

  // ê°„ë‹¨í•œ ë§¤ì¹­ ì ìˆ˜ ê³„ì‚° (í”¼ë¶€ íƒ€ì… + ìš”ì•½ í…ìŠ¤íŠ¸ ê¸°ë°˜)
  function computeMatchScore(prod, diag) {
    if (!diag) return 0;
    let score = 0;

    const skinTypeTag = prod.skinType || prod.forSkinType || "";
    const diagSkin = diag.skinType || "";
    if (Array.isArray(skinTypeTag)) {
      if (skinTypeTag.includes(diagSkin)) score += 3;
    } else if (typeof skinTypeTag === "string" && diagSkin) {
      if (skinTypeTag.includes(diagSkin)) score += 3;
    }

    const concernsTags = prod.concerns || prod.tags || [];
    const text = (diag.summary || "").toLowerCase();
    if (Array.isArray(concernsTags)) {
      concernsTags.forEach((c) => {
        const base = String(c).toLowerCase().split("Â·")[0].trim();
        if (base && text.includes(base)) score += 1;
      });
    }

    return score;
  }

  function createProductCard(prod, diag) {
    const name = prod.name || prod.title || prod.displayName || "ì œí’ˆëª… ë¯¸ì§€ì •";
    const summary =
      prod.summary ||
      prod.description ||
      "ì¼ë°˜ì ì¸ ìŠ¤í‚¨ì¼€ì–´ ë£¨í‹´ì— í™œìš© ê°€ëŠ¥í•œ ì œí’ˆì…ë‹ˆë‹¤.";
    const tags = prod.tags || prod.concerns || [];
    const url =
      prod.url || prod.link || prod.coupangUrl || prod.coupang_link || "#";
    const img = prod.image || prod.thumb || "";

    const matchScore = computeMatchScore(prod, diag);
    let matchText = "ê¸°ë³¸ ì¶”ì²œ ì œí’ˆ";
    if (matchScore >= 4) matchText = "ì§„ë‹¨ ê²°ê³¼ì™€ ë§¤ìš° ì˜ ë§ëŠ” ì œí’ˆ";
    else if (matchScore >= 2) matchText = "ì§„ë‹¨ ê²°ê³¼ì™€ ì˜ ë§ëŠ” ì œí’ˆ";

    const wrapper = document.createElement("div");
    wrapper.className = "product-card";

    const thumbEl = document.createElement("div");
    thumbEl.className = "product-thumb";
    if (img) {
      const imgEl = document.createElement("img");
      imgEl.src = img;
      imgEl.alt = name;
      thumbEl.appendChild(imgEl);
    } else {
      thumbEl.textContent = "ğŸ§´";
    }

    const body = document.createElement("div");
    body.className = "product-body";

    const nameEl = document.createElement("div");
    nameEl.className = "product-name";
    nameEl.textContent = name;

    const summaryEl = document.createElement("div");
    summaryEl.className = "product-summary";
    summaryEl.textContent = summary;

    const tagsEl = document.createElement("div");
    tagsEl.className = "product-tags";
    if (Array.isArray(tags) && tags.length) {
      tagsEl.innerHTML = tags
        .map((t) => `<span class="tag-pill">${t}</span>`)
        .join("");
    }

    const footer = document.createElement("div");
    footer.className = "product-footer";

    const matchEl = document.createElement("div");
    matchEl.className = "match-text";
    matchEl.textContent = matchText;

    const btn = document.createElement("button");
    btn.className = "link-btn";
    btn.innerHTML = '<span>ğŸ›’</span><span>ì¿ íŒ¡ì—ì„œ ë³´ê¸°</span>';
    btn.onclick = () => {
      if (!url || url === "#") {
        alert("ì œí’ˆ ë§í¬ê°€ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
        return;
      }
      window.location.href = url; // WebView ì•ˆì—ì„œ ì¿ íŒ¡ í˜ì´ì§€ ì—´ê¸°
    };

    footer.appendChild(matchEl);
    footer.appendChild(btn);

    body.appendChild(nameEl);
    body.appendChild(summaryEl);
    body.appendChild(tagsEl);
    body.appendChild(footer);

    wrapper.appendChild(thumbEl);
    wrapper.appendChild(body);

    return wrapper;
  }

  async function loadProducts() {
    const loading = document.getElementById("loading");
    const listEl = document.getElementById("product-list");
    const diag = getLatestDiagnosis();

    renderHeaderBadges(diag);

    try {
      const res = await fetch(`${API_BASE}/api/products`);
      if (!res.ok) {
        throw new Error("ì œí’ˆ ëª©ë¡ API ì˜¤ë¥˜: " + res.status);
      }
      const products = await res.json();
      if (!Array.isArray(products) || !products.length) {
        loading.textContent = "ë“±ë¡ëœ ì¶”ì²œ ì œí’ˆì´ ì•„ì§ ì—†ìŠµë‹ˆë‹¤.";
        return;
      }

      // ì§„ë‹¨ ê²°ê³¼ì™€ì˜ ë§¤ì¹­ ì ìˆ˜ ê¸°ì¤€ìœ¼ë¡œ ì†ŒíŠ¸
      const scored = products
        .map((p) => ({ p, score: computeMatchScore(p, diag) }))
        .sort((a, b) => b.score - a.score);

      listEl.innerHTML = "";
      scored.forEach(({ p }, idx) => {
        const card = createProductCard(p, diag);
        listEl.appendChild(card);
      });

      loading.style.display = "none";
      listEl.style.display = "flex";
    } catch (e) {
      console.error(e);
      loading.textContent =
        "ì¶”ì²œ ì œí’ˆì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.";
    }
  }

  function goBack() {
    window.location.href = "result.html";
  }

  function goHome() {
    window.location.href = "index.html";
  }

  window.addEventListener("DOMContentLoaded", () => {
    loadProducts();
  });
</script>
</body>
</html>
