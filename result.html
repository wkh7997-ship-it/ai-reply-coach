<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AI 피부 코치 - 분석 결과</title>
  <style>
    :root {
      --primary: #9b8bff;
      --primary-strong: #5c6bff;
      --bg-deep: #050616;
      --bg-top: #11152b;
      --glass: rgba(10, 14, 32, 0.96);
      --text-main: #f9fafb;
      --text-sub: #cbd5f5;
      --border-soft: rgba(148, 163, 255, 0.35);
      --risk-low: #22c55e;
      --risk-mid: #eab308;
      --risk-high: #ef4444;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: Pretendard, -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
      min-height: 100vh;
      background:
        radial-gradient(circle at top, rgba(88,101,242,0.32) 0, transparent 55%),
        radial-gradient(circle at bottom, rgba(59,130,246,0.26) 0, transparent 62%),
        linear-gradient(160deg, var(--bg-top), var(--bg-deep));
      color: var(--text-main);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px 14px;
    }

    .shell { width: 100%; max-width: 440px; }

    .card {
      background: var(--glass);
      border-radius: 26px;
      padding: 18px 16px 14px;
      border: 1px solid var(--border-soft);
      box-shadow:
        0 22px 50px rgba(0,0,0,0.9),
        0 0 0 1px rgba(15,23,42,0.7);
      backdrop-filter: blur(18px);
      position: relative;
      overflow: hidden;
      max-height: calc(100vh - 32px);
      display: flex;
      flex-direction: column;
    }

    .card-inner-scroll {
      overflow-y: auto;
      padding-right: 2px;
      margin-right: -4px;
      flex: 1;
    }

    .top-accent {
      position: absolute;
      left: 14%; right: 14%; top: 10px;
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(148,163,255,0.9), transparent);
      opacity: 0.95;
    }

    .header-wrap {
      margin-top: 12px;
      margin-bottom: 10px;
      display: flex;
      align-items: flex-end;
      justify-content: space-between;
      gap: 10px;
    }

    .header-title {
      font-size: 1.4rem;
      font-weight: 750;
      line-height: 1.1;
    }

    .header-sub {
      font-size: 0.82rem;
      color: var(--text-sub);
      margin-top: 4px;
      line-height: 1.4;
    }

    .header-date {
      font-size: 0.72rem;
      color: rgba(203,213,255,0.9);
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,255,0.6);
      background: rgba(15,23,42,0.9);
      white-space: nowrap;
    }

    /* 로딩 스피너 */
    .spinner {
      width: 42px;
      height: 42px;
      border: 4px solid rgba(255,255,255,0.16);
      border-top-color: #a78bfa;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 18px auto 12px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-text {
      text-align: center;
      font-size: 0.93rem;
      color: var(--text-sub);
      margin-bottom: 6px;
      line-height: 1.5;
    }

    /* 스크롤 힌트 */
    .scroll-hint {
      display: none; /* 결과가 로딩된 뒤 JS에서 켬 */
      text-align: center;
      font-size: 0.78rem;
      color: rgba(203,213,255,0.85);
      margin-bottom: 6px;
    }

    .result-wrapper {
      margin-top: 4px;
      display: none; /* JS에서 표시 */
    }

    .score-section {
      background:
        radial-gradient(circle at top left, rgba(148,163,255,0.25), transparent 55%),
        rgba(12,18,42,0.98);
      border-radius: 22px;
      padding: 14px 14px 12px;
      border: 1px solid rgba(148,163,255,0.55);
      margin-bottom: 12px;
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .score-circle {
      width: 82px;
      height: 82px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 0%, #ffffff, #c7d2ff);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      box-shadow:
        0 12px 26px rgba(15,23,42,0.9),
        0 0 0 1px rgba(226,232,255,0.65);
      overflow: hidden;
    }

    .score-circle-inner {
      width: 80%;
      height: 80%;
      border-radius: inherit;
      display: flex;
      align-items: center;
      justify-content: center;
      background:
        radial-gradient(circle at top, rgba(79,70,229,0.16), transparent 60%);
    }

    .score-number-wrap {
      text-align: center;
      line-height: 1.1;
    }

    .score-value {
      font-size: 1.7rem;
      font-weight: 800;
      color: #111827;
    }

    .score-unit {
      font-size: 0.78rem;
      color: #6b7280;
      margin-top: 1px;
    }

    .score-text-block { flex: 1; }

    .score-label {
      font-size: 0.72rem;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: #a5b4ff;
      margin-bottom: 4px;
    }

    .score-main {
      font-size: 1rem;
      font-weight: 680;
      margin-bottom: 3px;
    }

    .score-desc {
      font-size: 0.83rem;
      color: var(--text-sub);
      line-height: 1.5;
    }

    .chip-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 7px;
    }

    .chip {
      font-size: 0.75rem;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,255,0.6);
      color: #e5e7eb;
      background: rgba(15,23,42,0.9);
    }

    .chip-risk-low {
      border-color: var(--risk-low);
      color: #bbf7d0;
      background: rgba(22,163,74,0.18);
    }

    .chip-risk-mid {
      border-color: var(--risk-mid);
      color: #fef9c3;
      background: rgba(202,138,4,0.18);
    }

    .chip-risk-high {
      border-color: var(--risk-high);
      color: #fee2e2;
      background: rgba(239,68,68,0.2);
    }

    .section {
      background: rgba(11,17,38,0.96);
      border-radius: 18px;
      padding: 11px 13px 9px;
      border: 1px solid rgba(148,163,255,0.3);
      margin-bottom: 10px;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }

    .section-title {
      font-size: 0.82rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: #9ca3ff;
    }

    .section-tag {
      font-size: 0.72rem;
      color: rgba(209,213,255,0.9);
    }

    .section-body {
      font-size: 0.88rem;
      color: var(--text-sub);
      line-height: 1.7;
      margin-top: 3px;
    }

    .issues-list {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
    }

    .issue-pill {
      font-size: 0.8rem;
      padding: 4px 9px;
      border-radius: 999px;
      background: rgba(30,64,175,0.85);
      border: 1px solid rgba(191,219,254,0.7);
      color: #e0f2fe;
    }

    .footer-note {
      font-size: 0.74rem;
      color: rgba(148,163,255,0.9);
      text-align: center;
      margin-top: 4px;
      margin-bottom: 2px;
    }

    .btn-wrap {
      margin-top: 8px;
      padding-top: 6px;
      border-top: 1px solid rgba(15,23,42,0.9);
    }

    .btn {
      width: 100%;
      padding: 11px 0;
      margin-top: 7px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, var(--primary-strong), var(--primary));
      color: #fff;
      font-weight: 650;
      cursor: pointer;
      font-size: 0.95rem;
      box-shadow: 0 10px 22px rgba(88,81,233,0.6);
    }

    .btn-secondary {
      background: transparent;
      border: 1px solid rgba(148,163,255,0.5);
      color: var(--text-main);
      box-shadow: none;
    }
  </style>
</head>

<body>
<div class="shell">
  <div class="card">
    <div class="top-accent"></div>

    <div class="header-wrap">
      <div>
        <div class="header-title">오늘의 피부 리포트</div>
        <div class="header-sub" id="header-sub">
          방금 업로드한 사진을 기반으로<br />
          AI가 피부 상태를 정리했어요.
        </div>
      </div>
      <div class="header-date" id="header-date">-</div>
    </div>

    <div id="spinner" class="spinner"></div>
    <div class="loading-text" id="status-text">
      결과를 불러오는 중입니다...
    </div>

    <!-- 스크롤 안내 문구 -->
    <div class="scroll-hint" id="scroll-hint">
      ⬇ 아래로 내려서 루틴과 상세 분석을 확인해 보세요
    </div>

    <div class="card-inner-scroll">
      <!-- 결과 -->
      <div id="result-wrapper" class="result-wrapper">
        <!-- 점수 & 요약 -->
        <div class="score-section">
          <div class="score-circle">
            <div class="score-circle-inner">
              <div class="score-number-wrap">
                <div id="score-value" class="score-value">-</div>
                <div class="score-unit">/ 100</div>
              </div>
            </div>
          </div>
          <div class="score-text-block">
            <div class="score-label">SKIN HEALTH SCORE</div>
            <div id="score-main" class="score-main">피부 점수</div>
            <div id="score-desc" class="score-desc">
              AI가 분석한 전반적인 피부 상태 요약입니다.
            </div>
            <div class="chip-row">
              <span id="chip-skin-type" class="chip">피부타입</span>
              <span id="chip-risk" class="chip">위험도</span>
            </div>
          </div>
        </div>

        <!-- 주요 고민 -->
        <div class="section">
          <div class="section-header">
            <div class="section-title">주요 고민 포인트</div>
            <div class="section-tag">Focus area</div>
          </div>
          <div class="section-body">
            <div id="issues-text">AI가 인식한 고민 포인트입니다.</div>
            <div id="issues-list" class="issues-list"></div>
          </div>
        </div>

        <!-- 한 줄 요약 -->
        <div class="section">
          <div class="section-header">
            <div class="section-title">AI 한 줄 총평</div>
            <div class="section-tag">Summary</div>
          </div>
          <div id="summary-text" class="section-body">
            -
          </div>
        </div>

        <!-- 관리 가이드 -->
        <div class="section">
          <div class="section-header">
            <div class="section-title">일상 관리 가이드</div>
            <div class="section-tag">Daily routine</div>
          </div>
          <div id="detail-text" class="section-body">
            -
          </div>
        </div>

        <div class="footer-note">
          * 이 리포트는 AI 분석을 기반으로 한 참고용 가이드입니다.
        </div>
      </div>
    </div>

    <div class="btn-wrap">
      <!-- 1: 추천 제품 보러가기 -->
      <button class="btn btn-secondary" onclick="goProducts()">
        최근 진단 기반 추천 제품 보기
      </button>

      <!-- 2: AI 피부 상담 챗봇 -->
      <button class="btn btn-secondary" onclick="goChat()">
        AI 피부 상담 챗봇으로 이동
      </button>

      <!-- 3: 첫 화면으로 돌아가기 (색 통일: secondary로 변경) -->
      <button class="btn btn-secondary" onclick="goHome()">
        첫 화면으로 돌아가기
      </button>

      <!-- 4: 다른 사진으로 다시 진단 -->
      <button class="btn btn-secondary" onclick="retry()">
        다른 사진으로 다시 진단
      </button>
    </div>
  </div>
</div>

<script>
  function mapRisk(riskLevel) {
    if (riskLevel === "low") {
      return { label: "위험도 낮음", className: "chip chip-risk-low" };
    }
    if (riskLevel === "high") {
      return { label: "위험도 높음", className: "chip chip-risk-high" };
    }
    return { label: "위험도 보통", className: "chip chip-risk-mid" };
  }

  function getScoreText(score) {
    let grade, desc;
    if (score >= 85) {
      grade = "A 등급";
      desc = "전반적으로 매우 건강한 피부 컨디션이에요. 현재 루틴을 유지하면서 보습과 자외선 차단만 잘 챙겨도 좋아요.";
    } else if (score >= 70) {
      grade = "B 등급";
      desc = "대체로 괜찮은 피부지만, 특정 부위(모공·피지·잔주름 등)에 조금씩 부담이 쌓이고 있어요.";
    } else if (score >= 50) {
      grade = "C 등급";
      desc = "피부 진정·보습에 조금 더 신경 써주면 확실히 좋아질 여지가 보여요.";
    } else {
      grade = "D 등급";
      desc = "자극적인 세안·건조함·수면 부족 등이 피부에 많이 누적된 상태일 수 있어요. 지금부터 루틴을 정리해보면 좋아요.";
    }
    return { grade, desc };
  }

  function saveHistory(result) {
    try {
      const today = new Date().toISOString().slice(0, 10);
      const raw = localStorage.getItem("diagnosisHistory");
      const history = raw ? JSON.parse(raw) : [];
      const entry = {
        date: today,
        score: result.score,
        skinType: result.skinType,
        riskLevel: result.riskLevel,
        summary: result.summary
      };
      const next = [entry, ...history].slice(0, 30);
      localStorage.setItem("diagnosisHistory", JSON.stringify(next));
    } catch (e) {
      console.warn("diagnosisHistory 저장 실패:", e);
    }
  }

  function setTodayLabel() {
    const el = document.getElementById("header-date");
    const now = new Date();
    const y = now.getFullYear();
    const m = String(now.getMonth() + 1).padStart(2, "0");
    const d = String(now.getDate()).padStart(2, "0");
    el.innerText = `${y}.${m}.${d}`;
  }

  function renderResult() {
    const spinner = document.getElementById("spinner");
    const statusText = document.getElementById("status-text");
    const wrapper = document.getElementById("result-wrapper");
    const scrollHint = document.getElementById("scroll-hint");

    let raw = sessionStorage.getItem("aiSkinResult");

    if (!raw) {
      spinner.style.display = "none";
      statusText.innerText =
        "분석 결과를 찾지 못했어요.\n처음 화면에서 다시 진단을 진행해 주세요.";
      scrollHint.style.display = "none";
      return;
    }

    let result;
    try {
      result = JSON.parse(raw);
    } catch (e) {
      console.error("aiSkinResult JSON 파싱 오류:", e);
      spinner.style.display = "none";
      statusText.innerText =
        "결과를 불러오는 중 오류가 발생했습니다.\n다시 진단을 진행해 주세요.";
      scrollHint.style.display = "none";
      return;
    }

    const score =
      typeof result.score === "number"
        ? Math.min(Math.max(result.score, 0), 100)
        : 70;
    const skinType = result.skinType || "복합성";
    const riskLevel = result.riskLevel || "mid";
    const issues = Array.isArray(result.issues) ? result.issues : [];
    const summary = result.summary || "전반적으로 무난한 피부 상태입니다.";
    const detailAdvice =
      result.detailAdvice ||
      "세안 후 기본 보습과 자외선 차단만 꾸준히 유지해 줘도 현재보다 피부 컨디션이 한층 더 안정될 거예요.";

    saveHistory({ score, skinType, riskLevel, summary });

    const scoreInfo = getScoreText(score);
    const riskInfo = mapRisk(riskLevel);

    document.getElementById("score-value").innerText = score;
    document.getElementById("score-main").innerText = `${scoreInfo.grade} · ${skinType} 피부`;
    document.getElementById("score-desc").innerText = scoreInfo.desc;

    const chipSkin = document.getElementById("chip-skin-type");
    chipSkin.innerText = `피부 타입: ${skinType}`;
    chipSkin.className = "chip";

    const chipRisk = document.getElementById("chip-risk");
    chipRisk.innerText = riskInfo.label;
    chipRisk.className = riskInfo.className;

    const issuesTextEl = document.getElementById("issues-text");
    const issuesListEl = document.getElementById("issues-list");
    issuesListEl.innerHTML = "";

    if (!issues.length) {
      issuesTextEl.innerText = "뚜렷하게 강조되는 고민 포인트는 크지 않아 보여요.";
    } else {
      issuesTextEl.innerText = "아래 항목에서 특히 신경 써주면 좋아요:";
      issues.forEach((iss) => {
        const span = document.createElement("span");
        span.className = "issue-pill";
        span.innerText = iss;
        issuesListEl.appendChild(span);
      });
    }

    document.getElementById("summary-text").innerText = summary;
    document.getElementById("detail-text").innerText = detailAdvice;

    spinner.style.display = "none";
    statusText.style.display = "none";
    wrapper.style.display = "block";
    scrollHint.style.display = "block";
  }

  function goHome() {
    sessionStorage.removeItem("uploadedImage");
    sessionStorage.removeItem("aiSkinResult");
    window.location.href = "index.html";
  }

  function retry() {
    sessionStorage.removeItem("uploadedImage");
    sessionStorage.removeItem("aiSkinResult");
    window.location.href = "index.html";
  }

  function goProducts() {
    const raw = localStorage.getItem("diagnosisHistory");
    if (!raw) {
      alert("먼저 AI 진단을 진행해주세요!");
      return;
    }
    window.location.href = "products.html";
  }

  function goChat() {
    const raw = localStorage.getItem("diagnosisHistory");
    if (!raw) {
      alert("먼저 AI 진단을 진행해주세요!");
      return;
    }
    window.location.href = "chat.html";
  }

  window.addEventListener("DOMContentLoaded", () => {
    setTodayLabel();
    renderResult();
  });
</script>

</body>
</html>
