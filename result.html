<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AI í”¼ë¶€ ì½”ì¹˜ - ë¶„ì„ ê²°ê³¼</title>
    <style>
        :root {
          --primary: #9b8bff;
          --primary-strong: #5c6bff;
          --bg-deep: #050616;
          --bg-top: #11152b;
          --glass: rgba(10, 14, 32, 0.96);
          --text-main: #f9fafb;
          --text-sub: #cbd5f5;
          --border-soft: rgba(148, 163, 255, 0.35);
          --risk-low: #22c55e;
          --risk-mid: #eab308;
          --risk-high: #ef4444;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
          font-family: Pretendard, -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
          min-height: 100vh;
          background:
            radial-gradient(circle at top, rgba(88,101,242,0.32) 0, transparent 55%),
            radial-gradient(circle at bottom, rgba(59,130,246,0.26) 0, transparent 62%),
            linear-gradient(160deg, var(--bg-top), var(--bg-deep));
          color: var(--text-main);
          display: flex;
          align-items: center;
          justify-content: center;
          padding: 16px 14px;
        }

        .shell { width: 100%; max-width: 440px; }

        .card {
          background: var(--glass);
          border-radius: 26px;
          padding: 14px 16px 14px;
          border: 1px solid var(--border-soft);
          box-shadow:
            0 22px 50px rgba(0,0,0,0.9),
            0 0 0 1px rgba(15,23,42,0.7);
          backdrop-filter: blur(18px);
          position: relative;
          overflow: hidden;
          max-height: calc(100vh - 32px);
          display: flex;
          flex-direction: column;
        }

        .card-inner-scroll {
          overflow-y: auto;
          padding-right: 2px;
          margin-right: -4px;
          flex: 1;
        }

        .top-accent {
          position: absolute;
          left: 14%; right: 14%; top: 10px;
          height: 1px;
          background: linear-gradient(90deg, transparent, rgba(148,163,255,0.9), transparent);
          opacity: 0.95;
        }

        /* â­ ê³µí†µ ìƒë‹¨ ë°” */
        .top-bar {
          position: relative;
          z-index: 2;
          display: flex;
          align-items: center;
          justify-content: space-between;
          margin-top: 6px;
          margin-bottom: 6px;
        }

        .top-bar-left,
        .top-bar-center,
        .top-bar-right {
          display: flex;
          align-items: center;
        }

        .top-bar-left { min-width: 70px; justify-content: flex-start; }
        .top-bar-center { flex: 1; justify-content: center; font-size: 0.9rem; font-weight: 600; }
        .top-bar-right { min-width: 70px; justify-content: flex-end; }

        .back-btn {
          display: inline-flex;
          align-items: center;
          justify-content: center;
          gap: 4px;
          background: transparent;
          border: none;
          font-size: 0.82rem;
          color: var(--text-sub);
          cursor: pointer;
          padding: 4px 6px;
        }

        .step-pill {
          padding: 3px 9px;
          border-radius: 999px;
          border: 1px solid rgba(148,163,255,0.7);
          font-size: 0.72rem;
          color: rgba(203,213,255,0.95);
          background: rgba(10,16,40,0.95);
          white-space: nowrap;
        }

        .header-wrap {
          margin-top: 4px;
          margin-bottom: 10px;
          display: flex;
          align-items: flex-end;
          justify-content: space-between;
          gap: 10px;
        }

        .header-title {
          font-size: 1.4rem;
          font-weight: 750;
          line-height: 1.1;
        }

        .header-sub {
          font-size: 0.82rem;
          color: var(--text-sub);
          margin-top: 4px;
          line-height: 1.4;
        }

        .header-date {
          font-size: 0.72rem;
          color: rgba(203,213,255,0.9);
          padding: 4px 8px;
          border-radius: 999px;
          border: 1px solid rgba(148,163,255,0.6);
          background: rgba(15,23,42,0.9);
          white-space: nowrap;
        }

        /* ë¡œë”© ìŠ¤í”¼ë„ˆ */
        .spinner {
          width: 42px;
          height: 42px;
          border: 4px solid rgba(255,255,255,0.16);
          border-top-color: #a78bfa;
          border-radius: 50%;
          animation: spin 0.8s linear infinite;
          margin: 18px auto 12px;
        }

        @keyframes spin {
          to { transform: rotate(360deg); }
        }

        .loading-text {
          text-align: center;
          font-size: 0.93rem;
          color: var(--text-sub);
          margin-bottom: 6px;
          line-height: 1.5;
        }

        .scroll-hint {
          display: none;
          text-align: center;
          font-size: 0.78rem;
          color: rgba(203,213,255,0.85);
          margin-bottom: 6px;
        }

        .result-wrapper {
          margin-top: 4px;
          display: none;
        }

        .score-section {
          background:
            radial-gradient(circle at top left, rgba(148,163,255,0.25), transparent 55%),
            rgba(12,18,42,0.98);
          border-radius: 22px;
          padding: 14px 14px 12px;
          border: 1px solid rgba(148,163,255,0.55);
          margin-bottom: 12px;
          display: flex;
          gap: 12px;
          align-items: center;
        }

        .score-circle {
          width: 82px;
          height: 82px;
          border-radius: 999px;
          background: radial-gradient(circle at 30% 0%, #ffffff, #c7d2ff);
          display: flex;
          align-items: center;
          justify-content: center;
          position: relative;
          box-shadow:
            0 12px 26px rgba(15,23,42,0.9),
            0 0 0 1px rgba(226,232,255,0.65);
          overflow: hidden;
        }

        .score-circle-inner {
          width: 80%;
          height: 80%;
          border-radius: inherit;
          display: flex;
          align-items: center;
          justify-content: center;
          background:
            radial-gradient(circle at top, rgba(79,70,229,0.16), transparent 60%);
        }

        .score-number-wrap {
          text-align: center;
          line-height: 1.1;
        }

        .score-value {
          font-size: 1.7rem;
          font-weight: 800;
          color: #111827;
        }

        .score-unit {
          font-size: 0.78rem;
          color: #6b7280;
          margin-top: 1px;
        }

        .score-text-block { flex: 1; }

        .score-label {
          font-size: 0.72rem;
          letter-spacing: 0.16em;
          text-transform: uppercase;
          color: #a5b4ff;
          margin-bottom: 4px;
        }

        .score-main {
          font-size: 1rem;
          font-weight: 680;
          margin-bottom: 3px;
        }

        .score-desc {
          font-size: 0.83rem;
          color: var(--text-sub);
          line-height: 1.5;
        }

        .chip-row {
          display: flex;
          flex-wrap: wrap;
          gap: 6px;
          margin-top: 7px;
        }

        .chip {
          font-size: 0.75rem;
          padding: 3px 8px;
          border-radius: 999px;
          border: 1px solid rgba(148,163,255,0.6);
          color: #e5e7eb;
          background: rgba(15,23,42,0.9);
        }

        .chip-risk-low {
          border-color: var(--risk-low);
          color: #bbf7d0;
          background: rgba(22,163,74,0.18);
        }

        .chip-risk-mid {
          border-color: var(--risk-mid);
          color: #fef9c3;
          background: rgba(202,138,4,0.18);
        }

        .chip-risk-high {
          border-color: var(--risk-high);
          color: #fee2e2;
          background: rgba(239,68,68,0.2);
        }

        .section {
          background: rgba(11,17,38,0.96);
          border-radius: 18px;
          padding: 11px 13px 9px;
          border: 1px solid rgba(148,163,255,0.3);
          margin-bottom: 10px;
        }

        .section-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 4px;
        }

        .section-title {
          font-size: 0.82rem;
          letter-spacing: 0.12em;
          text-transform: uppercase;
          color: #9ca3ff;
        }

        .section-tag {
          font-size: 0.72rem;
          color: rgba(209,213,255,0.9);
        }

        .section-body {
          font-size: 0.88rem;
          color: var(--text-sub);
          line-height: 1.7;
          margin-top: 3px;
        }

        .footer-note {
          font-size: 0.74rem;
          color: rgba(148,163,255,0.9);
          text-align: center;
          margin-top: 4px;
          margin-bottom: 2px;
        }

        .btn-wrap {
          margin-top: 8px;
          padding-top: 6px;
          border-top: 1px solid rgba(15,23,42,0.9);
        }

        .action-btn {
          width: 100%;
          padding: 13px 14px;
          margin-top: 9px;
          border-radius: 18px;
          border: 1px solid rgba(148,163,255,0.45);
          background:
            radial-gradient(circle at top left, rgba(148,163,255,0.18), transparent 60%),
            rgba(12,16,40,0.95);
          color: #e5e7ff;
          font-size: 0.95rem;
          font-weight: 620;
          display: flex;
          align-items: center;
          justify-content: flex-start;
          gap: 12px;
          cursor: pointer;
          box-shadow:
            0 6px 18px rgba(0,0,0,0.45),
            0 0 0 1px rgba(15,23,42,0.8);
          transition: all 0.18s ease-out;
        }

        .action-btn:hover {
          background:
            radial-gradient(circle at top left, rgba(191,219,254,0.22), transparent 60%),
            rgba(16,22,54,0.98);
          transform: translateY(-2px);
          box-shadow:
            0 10px 26px rgba(0,0,0,0.55),
            0 0 0 1px rgba(129,140,248,0.9);
        }

        .action-icon {
          font-size: 1.25rem;
          opacity: 0.92;
        }

        .action-primary {
          background: linear-gradient(135deg, #8f7bff 0%, #6b5cff 100%);
          border-color: rgba(255,255,255,0.15);
          color: #f5f3ff;
          box-shadow:
            0 6px 18px rgba(142,116,255,0.45),
            0 0 0 1px rgba(120,94,255,0.6);
        }

        .action-primary:hover {
          background: linear-gradient(135deg, #a597ff 0%, #7c6cff 100%);
          transform: translateY(-2px);
          box-shadow:
            0 10px 26px rgba(140,120,255,0.55),
            0 0 0 1px rgba(150,130,255,0.9);
        }

        .issues-list {
          display: flex;
          flex-wrap: wrap;
          gap: 6px;
          margin-top: 6px;
        }

        .issue-pill {
          font-size: 0.8rem;
          padding: 4px 9px;
          border-radius: 999px;
          background: rgba(30,64,175,0.85);
          border: 1px solid rgba(191,219,254,0.7);
          color: #e0f2fe;
        }
    </style>
</head>

<body>
<div class="shell">
    <div class="card">
        <div class="top-accent"></div>

        <!-- â­ ê³µí†µ ìƒë‹¨ í—¤ë” -->
        <div class="top-bar">
            <div class="top-bar-left">
                <button class="back-btn" onclick="goBack()">
                    â† ì´ì „ ë‹¨ê³„
                </button>
            </div>
            <div class="top-bar-center">
                ë¶„ì„ ê²°ê³¼ ë³´ê¸°
            </div>
            <div class="top-bar-right">
                <div class="step-pill">STEP 4 / 4</div>
            </div>
        </div>

        <!-- ì œëª© + ë‚ ì§œ -->
        <div class="header-wrap">
            <div>
                <div class="header-title">ì˜¤ëŠ˜ì˜ í”¼ë¶€ ë¦¬í¬íŠ¸</div>
                <div class="header-sub" id="header-sub">
                    ë°©ê¸ˆ ì—…ë¡œë“œí•œ ì‚¬ì§„ì„ ê¸°ë°˜ìœ¼ë¡œ<br />
                    AIê°€ í”¼ë¶€ ìƒíƒœë¥¼ ì •ë¦¬í–ˆì–´ìš”.
                </div>
            </div>
            <div class="header-date" id="header-date">-</div>
        </div>

        <div id="spinner" class="spinner"></div>
        <div class="loading-text" id="status-text">
            ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...
        </div>

        <div class="scroll-hint" id="scroll-hint">
            â¬‡ ì•„ë˜ë¡œ ë‚´ë ¤ì„œ ë£¨í‹´ê³¼ ìƒì„¸ ë¶„ì„ì„ í™•ì¸í•´ ë³´ì„¸ìš”
        </div>

        <div class="card-inner-scroll">
            <div id="result-wrapper" class="result-wrapper">
                <!-- ì ìˆ˜ & ìš”ì•½ -->
                <div class="score-section">
                    <div class="score-circle">
                        <div class="score-circle-inner">
                            <div class="score-number-wrap">
                                <div id="score-value" class="score-value">-</div>
                                <div class="score-unit">/ 100</div>
                            </div>
                        </div>
                    </div>
                    <div class="score-text-block">
                        <div class="score-label">SKIN HEALTH SCORE</div>
                        <div id="score-main" class="score-main">í”¼ë¶€ ì ìˆ˜</div>
                        <div id="score-desc" class="score-desc">
                            AIê°€ ë¶„ì„í•œ ì „ë°˜ì ì¸ í”¼ë¶€ ìƒíƒœ ìš”ì•½ì…ë‹ˆë‹¤.
                        </div>
                        <div class="chip-row">
                            <span id="chip-skin-type" class="chip">í”¼ë¶€íƒ€ì…</span>
                            <span id="chip-risk" class="chip">ìœ„í—˜ë„</span>
                        </div>
                    </div>
                </div>

                <!-- ë‚´ê°€ ì„ íƒí•œ ê³ ë¯¼ -->
                <div class="section">
                    <div class="section-header">
                        <div class="section-title">ë‚´ê°€ ì„ íƒí•œ í”¼ë¶€ ê³ ë¯¼</div>
                        <div class="section-tag">Your focus</div>
                    </div>
                    <div class="section-body">
                        <div id="user-concerns-empty">
                            ì´ì „ ë‹¨ê³„ì—ì„œ ì„ íƒí•œ ê³ ë¯¼ì„ ê¸°ë°˜ìœ¼ë¡œ ë¦¬í¬íŠ¸ë¥¼ ë§Œë“¤ì—ˆì–´ìš”.
                        </div>
                        <div id="user-concerns" class="chip-row"></div>
                    </div>
                </div>

                <!-- ì£¼ìš” ê³ ë¯¼ í¬ì¸íŠ¸ (AI ê´€ì ë§Œ) -->
                <div class="section">
                    <div class="section-header">
                        <div class="section-title">ì£¼ìš” ê³ ë¯¼ í¬ì¸íŠ¸</div>
                        <div class="section-tag">Focus area</div>
                    </div>
                    <div id="ai-focus-text" class="section-body">
                        AIê°€ ì¸ì‹í•œ ì£¼ìš” ê³ ë¯¼ í¬ì¸íŠ¸ë¥¼ ì •ë¦¬í•˜ê³  ìˆìŠµë‹ˆë‹¤.
                    </div>
                </div>

                <!-- í•œ ì¤„ ì´í‰ -->
                <div class="section">
                    <div class="section-header">
                        <div class="section-title">AI í•œ ì¤„ ì´í‰</div>
                        <div class="section-tag">Summary</div>
                    </div>
                    <div id="summary-text" class="section-body">
                        -
                    </div>
                </div>

                <!-- ê´€ë¦¬ ê°€ì´ë“œ -->
                <div class="section">
                    <div class="section-header">
                        <div class="section-title">ì¼ìƒ ê´€ë¦¬ ê°€ì´ë“œ</div>
                        <div class="section-tag">Daily routine</div>
                    </div>
                    <div id="detail-text" class="section-body">
                        -
                    </div>
                </div>

                <div class="footer-note">
                    * ì´ ë¦¬í¬íŠ¸ëŠ” AI ë¶„ì„ì„ ê¸°ë°˜ìœ¼ë¡œ í•œ ì°¸ê³ ìš© ê°€ì´ë“œì…ë‹ˆë‹¤.
                </div>
            </div>
        </div>

        <!-- í•˜ë‹¨ ë²„íŠ¼: ì œí’ˆ / í™ˆ -->
        <div class="btn-wrap">
            <button class="action-btn action-primary" onclick="goProducts()">
                <span class="action-icon">ğŸ§´</span>
                <span>ìµœê·¼ ì§„ë‹¨ ê¸°ë°˜ ì¶”ì²œ ì œí’ˆ ë³´ê¸°</span>
            </button>

            <button class="action-btn" onclick="goHome()">
                <span class="action-icon">ğŸ </span>
                <span>ì²« í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ê¸°</span>
            </button>
        </div>
    </div>
</div>

<script>
    function mapRisk(riskLevel) {
      if (riskLevel === "low") {
        return { label: "ìœ„í—˜ë„ ë‚®ìŒ", className: "chip chip-risk-low" };
      }
      if (riskLevel === "high") {
        return { label: "ìœ„í—˜ë„ ë†’ìŒ", className: "chip chip-risk-high" };
      }
      return { label: "ìœ„í—˜ë„ ë³´í†µ", className: "chip chip-risk-mid" };
    }

    function getScoreText(score) {
      let grade, desc;
      if (score >= 85) {
        grade = "A ë“±ê¸‰";
        desc =
          "ì „ë°˜ì ìœ¼ë¡œ ë§¤ìš° ê±´ê°•í•œ í”¼ë¶€ ì»¨ë””ì…˜ì´ì—ìš”. í˜„ì¬ ë£¨í‹´ì„ ìœ ì§€í•˜ë©´ì„œ ë³´ìŠµê³¼ ìì™¸ì„  ì°¨ë‹¨ë§Œ ê¾¸ì¤€íˆ ì±™ê²¨ì£¼ë©´ ì§€ê¸ˆ ìƒíƒœë¥¼ ì˜¤ë˜ ìœ ì§€í•˜ëŠ” ë° ë„ì›€ì´ ë©ë‹ˆë‹¤.";
      } else if (score >= 70) {
        grade = "B ë“±ê¸‰";
        desc =
          "ëŒ€ì²´ë¡œ ê´œì°®ì€ í”¼ë¶€ì§€ë§Œ, íŠ¹ì • ë¶€ìœ„(ëª¨ê³µÂ·í”¼ì§€Â·ì”ì£¼ë¦„Â·ë¶‰ì€ê¸° ë“±)ì— ë¶€ë‹´ì´ ì¡°ê¸ˆì”© ìŒ“ì´ê³  ìˆì–´ìš”. ë£¨í‹´ì„ í•œë‘ ë‹¨ê³„ë§Œ ì •ë¦¬í•´ì¤˜ë„ ëˆˆì— ë„ê²Œ ê°œì„ ë  ì—¬ì§€ê°€ ë³´ì—¬ìš”.";
      } else if (score >= 50) {
        grade = "C ë“±ê¸‰";
        desc =
          "í”¼ë¶€ ì§„ì •Â·ë³´ìŠµ, ìˆ˜ë¶„ ê´€ë¦¬ì— ì¡°ê¸ˆ ë” ì‹ ê²½ ì¨ì¤„ í•„ìš”ê°€ ìˆì–´ìš”. ì§€ë‚˜ì¹˜ê²Œ ë§ì€ ì œí’ˆì„ ì“°ê¸°ë³´ë‹¤, ê¸°ë³¸ ë£¨í‹´ì„ ë‹¨ìˆœí•˜ê²Œ ì •ë¦¬í•˜ê³  ìê·¹ì„ ì¤„ì´ëŠ” ê²Œ ìš°ì„ ì…ë‹ˆë‹¤.";
      } else {
        grade = "D ë“±ê¸‰";
        desc =
          "ìê·¹ì ì¸ ì„¸ì•ˆ, ê±´ì¡°í•œ í™˜ê²½, ìˆ˜ë©´ ë¶€ì¡± ë“±ì´ í”¼ë¶€ì— ë§ì´ ëˆ„ì ëœ ìƒíƒœì¼ ìˆ˜ ìˆì–´ìš”. ì§€ê¸ˆë¶€í„°ë¼ë„ ìˆœí•œ ë£¨í‹´ìœ¼ë¡œ ë¦¬ì…‹í•´ ì£¼ë©´, ì„œì„œíˆ í”¼ë¶€ ì¥ë²½ì´ íšŒë³µë˜ëŠ” íë¦„ì„ ê¸°ëŒ€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.";
      }
      return { grade, desc };
    }

    function saveHistory(result) {
      try {
        const today = new Date().toISOString().slice(0, 10);
        const raw = localStorage.getItem("diagnosisHistory");
        const history = raw ? JSON.parse(raw) : [];
        const entry = {
          date: today,
          score: result.score,
          skinType: result.skinType,
          riskLevel: result.riskLevel,
          summary: result.summary
        };
        const next = [entry, ...history].slice(0, 30);
        localStorage.setItem("diagnosisHistory", JSON.stringify(next));
      } catch (e) {
        console.warn("diagnosisHistory ì €ì¥ ì‹¤íŒ¨:", e);
      }
    }

    function setTodayLabel() {
      const el = document.getElementById("header-date");
      const now = new Date();
      const y = now.getFullYear();
      const m = String(now.getMonth() + 1).padStart(2, "0");
      const d = String(now.getDate()).padStart(2, "0");
      el.innerText = `${y}.${m}.${d}`;
    }

    function getUserConcernsFromSession() {
      const raw = sessionStorage.getItem("userConcerns");
      if (!raw) return [];
      try {
        const arr = JSON.parse(raw);
        return Array.isArray(arr) ? arr : [];
      } catch {
        return [];
      }
    }

    function renderUserConcerns() {
      const raw = sessionStorage.getItem("userConcerns");
      const wrap = document.getElementById("user-concerns");
      const emptyEl = document.getElementById("user-concerns-empty");

      if (!wrap || !emptyEl) return;

      if (!raw) {
        emptyEl.innerText =
          "ì´ì „ ë‹¨ê³„ì—ì„œ ê³ ë¯¼ì„ ì„ íƒí•˜ì§€ ì•Šì•˜ì–´ìš”. ë‹¤ìŒ ì§„ë‹¨ì—ì„œëŠ” ê¼­ ì„ íƒí•´ ì£¼ì„¸ìš”.";
        wrap.innerHTML = "";
        return;
      }

      try {
        const concerns = JSON.parse(raw);
        if (!Array.isArray(concerns) || concerns.length === 0) {
          emptyEl.innerText =
            "ì´ì „ ë‹¨ê³„ì—ì„œ ê³ ë¯¼ì„ ì„ íƒí•˜ì§€ ì•Šì•˜ì–´ìš”. ë‹¤ìŒ ì§„ë‹¨ì—ì„œëŠ” ê¼­ ì„ íƒí•´ ì£¼ì„¸ìš”.";
          wrap.innerHTML = "";
          return;
        }

        emptyEl.innerText = "ì•„ë˜ ê³ ë¯¼ì„ ì¤‘ì‹¬ìœ¼ë¡œ ë¦¬í¬íŠ¸ë¥¼ êµ¬ì„±í–ˆì–´ìš”:";
        wrap.innerHTML = concerns
          .map((c) => `<span class="chip">${c}</span>`)
          .join("");
      } catch (e) {
        console.error("userConcerns JSON íŒŒì‹± ì˜¤ë¥˜:", e);
        emptyEl.innerText = "ì„ íƒí•œ ê³ ë¯¼ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆì–´ìš”.";
        wrap.innerHTML = "";
      }
    }

    // ğŸ”¹ ì£¼ìš” ê³ ë¯¼ í¬ì¸íŠ¸ â€“ ì‚¬ìš©ìê°€ ì„ íƒí•œ ê³ ë¯¼ì€ ì¹©ì—ì„œë§Œ ë³´ì—¬ì£¼ê³ ,
    // ì—¬ê¸°ì„œëŠ” AIê°€ ì¡ì€ í•µì‹¬ í¬ì¸íŠ¸ë§Œ ë§í•˜ê¸°
    function buildFocusText(issues) {
      const mainIssues = (issues && issues.length ? issues : []).slice(0, 2);

      if (mainIssues.length) {
        return `ì´ë²ˆ ë¶„ì„ì—ì„œ íŠ¹íˆ ëˆˆì— ë„ëŠ” ê³ ë¯¼ í¬ì¸íŠ¸ëŠ” ${mainIssues.join(", ")} ì…ë‹ˆë‹¤. ê° ë¶€ìœ„ê°€ ê³¼ë„í•˜ê²Œ ì•…í™”ë˜ê¸°ë³´ë‹¤ëŠ”, ì§€ê¸ˆë¶€í„° ì–´ë–»ê²Œ ê´€ë¦¬í•˜ëŠëƒì— ë”°ë¼ ì•ìœ¼ë¡œì˜ í”¼ë¶€ íë¦„ì´ ë‹¬ë¼ì§ˆ ìˆ˜ ìˆëŠ” ìƒíƒœì˜ˆìš”.`;
      }

      return "ì´ë²ˆ ë¶„ì„ì—ì„œëŠ” íŠ¹ì • í•œ ë¶€ìœ„ê°€ ìœ ë‚œíˆ ë‚˜ì˜ë‹¤ê¸°ë³´ë‹¤ëŠ”, ì „ë°˜ì ì¸ ìˆ˜ë¶„Â·ì¥ë²½ ì¼€ì–´ì— ì¡°ê¸ˆ ë” ì‹ ê²½ ì¨ì£¼ë©´ ì¢‹ì€ ìƒíƒœë¡œ í™•ì¸ë˜ì—ˆì–´ìš”.";
    }

    // ğŸ”¹ í•œ ì¤„ ì´í‰ â€“ ì‚¬ìš©ìê°€ ê³ ë¥¸ ê³ ë¯¼ì„ ë°˜ë³µí•˜ì§€ ì•Šê³ , ì ìˆ˜ + ìœ„í—˜ë„ ì¤‘ì‹¬ìœ¼ë¡œ ì„¤ëª…
    function buildSummaryText(score, skinType, riskLevel, issues, aiSummary) {
      const issueText = issues && issues.length
        ? issues.join(", ")
        : "íŠ¹ì • ë¶€ìœ„ì˜ ì‹¬í•œ ì•…í™” ì—†ì´ ì „ë°˜ì ì¸ ì»¨ë””ì…˜ ì¤‘ì‹¬";

      let riskSentence = "";
      if (riskLevel === "low") {
        riskSentence =
          "í”¼ë¶€ ì¥ë²½ ì†ìƒì´ë‚˜ ì—¼ì¦ ë°œìƒ ìœ„í—˜ì€ ë¹„êµì  ë‚®ì€ í¸ìœ¼ë¡œ, ì§€ê¸ˆ ë£¨í‹´ì„ í° ë¬´ë¦¬ ì—†ì´ ìœ ì§€í•˜ë©´ì„œ ë³´ìŠµê³¼ ìì™¸ì„  ì°¨ë‹¨ë§Œ ê¾¸ì¤€íˆ ì±™ê²¨ì£¼ë©´ ì¢‹ì•„ìš”.";
      } else if (riskLevel === "high") {
        riskSentence =
          "ìê·¹Â·ë¯¼ê° ë°˜ì‘ì´ ìƒê¸¸ ê°€ëŠ¥ì„±ì´ ë†’ì€ íë¦„ì´ ë³´ì—¬, ê°ì§ˆ ì œê±°ì œë‚˜ ê³ ë†ë„ ê¸°ëŠ¥ì„± ì œí’ˆì€ ì²œì²œíˆ, í•˜ë‚˜ì”©ë§Œ ì‹œë„í•´ ë³´ëŠ” í¸ì´ ì•ˆì „í•©ë‹ˆë‹¤.";
      } else {
        riskSentence =
          "í”¼ë¶€ ìê·¹ ìœ„í—˜ì€ ë³´í†µ ìˆ˜ì¤€ì´ë©°, ê¸°ë³¸ì ì¸ ë³´ìŠµÂ·ìì™¸ì„  ì°¨ë‹¨ë§Œ ì•ˆì •ë˜ë©´ í”¼ë¶€ê²° íšŒë³µì„ ì¶©ë¶„íˆ ê¸°ëŒ€í•´ ë³¼ ìˆ˜ ìˆëŠ” ìƒíƒœì˜ˆìš”.";
      }

      const base =
        aiSummary && aiSummary.length > 10 ? aiSummary.trim() + "\n\n" : "";

      const core =
        `AI ë¶„ì„ ê¸°ì¤€, í˜„ì¬ ${skinType} íŠ¹ì„±ì„ ê°€ì§„ í”¼ë¶€ëŠ” ${score}ì  ì •ë„ë¡œ í‰ê°€ë˜ë©°, ` +
        `"${issueText}" ë¶€ìœ„ì˜ ê°œì„  ì—¬ì§€ê°€ íŠ¹íˆ ëˆˆì— ë„ê²Œ ê´€ì°°ë˜ì—ˆì–´ìš”. ` +
        `${riskSentence} ` +
        "ì´ í‰ê°€ëŠ” ì‚¬ì§„ê³¼ ì…ë ¥ ì •ë³´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•œ ì¶”ì •ì¹˜ì´ë¯€ë¡œ, ì‹¤ì œ ì§„ë£Œ ê²°ê³¼ì™€ëŠ” ì°¨ì´ê°€ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.";

      return base + core;
    }

    // ğŸ”¹ ê´€ë¦¬ ê°€ì´ë“œ â€“ ê³ ë¯¼ í…ìŠ¤íŠ¸ ë°˜ë³µ ì—†ì´, ë£¨í‹´ ìœ„ì£¼ë¡œ ê¸¸ê²Œ ì„¤ëª…
    function buildDetailAdvice(score, skinType, riskLevel, issues, aiDetail) {
      const issueHint = issues && issues.length
        ? `ì´ë²ˆ ë¶„ì„ì—ì„œ ëˆˆì— ë„ëŠ” ê³ ë¯¼ í¬ì¸íŠ¸ëŠ” ${issues.join(", ")} ì…ë‹ˆë‹¤.`
        : "ì´ë²ˆ ë¶„ì„ì—ì„œëŠ” íŠ¹ì • í•œ ë¶€ìœ„ë§Œ ì•…í™”ë˜ì—ˆë‹¤ê¸°ë³´ë‹¤, ì „ë°˜ì ì¸ ìˆ˜ë¶„Â·ì¥ë²½ ê· í˜•ì„ ë¨¼ì € ì¡ì•„ì£¼ëŠ” ê²ƒì´ ì¤‘ìš”í•˜ë‹¤ëŠ” ê²°ê³¼ê°€ ë‚˜ì™”ì–´ìš”.";

      let baseFromAI = aiDetail && aiDetail.length > 10 ? aiDetail.trim() : "";

      const part1 =
        `${issueHint} ìŠ¤í‚¨ì¼€ì–´ ì œí’ˆì„ ì—¬ëŸ¬ ê°œ ê²¹ì³ ì“°ê¸°ë³´ë‹¤ëŠ”, ì§€ê¸ˆì€ í”¼ë¶€ê°€ í¸ì•ˆí•¨ì„ ëŠë¼ëŠ” 'ê¸°ë³¸ ë£¨í‹´'ì„ ë¨¼ì € ë‹¨ë‹¨íˆ ì¡ì•„ì£¼ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.`;

      const part2 =
        "1) ì„¸ì•ˆì€ í•˜ë£¨ 2íšŒ ì´ë‚´ì˜ ë¶€ë“œëŸ¬ìš´ ì•½ì‚°ì„± í´ë Œì €ë¥¼ ì‚¬ìš©í•˜ê³ , ê°•í•˜ê²Œ ë¬¸ì§€ë¥´ê¸°ë³´ë‹¤ëŠ” ì†ì— ë‚¸ ê±°í’ˆì„ í”¼ë¶€ ìœ„ì— ì˜¬ë ¤ë‘ì—ˆë‹¤ê°€ ë¯¸ì§€ê·¼í•œ ë¬¼ë¡œ ì¶©ë¶„íˆ í—¹ê¶ˆ ì£¼ì„¸ìš”. " +
        "2) ì„¸ì•ˆ í›„ 3ë¶„ ì•ˆì— í† ë„ˆÂ·ì—ì„¼ìŠ¤Â·ë¡œì…˜ ì¤‘ í¸í•œ ì œí˜•ìœ¼ë¡œ ìˆ˜ë¶„ë§‰ì„ ë§Œë“¤ì–´ ì£¼ê³ , ê±´ì¡°í•¨ì´ ëŠê»´ì§€ëŠ” ë¶€ìœ„ì—ëŠ” í¬ë¦¼ì„ í•œ ë²ˆ ë” ë§ë°œë¼ ì¤ë‹ˆë‹¤. " +
        "3) ë‚®ì—ëŠ” SPF 50+ ìì™¸ì„  ì°¨ë‹¨ì œë¥¼ ì¶©ë¶„í•œ ì–‘ìœ¼ë¡œ ì‚¬ìš©í•´ ì£¼ë˜, í”¼ë¶€ê°€ ì˜ˆë¯¼í•˜ë‹¤ë©´ 'ë¯¼ê°ì„±ìš©' ë˜ëŠ” 'ë…¼ì½”ë©”ë„ì œë‹‰' í‘œì‹œê°€ ìˆëŠ” ì œí’ˆì„ ìš°ì„ ì ìœ¼ë¡œ ê³ ë ¤í•´ ì£¼ì„¸ìš”. ";

      const part3 =
        "ë°¤ì—ëŠ” ê°ì§ˆ ì œê±°ì œ(AHA/BHA)ë‚˜ ë ˆí‹°ë†€ ë“±ì˜ ê¸°ëŠ¥ì„± ì œí’ˆì„ í•œ ë²ˆì— ì—¬ëŸ¬ ê°€ì§€ ì“°ê¸°ë³´ë‹¤ëŠ”, í•œ ê°€ì§€ì”© ì²œì²œíˆ ë„ì…í•´ í”¼ë¶€ ë°˜ì‘ì„ í™•ì¸í•˜ëŠ” ê²ƒì´ ì•ˆì „í•©ë‹ˆë‹¤. " +
        "í”¼ë¶€ê°€ ìì£¼ ë¶‰ì–´ì§€ê±°ë‚˜ ë”°ê°€ìš´ í¸ì´ë¼ë©´, ê¸°ëŠ¥ì„± ì œí’ˆ ì‚¬ìš© ê°„ê²©ì„ 3~4ì¼ ì´ìƒ ë„‰ë„‰í•˜ê²Œ ë‘ê³ , ìê·¹ì´ ëŠê»´ì§€ëŠ” ë‚ ì—ëŠ” ê³¼ê°íˆ ì‰¬ì–´ê°€ëŠ” ê²ƒë„ ì¢‹ìŠµë‹ˆë‹¤. ";

      const part4 =
        "ì£¼ 1~2íšŒ ì •ë„ëŠ” 'ìµœì†Œ ë£¨í‹´'ìœ¼ë¡œë§Œ ê°€ë³ê²Œ ê´€ë¦¬í•˜ë©´ì„œ í”¼ë¶€ê°€ ìŠ¤ìŠ¤ë¡œ íšŒë³µí•  ì‹œê°„ì„ ì£¼ëŠ” ê²ƒë„ ë„ì›€ì´ ë©ë‹ˆë‹¤. " +
        "ê°€ë ¤ì›€Â·í™”ëˆê±°ë¦¼Â·ë¹ ë¥´ê²Œ ë²ˆì§€ëŠ” ë¶‰ì€ê¸°ì²˜ëŸ¼ ì¼ìƒìƒí™œì— ë¶ˆí¸ì„ ì¤„ ì •ë„ì˜ ì¦ìƒì´ ë‚˜íƒ€ë‚œë‹¤ë©´, ê°€ê¹Œìš´ í”¼ë¶€ê³¼ì—ì„œ ì‹¤ì œ í”¼ë¶€ ìƒíƒœë¥¼ í•œ ë²ˆ ì ê²€ë°›ì•„ ë³´ëŠ” ê²ƒì„ ê¶Œì¥ë“œë ¤ìš”.";

      const extra = `${part1}\n\n${part2}\n\n${part3}\n\n${part4}`;

      if (baseFromAI) {
        return `${baseFromAI}\n\n${extra}`;
      }
      return extra;
    }

    function renderResult() {
      const spinner = document.getElementById("spinner");
      const statusText = document.getElementById("status-text");
      const wrapper = document.getElementById("result-wrapper");
      const scrollHint = document.getElementById("scroll-hint");

      let raw = sessionStorage.getItem("aiSkinResult");

      if (!raw) {
        spinner.style.display = "none";
        statusText.innerText =
          "ë¶„ì„ ê²°ê³¼ë¥¼ ì°¾ì§€ ëª»í–ˆì–´ìš”.\nì²˜ìŒ í™”ë©´ì—ì„œ ë‹¤ì‹œ ì§„ë‹¨ì„ ì§„í–‰í•´ ì£¼ì„¸ìš”.";
        scrollHint.style.display = "none";
        return;
      }

      let result;
      try {
        result = JSON.parse(raw);
      } catch (e) {
        console.error("aiSkinResult JSON íŒŒì‹± ì˜¤ë¥˜:", e);
        spinner.style.display = "none";
        statusText.innerText =
          "ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\në‹¤ì‹œ ì§„ë‹¨ì„ ì§„í–‰í•´ ì£¼ì„¸ìš”.";
        scrollHint.style.display = "none";
        return;
      }

      const score =
        typeof result.score === "number"
          ? Math.min(Math.max(result.score, 0), 100)
          : 70;
      const skinType = result.skinType || "ë³µí•©ì„±";
      const riskLevel = result.riskLevel || "mid";
      const issues = Array.isArray(result.issues) ? result.issues : [];
      const summary =
        result.summary || "ì „ë°˜ì ìœ¼ë¡œ ë¬´ë‚œí•œ í”¼ë¶€ ìƒíƒœì…ë‹ˆë‹¤.";
      const detailAdvice =
        result.detailAdvice ||
        "ì„¸ì•ˆ í›„ ê¸°ë³¸ ë³´ìŠµê³¼ ìì™¸ì„  ì°¨ë‹¨ë§Œ ê¾¸ì¤€íˆ ìœ ì§€í•´ ì¤˜ë„ í˜„ì¬ë³´ë‹¤ í”¼ë¶€ ì»¨ë””ì…˜ì´ í•œì¸µ ë” ì•ˆì •ë  ê±°ì˜ˆìš”.";

      // ë¡œì»¬ íˆìŠ¤í† ë¦¬ ì €ì¥
      saveHistory({ score, skinType, riskLevel, summary });

      const scoreInfo = getScoreText(score);
      const riskInfo = mapRisk(riskLevel);

      document.getElementById("score-value").innerText = score;
      document.getElementById("score-main").innerText = `${scoreInfo.grade} Â· ${skinType} í”¼ë¶€`;
      document.getElementById("score-desc").innerText = scoreInfo.desc;

      const chipSkin = document.getElementById("chip-skin-type");
      chipSkin.innerText = `í”¼ë¶€ íƒ€ì…: ${skinType}`;
      chipSkin.className = "chip";

      const chipRisk = document.getElementById("chip-risk");
      chipRisk.innerText = riskInfo.label;
      chipRisk.className = riskInfo.className;

      // ğŸ”¹ ì‚¬ìš©ìê°€ ê³ ë¥¸ ê³ ë¯¼ ì •ë³´
      const userConcerns = getUserConcernsFromSession();

      // ğŸ”¹ ì£¼ìš” ê³ ë¯¼ í¬ì¸íŠ¸ â€“ ì´ì œëŠ” AI ê´€ì ë§Œ
      const focusEl = document.getElementById("ai-focus-text");
      focusEl.innerText = buildFocusText(issues);

      // ğŸ”¹ í•œ ì¤„ ì´í‰ & ê´€ë¦¬ ê°€ì´ë“œ
      const summaryText = buildSummaryText(
        score,
        skinType,
        riskLevel,
        issues,
        summary
      );
      const detailText = buildDetailAdvice(
        score,
        skinType,
        riskLevel,
        issues,
        detailAdvice
      );

      document.getElementById("summary-text").innerText = summaryText;
      document.getElementById("detail-text").innerText = detailText;

      // ğŸ”¹ ë‚´ê°€ ì„ íƒí•œ ê³ ë¯¼ ë±ƒì§€ ë Œë”ë§
      renderUserConcerns();

      spinner.style.display = "none";
      statusText.style.display = "none";
      wrapper.style.display = "block";
      scrollHint.style.display = "block";
    }

    function goHome() {
      sessionStorage.removeItem("uploadedImage");
      sessionStorage.removeItem("aiSkinResult");
      sessionStorage.removeItem("userConcerns");
      window.location.href = "index.html";
    }

    function goProducts() {
      const raw = localStorage.getItem("diagnosisHistory");
      if (!raw) {
        alert("ë¨¼ì € AI ì§„ë‹¨ì„ ì§„í–‰í•´ì£¼ì„¸ìš”!");
        return;
      }
      window.location.href = "products.html";
    }

    function goBack() {
      window.location.href = "options.html";
    }

    window.addEventListener("DOMContentLoaded", () => {
      setTodayLabel();
      renderResult();
    });
</script>
</body>
</html>
