<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AI 피부 코치 - 분석 결과</title>
  <style>
    :root {
      --primary: #9b8bff;
      --primary-strong: #5c6bff;
      --bg-deep: #050616;
      --bg-top: #11152b;
      --glass: rgba(10, 14, 32, 0.92);
      --text-main: #f9fafb;
      --text-sub: #cbd5f5;
      --border-soft: rgba(148, 163, 255, 0.35);
      --risk-low: #22c55e;
      --risk-mid: #eab308;
      --risk-high: #ef4444;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: Pretendard, -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
      min-height: 100vh;
      background:
        radial-gradient(circle at top, rgba(88,101,242,0.3) 0, transparent 55%),
        radial-gradient(circle at bottom, rgba(59,130,246,0.28) 0, transparent 60%),
        linear-gradient(160deg, var(--bg-top), var(--bg-deep));
      color: var(--text-main);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px 16px;
    }

    .shell { width: 100%; max-width: 440px; }

    .card {
      background: var(--glass);
      border-radius: 26px;
      padding: 22px 18px 18px;
      border: 1px solid var(--border-soft);
      box-shadow:
        0 20px 45px rgba(0,0,0,0.85),
        0 0 0 1px rgba(15,23,42,0.7);
      backdrop-filter: blur(16px);
      position: relative;
      overflow: hidden;
    }

    .top-accent {
      position: absolute;
      left: 14%; right: 14%; top: 10px;
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(148,163,255,0.85), transparent);
    }

    .header-title {
      text-align: center;
      font-size: 1.6rem;
      font-weight: 750;
      margin-top: 16px;
      margin-bottom: 6px;
    }

    .header-sub {
      text-align: center;
      font-size: 0.85rem;
      color: var(--text-sub);
      margin-bottom: 14px;
      line-height: 1.4;
    }

    /* 로딩 스피너 */
    .spinner {
      width: 46px;
      height: 46px;
      border: 4px solid rgba(255,255,255,0.2);
      border-top-color: #a78bfa;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 12px auto 14px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-text {
      text-align: center;
      font-size: 0.95rem;
      color: var(--text-sub);
      margin-bottom: 10px;
      line-height: 1.4;
    }

    .result-wrapper {
      margin-top: 8px;
      display: none; /* JS에서 표시 */
    }

    .score-section {
      background:
        radial-gradient(circle at top left, rgba(148,163,255,0.22), transparent 55%),
        rgba(15,23,42,0.98);
      border-radius: 20px;
      padding: 14px 14px 12px;
      border: 1px solid rgba(148,163,255,0.5);
      margin-bottom: 12px;
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .score-circle {
      width: 70px;
      height: 70px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 0%, #ffffff, #c7d2ff);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      box-shadow:
        0 12px 26px rgba(15,23,42,0.9),
        0 0 0 1px rgba(226,232,255,0.6);
      overflow: hidden;
    }

    .score-circle-inner {
      width: 80%;
      height: 80%;
      border-radius: inherit;
      display: flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at top, rgba(79,70,229,0.12), transparent 60%);
    }

    .score-value {
      font-size: 1.5rem;
      font-weight: 800;
      color: #111827;
    }

    .score-unit {
      font-size: 0.8rem;
      color: #6b7280;
      margin-top: -2px;
    }

    .score-text-block {
      flex: 1;
    }

    .score-label {
      font-size: 0.75rem;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: #9ca3ff;
      margin-bottom: 4px;
    }

    .score-main {
      font-size: 1rem;
      font-weight: 650;
      margin-bottom: 2px;
    }

    .score-desc {
      font-size: 0.85rem;
      color: var(--text-sub);
    }

    .chip-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
    }

    .chip {
      font-size: 0.75rem;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,255,0.6);
      color: #e5e7eb;
      background: rgba(15,23,42,0.9);
    }

    .chip-risk-low {
      border-color: var(--risk-low);
      color: #bbf7d0;
    }

    .chip-risk-mid {
      border-color: var(--risk-mid);
      color: #fef9c3;
    }

    .chip-risk-high {
      border-color: var(--risk-high);
      color: #fee2e2;
    }

    .section {
      background: rgba(15,23,42,0.92);
      border-radius: 18px;
      padding: 12px 14px 10px;
      border: 1px solid rgba(148,163,255,0.35);
      margin-bottom: 10px;
    }

    .section-title {
      font-size: 0.86rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: #9ca3ff;
      margin-bottom: 6px;
    }

    .section-body {
      font-size: 0.88rem;
      color: var(--text-sub);
      line-height: 1.6;
    }

    .issues-list {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 4px;
    }

    .issue-pill {
      font-size: 0.8rem;
      padding: 4px 9px;
      border-radius: 999px;
      background: rgba(30,64,175,0.85);
      border: 1px solid rgba(191,219,254,0.7);
      color: #e0f2fe;
    }

    .btn {
      width: 100%;
      padding: 12px 0;
      margin-top: 10px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, var(--primary-strong), var(--primary));
      color: #fff;
      font-weight: 650;
      cursor: pointer;
      font-size: 0.98rem;
      box-shadow: 0 10px 22px rgba(88,81,233,0.6);
    }

    .btn-secondary {
      background: transparent;
      border: 1px solid rgba(148,163,255,0.5);
      color: var(--text-main);
      box-shadow: none;
    }
  </style>
</head>

<body>
<div class="shell">
  <div class="card">
    <div class="top-accent"></div>

    <div class="header-title">AI 피부 분석 결과</div>
    <div class="header-sub" id="header-sub">
      방금 업로드한 사진을 기준으로<br />
      피부 상태를 정리해 드렸어요.
    </div>

    <!-- 로딩 -->
    <div id="spinner" class="spinner"></div>
    <div class="loading-text" id="status-text">
      결과를 불러오는 중입니다...
    </div>

    <!-- 결과 -->
    <div id="result-wrapper" class="result-wrapper">
      <!-- 점수 & 요약 -->
      <div class="score-section">
        <div class="score-circle">
          <div class="score-circle-inner">
            <div style="text-align:center;">
              <div id="score-value" class="score-value">-</div>
              <div class="score-unit">/ 100</div>
            </div>
          </div>
        </div>
        <div class="score-text-block">
          <div class="score-label">SKIN HEALTH SCORE</div>
          <div id="score-main" class="score-main">피부 점수</div>
          <div id="score-desc" class="score-desc">
            AI가 분석한 전반적인 피부 상태 요약입니다.
          </div>
          <div class="chip-row">
            <span id="chip-skin-type" class="chip">피부타입</span>
            <span id="chip-risk" class="chip">위험도</span>
          </div>
        </div>
      </div>

      <!-- 주요 고민 -->
      <div class="section">
        <div class="section-title">주요 고민 포인트</div>
        <div class="section-body">
          <div id="issues-text">AI가 인식한 고민 포인트입니다.</div>
          <div id="issues-list" class="issues-list"></div>
        </div>
      </div>

      <!-- 한 줄 요약 -->
      <div class="section">
        <div class="section-title">AI 한 줄 총평</div>
        <div id="summary-text" class="section-body">
          -
        </div>
      </div>

      <!-- 관리 가이드 -->
      <div class="section">
        <div class="section-title">일상 관리 가이드</div>
        <div id="detail-text" class="section-body">
          -
        </div>
      </div>
    </div>

    <button class="btn" onclick="goHome()">첫 화면으로 돌아가기</button>
    <button class="btn btn-secondary" onclick="retry()">다른 사진으로 다시 진단</button>
  </div>
</div>

<script>
  function mapRisk(riskLevel) {
    if (riskLevel === "low") {
      return { label: "위험도 낮음", className: "chip chip-risk-low" };
    }
    if (riskLevel === "high") {
      return { label: "위험도 높음", className: "chip chip-risk-high" };
    }
    return { label: "위험도 보통", className: "chip chip-risk-mid" };
  }

  function getScoreText(score) {
    let grade, desc;
    if (score >= 85) {
      grade = "A 등급";
      desc = "전반적으로 매우 건강한 피부 컨디션이에요. 현재 루틴을 유지하면서 보습과 자외선 차단만 잘 챙겨도 좋아요.";
    } else if (score >= 70) {
      grade = "B 등급";
      desc = "대체로 괜찮은 피부지만, 특정 부위(모공·피지·잔주름 등)에 조금씩 부담이 쌓이고 있어요.";
    } else if (score >= 50) {
      grade = "C 등급";
      desc = "피부 진정·보습에 조금 더 신경 써주면 확실히 좋아질 여지가 보여요.";
    } else {
      grade = "D 등급";
      desc = "자극적인 세안·건조함·수면 부족 등이 피부에 많이 누적된 상태일 수 있어요. 지금부터 루틴을 정리해보면 좋아요.";
    }
    return { grade, desc };
  }

  function saveHistory(result) {
    try {
      const today = new Date().toISOString().slice(0, 10);
      const raw = localStorage.getItem("diagnosisHistory");
      const history = raw ? JSON.parse(raw) : [];
      const entry = {
        date: today,
        score: result.score,
        skinType: result.skinType,
        riskLevel: result.riskLevel,
        summary: result.summary
      };
      const next = [entry, ...history].slice(0, 30); // 최근 30개만 유지
      localStorage.setItem("diagnosisHistory", JSON.stringify(next));
    } catch (e) {
      console.warn("diagnosisHistory 저장 실패:", e);
    }
  }

  function renderResult() {
    const spinner = document.getElementById("spinner");
    const statusText = document.getElementById("status-text");
    const wrapper = document.getElementById("result-wrapper");

    let raw = sessionStorage.getItem("aiSkinResult");

    if (!raw) {
      // 구버전 경로로 바로 result.html 들어온 경우 대비
      spinner.style.display = "none";
      statusText.innerText =
        "분석 결과를 찾지 못했어요.\n처음 화면에서 다시 진단을 진행해 주세요.";
      return;
    }

    let result;
    try {
      result = JSON.parse(raw);
    } catch (e) {
      console.error("aiSkinResult JSON 파싱 오류:", e);
      spinner.style.display = "none";
      statusText.innerText =
        "결과를 불러오는 중 오류가 발생했습니다.\n다시 진단을 진행해 주세요.";
      return;
    }

    // 기본값 보정
    const score =
      typeof result.score === "number"
        ? Math.min(Math.max(result.score, 0), 100)
        : 70;
    const skinType = result.skinType || "복합성";
    const riskLevel = result.riskLevel || "mid";
    const issues = Array.isArray(result.issues) ? result.issues : [];
    const summary = result.summary || "전반적으로 무난한 피부 상태입니다.";
    const detailAdvice =
      result.detailAdvice ||
      "세안 후 기본 보습과 자외선 차단만 꾸준히 유지해 줘도 현재보다 피부 컨디션이 한층 더 안정될 거예요.";

    // 기록 저장 (index.html의 'MY 피부 기록'에서 사용)
    saveHistory({ score, skinType, riskLevel, summary });

    // 점수 관련 텍스트
    const scoreInfo = getScoreText(score);
    const riskInfo = mapRisk(riskLevel);

    // DOM 반영
    document.getElementById("score-value").innerText = score;
    document.getElementById("score-main").innerText = `${scoreInfo.grade} · ${skinType} 피부`;
    document.getElementById("score-desc").innerText = scoreInfo.desc;

    const chipSkin = document.getElementById("chip-skin-type");
    chipSkin.innerText = `피부 타입: ${skinType}`;
    chipSkin.className = "chip";

    const chipRisk = document.getElementById("chip-risk");
    chipRisk.innerText = riskInfo.label;
    chipRisk.className = riskInfo.className;

    // 이슈
    const issuesTextEl = document.getElementById("issues-text");
    const issuesListEl = document.getElementById("issues-list");
    issuesListEl.innerHTML = "";

    if (!issues.length) {
      issuesTextEl.innerText = "뚜렷하게 강조되는 고민 포인트는 크지 않아 보여요.";
    } else {
      issuesTextEl.innerText = "아래 항목에서 특히 신경 써주면 좋아요:";
      issues.forEach((iss) => {
        const span = document.createElement("span");
        span.className = "issue-pill";
        span.innerText = iss;
        issuesListEl.appendChild(span);
      });
    }

    // 요약 & 상세
    document.getElementById("summary-text").innerText = summary;
    document.getElementById("detail-text").innerText = detailAdvice;

    // 로딩 숨기고 결과 보여주기
    spinner.style.display = "none";
    statusText.style.display = "none";
    wrapper.style.display = "block";
  }

  function goHome() {
    // 결과는 history에 저장돼 있으니 uploadedImage만 제거해도 됨
    sessionStorage.removeItem("uploadedImage");
    sessionStorage.removeItem("aiSkinResult");
    window.location.href = "index.html";
  }

  function retry() {
    sessionStorage.removeItem("uploadedImage");
    sessionStorage.removeItem("aiSkinResult");
    window.location.href = "index.html";
  }

  // 페이지 진입 시 바로 결과 렌더링
  window.addEventListener("DOMContentLoaded", renderResult);
</script>

</body>
</html>
