<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>AI 대화 코치</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <link rel="manifest" href="/manifest.json" />
  <style>
    :root {
      --primary: #6366f1;
      --primary-dark: #4f46e5;
      --bg1: #050816;
      --bg2: #3b1d6a;
      --card-bg: rgba(8, 12, 32, 0.96);
      --text-main: #f9fafb;
      --text-sub: #a5b4fc;
      --border: rgba(148, 163, 184, 0.35);
      --safe: #22c55e;
      --warn: #eab308;
      --danger: #ef4444;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    html, body {
      height: 100%;
    }

    body {
      min-height: 100vh;
      background:
        radial-gradient(circle at top, #4c1d95 0, rgba(76, 29, 149, 0.25) 20%, transparent 40%),
        radial-gradient(circle at bottom, #020617 0, #000 60%);
      color: var(--text-main);
      display: flex;
      justify-content: center;
      align-items: stretch;
      padding: calc(28px + env(safe-area-inset-top, 0px)) 12px 72px;
      -webkit-text-size-adjust: 100%;
    }

    .app {
      width: 100%;
      max-width: 480px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .screen {
      display: none;
    }
    .screen.active {
      display: block;
    }

    .card {
      background: var(--card-bg);
      border-radius: 30px;
      border: 1px solid rgba(148, 163, 184, 0.45);
      padding: 22px 18px 20px;
      box-shadow:
        0 26px 60px rgba(15, 23, 42, 0.95),
        0 0 0 1px rgba(15, 23, 42, 0.9);
      backdrop-filter: blur(18px);
    }

    .header-row {
      display: flex;
      gap: 14px;
      align-items: center;
      margin-bottom: 18px;
    }

    .header-icon {
      width: 52px;
      height: 52px;
      border-radius: 20px;
      padding: 3px;
      background: radial-gradient(circle at 30% 20%, #a5b4fc 0, #4c1d95 50%, #020617 100%);
      box-shadow:
        0 10px 20px rgba(79, 70, 229, 0.9),
        0 0 0 1px rgba(30, 64, 175, 0.55);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .header-icon img {
      width: 100%;
      height: 100%;
      border-radius: 17px;
      object-fit: cover;
    }

    .header-title {
      font-size: 26px;
      font-weight: 800;
      letter-spacing: -0.04em;
    }

    .header-sub {
      margin-top: 4px;
      font-size: 14px;
      color: var(--text-sub);
    }

    .section-title {
      font-size: 22px;
      font-weight: 800;
      margin-bottom: 8px;
      letter-spacing: -0.03em;
    }

    .section-sub {
      font-size: 14px;
      color: #c7d2fe;
      margin-bottom: 18px;
      line-height: 1.45;
    }

    .feature-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 8px;
    }

    .feature-card {
      border-radius: 22px;
      border: 1px solid rgba(148, 163, 184, 0.45);
      background: radial-gradient(circle at top left,
        rgba(79, 70, 229, 0.21) 0,
        rgba(17, 24, 39, 0.96) 40%,
        rgba(15, 23, 42, 0.98) 100%);
      padding: 14px 14px 14px;
      display: flex;
      justify-content: space-between;
      gap: 10px;
      cursor: pointer;
    }

    .feature-main {
      flex: 1;
    }

    .feature-title {
      font-size: 17px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .feature-desc {
      font-size: 13px;
      color: #cbd5f5;
      line-height: 1.5;
    }

    .feature-badge {
      align-self: center;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      font-size: 12px;
      color: #e5e7ff;
      background: rgba(15, 23, 42, 0.9);
      white-space: nowrap;
    }

    .feature-badge.primary {
      border-color: #a855f7;
      background: radial-gradient(circle at top,
        rgba(129, 140, 248, 0.45) 0,
        rgba(79, 70, 229, 0.7) 45%,
        rgba(15, 23, 42, 0.98) 100%);
    }

    .field-label {
      font-size: 13px;
      color: #c7d2fe;
      margin-bottom: 6px;
    }

    textarea {
      width: 100%;
      border-radius: 18px;
      border: 1px solid var(--border);
      background: rgba(15, 23, 42, 0.98);
      color: var(--text-main);
      font-size: 15px;
      padding: 12px 14px;
      outline: none;
      resize: vertical;
      min-height: 120px;
      line-height: 1.5;
      transition: border-color 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
    }

    textarea:focus {
      border-color: #818cf8;
      box-shadow: 0 0 0 1px rgba(129, 140, 248, 0.75);
      background: rgba(15, 23, 42, 1);
    }

    .hint {
      font-size: 12px;
      color: #94a3b8;
      margin-top: 6px;
      margin-bottom: 16px;
    }

    .btn-primary {
      width: 100%;
      border: none;
      border-radius: 20px;
      padding: 13px 16px;
      font-size: 16px;
      font-weight: 700;
      color: white;
      background: linear-gradient(90deg, var(--primary), var(--primary-dark));
      box-shadow:
        0 16px 36px rgba(79, 70, 229, 0.75),
        0 0 0 1px rgba(129, 140, 248, 0.7);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .btn-primary:active {
      transform: translateY(1px);
      box-shadow:
        0 10px 26px rgba(79, 70, 229, 0.7),
        0 0 0 1px rgba(129, 140, 248, 0.7);
    }

    .status-text {
      margin-top: 8px;
      font-size: 12px;
      color: #a5b4fc;
      min-height: 16px;
    }

    .back-btn {
      border: none;
      background: none;
      color: #e5e7ff;
      font-size: 13px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      margin-bottom: 8px;
      cursor: pointer;
    }

    .back-btn .arrow {
      font-size: 15px;
    }

    .top-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }

    .tone-chip {
      font-size: 12px;
      color: #cbd5f5;
    }

    .chip-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 12px;
    }

    .tone-btn {
      padding: 6px 14px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      background: rgba(15, 23, 42, 0.9);
      color: #e5e7eb;
      font-size: 13px;
      cursor: pointer;
    }
    .tone-btn.selected {
      background: rgba(99, 102, 241, 0.25);
      border-color: #818cf8;
      color: #e0e7ff;
      box-shadow: 0 0 0 1px rgba(129, 140, 248, 0.6);
    }

    /* 결과 화면 */
    .result-header-main {
      font-size: 22px;
      font-weight: 800;
      margin-bottom: 4px;
    }

    .result-header-sub {
      font-size: 14px;
      color: #c7d2fe;
      margin-bottom: 16px;
    }

    .result-card {
      border-radius: 24px;
      border: 1px solid rgba(148, 163, 184, 0.45);
      background: radial-gradient(circle at top left,
          rgba(79, 70, 229, 0.22) 0,
          rgba(17, 24, 39, 0.97) 42%,
          rgba(15, 23, 42, 0.98) 100%);
      padding: 16px 14px 14px;
    }

    .result-title-row {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 12px;
      font-size: 14px;
      font-weight: 700;
    }

    .result-caption {
      font-size: 12px;
      color: #cbd5f5;
      margin-bottom: 10px;
    }

    .original-box {
      border-radius: 18px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(15, 23, 42, 0.98);
      padding: 10px 12px;
      margin-bottom: 14px;
      font-size: 14px;
    }

    .original-label {
      font-size: 12px;
      color: #cbd5f5;
      margin-bottom: 4px;
    }

    .original-text {
      font-size: 14px;
    }

    .answer-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .answer-item {
      border-radius: 18px;
      border: 1px solid rgba(51, 65, 85, 0.9);
      background: rgba(15, 23, 42, 0.97);
      padding: 10px 11px 9px;
    }

    .answer-top-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
    }

    .answer-text {
      flex: 1;
      font-size: 15px;
      font-weight: 600;
      line-height: 1.5;
    }

    .favorite-btn,
    .copy-btn {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.95);
      color: #e5e7ff;
      font-size: 11px;
      padding: 4px 10px;
      cursor: pointer;
      white-space: nowrap;
    }

    .favorite-btn.active {
      border-color: #facc15;
      background: radial-gradient(circle at top,
        rgba(250, 204, 21, 0.3) 0,
        rgba(31, 41, 55, 0.98) 60%);
      color: #fef9c3;
    }

    .chips {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 4px;
    }

    .chip {
      padding: 2px 9px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.8);
      font-size: 11px;
      color: #e5e7eb;
      background: rgba(15, 23, 42, 0.98);
    }

    .chip-risk {
      border-color: var(--safe);
      color: var(--safe);
    }

    .chip-sense {
      border-color: #e5e7eb;
      color: #e5e7eb;
    }

    .comment-text {
      font-size: 12px;
      color: #cbd5f5;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.96);
      padding: 5px 10px;
      margin-top: 2px;
    }

    .result-footer {
      display: flex;
      gap: 10px;
      margin-top: 16px;
    }

    .btn-secondary,
    .btn-outline {
      flex: 1;
      border-radius: 18px;
      padding: 11px 12px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      text-align: center;
    }

    .btn-secondary {
      border: none;
      background: rgba(79, 70, 229, 0.16);
      color: #e0e7ff;
      box-shadow: 0 0 0 1px rgba(129, 140, 248, 0.7);
    }

    .btn-outline {
      border: 1px solid rgba(148, 163, 184, 0.8);
      background: rgba(15, 23, 42, 0.97);
      color: #e5e7eb;
    }

    /* 스켈레톤 */
    .skeleton-item {
      border-radius: 18px;
      border: 1px solid rgba(30, 64, 175, 0.5);
      background: rgba(15, 23, 42, 0.98);
      padding: 10px 11px 9px;
      overflow: hidden;
    }

    .skeleton-line {
      height: 10px;
      border-radius: 999px;
      background: linear-gradient(90deg,
        rgba(30, 64, 175, 0.35),
        rgba(15, 23, 42, 0.9),
        rgba(30, 64, 175, 0.35));
      background-size: 200% 100%;
      animation: shimmer 1.3s infinite;
      margin-bottom: 6px;
    }

    .skeleton-line.long { width: 80%; }
    .skeleton-line.mid { width: 60%; }
    .skeleton-line.short { width: 50%; }

    @keyframes shimmer {
      0% { background-position: -100% 0; }
      100% { background-position: 100% 0; }
    }

    /* 내 말투 화면 */
    .tone-sample-list {
      margin-top: 10px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      max-height: 180px;
      overflow-y: auto;
    }

    .tone-sample-item {
      font-size: 13px;
      padding: 6px 9px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.95);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .tone-sample-text {
      flex: 1;
    }

    .tone-sample-del {
      border: none;
      background: none;
      color: #f97373;
      font-size: 11px;
      cursor: pointer;
      white-space: nowrap;
    }

    /* 즐겨찾기 화면 */
    .fav-empty {
      font-size: 13px;
      color: #94a3b8;
      margin-top: 6px;
    }

    .fav-item {
      border-radius: 18px;
      border: 1px solid rgba(51, 65, 85, 0.9);
      background: rgba(15, 23, 42, 0.97);
      padding: 10px 11px 9px;
      margin-bottom: 8px;
    }

    .fav-top-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 4px;
    }

    .fav-text {
      font-size: 14px;
      flex: 1;
    }

    .fav-meta {
      font-size: 11px;
      color: #9ca3af;
      margin-bottom: 4px;
    }

    .fav-actions {
      display: flex;
      gap: 6px;
    }

    .btn-mini {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.95);
      color: #e5e7eb;
      font-size: 11px;
      padding: 3px 8px;
      cursor: pointer;
      white-space: nowrap;
    }

    /* 캡쳐 화면 */
    #screen-capture input[type="file"] {
      font-size: 13px;
    }

    /* 바텀 내비게이션 */
    .nav-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 8px 18px calc(10px + env(safe-area-inset-bottom, 0px));
      display: flex;
      justify-content: center;
      background: radial-gradient(circle at top,
        rgba(15, 23, 42, 0.98) 0,
        rgba(3, 7, 18, 0.98) 40%);
      border-top: 1px solid rgba(15, 23, 42, 0.95);
    }

    .nav-inner {
      width: 100%;
      max-width: 480px;
      background: rgba(15, 23, 42, 0.98);
      border-radius: 999px;
      border: 1px solid rgba(30, 64, 175, 0.85);
      display: flex;
      overflow: hidden;
    }

    .nav-btn {
      flex: 1;
      border: none;
      background: transparent;
      color: #9ca3af;
      font-size: 12px;
      padding: 10px 4px;
      cursor: pointer;
    }

    .nav-btn.active {
      background: radial-gradient(circle at top,
        rgba(129, 140, 248, 0.4) 0,
        rgba(15, 23, 42, 0.98) 70%);
      color: #f9fafb;
      font-weight: 600;
    }

    @media (max-height: 680px) {
      body {
        align-items: flex-start;
        padding-top: 14px;
      }
    }
  </style>
</head>
<body>
  <main class="app">
    <!-- ===== 화면 1 : 홈 ===== -->
    <section class="card screen active" id="screen-home">
      <div class="header-row">
        <div class="header-icon">
          <img src="/icon-192.png" alt="AI 대화 코치 아이콘" />
        </div>
        <div>
          <div class="header-title">AI 대화 코치</div>
          <div class="header-sub">카톡 답장, 같이 생각해주는 파트너</div>
        </div>
      </div>

      <div class="section-title">오늘은 무엇을 도와드릴까요?</div>
      <div class="section-sub">
        상황에 맞는 답장, 내 말투 반영, 자주 쓰는 답장 저장까지 한 번에.
      </div>

      <div class="feature-list">
        <button class="feature-card" id="feature-reply" type="button">
          <div class="feature-main">
            <div class="feature-title">1. AI가 카톡 답장 만들어주기</div>
            <div class="feature-desc">
              상대가 보낸 메시지 내용을 붙여 넣으면, 딱 맞는 답장 3개를 추천해 드려요.
            </div>
          </div>
          <div class="feature-badge primary">바로 시작</div>
        </button>

        <button class="feature-card" id="feature-my-tone" type="button">
          <div class="feature-main">
            <div class="feature-title">2. 내 말투 학습시키기</div>
            <div class="feature-desc">
              내가 실제로 자주 쓰는 말들을 저장해 두면, 답장이 점점 나와 더 비슷해져요.
            </div>
          </div>
          <div class="feature-badge">말투 저장</div>
        </button>

        <button class="feature-card" id="feature-favorites" type="button">
          <div class="feature-main">
            <div class="feature-title">3. 즐겨찾기 답장 모아보기</div>
            <div class="feature-desc">
              마음에 들었던 답장을 즐겨찾기 해두고, 나중에 한 번에 모아볼 수 있어요.
            </div>
          </div>
          <div class="feature-badge">모아보기</div>
        </button>

        <button class="feature-card" id="feature-capture" type="button">
          <div class="feature-main">
            <div class="feature-title">4. 캡쳐로 답장 만들기</div>
            <div class="feature-desc">
              대화 캡쳐 이미지를 업로드하면, 그 내용을 읽고 어울리는 답장을 추천해 드려요.
            </div>
          </div>
          <div class="feature-badge">캡쳐 모드</div>
        </button>
      </div>
    </section>

    <!-- ===== 화면 2 : 텍스트로 답장 만들기 ===== -->
    <section class="card screen" id="screen-make">
      <button class="back-btn" id="backToHome" type="button">
        <span class="arrow">←</span><span>홈으로</span>
      </button>

      <div class="header-row" style="margin-bottom:14px;">
        <div class="header-icon">
          <img src="/icon-192.png" alt="아이콘" />
        </div>
        <div>
          <div class="header-title" style="font-size:23px;">AI가 카톡 답장 만들어주기</div>
          <div class="header-sub">상황에 맞는 톤을 고르고, 상대방 메시지를 붙여 넣어 주세요.</div>
        </div>
      </div>

      <div class="top-row">
        <div class="field-label" style="margin-bottom:0;">대화 상황 선택</div>
        <div class="tone-chip" id="toneChip">친구 톤</div>
      </div>
      <div class="chip-row" style="margin-top:6px;">
        <button class="tone-btn" data-tone="연애">연애</button>
        <button class="tone-btn" data-tone="썸">썸</button>
        <button class="tone-btn" data-tone="친구">친구</button>
        <button class="tone-btn" data-tone="직장">직장</button>
        <button class="tone-btn" data-tone="가족">가족</button>
        <button class="tone-btn" data-tone="기본">기본</button>
      </div>

      <div style="margin-top:12px;">
        <div class="field-label">상대방 메시지</div>
        <textarea id="message" placeholder="상대가 보낸 카톡 내용을 그대로 붙여 넣어 주세요."></textarea>
      </div>

      <p class="hint">예) “내일 뭐해?” 처럼 실제 대화 내용을 넣을수록 더 자연스러운 답장이 나와요.</p>

      <button class="btn-primary" id="generateBtn" type="button">
        AI 추천 답장 생성
      </button>
      <div class="status-text" id="statusMake"></div>
    </section>

    <!-- ===== 화면 3 : 결과 ===== -->
    <section class="card screen" id="screen-result">
      <button class="back-btn" id="backToMake" type="button">
        <span class="arrow">←</span><span>답장 수정하기</span>
      </button>

      <div class="result-header-main">AI 추천 답장</div>
      <div class="result-header-sub" id="resultTopText">
        AI 추천 답장이 준비되고 있어요…
      </div>

      <section class="result-card">
        <div class="result-title-row">
          <div>추천 결과</div>
          <div style="font-size:12px;font-weight:500;">최대 3개까지 추천</div>
        </div>
        <div class="result-caption" id="resultStatusText">
          위험도·센스 점수는 가볍게 참고만 해주세요.
        </div>

        <div class="original-box">
          <div class="original-label">상대방 메시지</div>
          <div class="original-text" id="resultOriginalMsg">-</div>
        </div>

        <div class="answer-list" id="answers"></div>
      </section>

      <div class="result-footer">
        <button class="btn-secondary" id="regenerateBtn" type="button">다시 생성하기</button>
        <button class="btn-outline" id="homeBtn" type="button">홈으로</button>
      </div>
    </section>

    <!-- ===== 화면 4 : 캡쳐로 답장 만들기 ===== -->
    <section class="card screen" id="screen-capture">
      <button class="back-btn" id="backToHomeFromCap" type="button">
        <span class="arrow">←</span><span>홈으로</span>
      </button>

      <div class="header-row" style="margin-bottom:14px;">
        <div class="header-icon">
          <img src="/icon-192.png" alt="아이콘" />
        </div>
        <div>
          <div class="header-title" style="font-size:23px;">캡쳐로 답장 만들기</div>
          <div class="header-sub">대화 캡쳐 이미지를 읽고, 어울리는 답장을 추천해 드려요.</div>
        </div>
      </div>

      <div class="field-label">대화 캡쳐 이미지</div>
      <input id="captureInput" type="file" accept="image/*"
             style="width:100%;margin-top:4px;margin-bottom:8px;color:#e5e7eb;" />

      <div id="capturePreview"
           style="margin-top:2px;margin-bottom:10px;font-size:13px;color:#94a3b8;">
        이미지를 선택하면 이미지 안의 텍스트를 읽어 답장을 만들어 드립니다.
      </div>

      <p class="hint">※ 현재는 하나의 이미지만 지원합니다. 화면 캡쳐를 그대로 올려 주세요.</p>

      <button class="btn-primary" id="captureBtn" type="button">
        캡쳐로 AI 답장 생성
      </button>
      <div class="status-text" id="statusCapture"></div>
    </section>

    <!-- ===== 화면 5 : 내 말투 학습 ===== -->
    <section class="card screen" id="screen-myTone">
      <button class="back-btn" id="backToHomeFromTone" type="button">
        <span class="arrow">←</span><span>홈으로</span>
      </button>

      <div class="header-row" style="margin-bottom:14px;">
        <div class="header-icon">
          <img src="/icon-192.png" alt="아이콘" />
        </div>
        <div>
          <div class="header-title" style="font-size:23px;">내 말투 학습시키기</div>
          <div class="header-sub">
            내가 실제로 쓰는 말들을 저장해 두면, 답장을 만들 때 참고해서 더 비슷하게 만들어 드려요.
          </div>
        </div>
      </div>

      <div class="field-label">내가 실제로 자주 쓰는 말</div>
      <textarea id="myToneInput" placeholder="예) ㅋㅋ 그니까 완전 공감이야&#10;예) 오케이~ 내일 보자 :)"></textarea>
      <p class="hint">한 번에 여러 줄을 적어도 되고, 생각날 때마다 조금씩 추가해도 괜찮아요.</p>

      <button class="btn-primary" id="saveToneBtn" type="button">
        말투 예시 저장
      </button>
      <div class="status-text" id="statusTone"></div>

      <div class="field-label" style="margin-top:14px;">지금까지 저장된 말투 예시</div>
      <div id="myToneList" class="tone-sample-list"></div>
    </section>

    <!-- ===== 화면 6 : 즐겨찾기 ===== -->
    <section class="card screen" id="screen-fav">
      <button class="back-btn" id="backToHomeFromFav" type="button">
        <span class="arrow">←</span><span>홈으로</span>
      </button>

      <div class="header-row" style="margin-bottom:10px;">
        <div class="header-icon">
          <img src="/icon-192.png" alt="아이콘" />
        </div>
        <div>
          <div class="header-title" style="font-size:23px;">즐겨찾기 답장 모아보기</div>
          <div class="header-sub">
            마음에 들었던 답장을 ★ 즐겨찾기 해두면, 여기에서 한 번에 모아볼 수 있어요.
          </div>
        </div>
      </div>

      <div class="field-label">저장된 즐겨찾기 답장</div>
      <div id="favList"></div>
    </section>
  </main>

  <!-- 공통 바텀 내비 -->
  <nav class="nav-bar">
    <div class="nav-inner">
      <button class="nav-btn active" id="nav-home" type="button">홈</button>
      <button class="nav-btn" id="nav-reply" type="button">답장 만들기</button>
      <button class="nav-btn" id="nav-my" type="button">내 말투</button>
      <button class="nav-btn" id="nav-fav" type="button">즐겨찾기</button>
    </div>
  </nav>

  <script>
    const scrHome    = document.getElementById("screen-home");
    const scrMake    = document.getElementById("screen-make");
    const scrResult  = document.getElementById("screen-result");
    const scrCapture = document.getElementById("screen-capture");
    const scrMyTone  = document.getElementById("screen-myTone");
    const scrFav     = document.getElementById("screen-fav");

    const navHome  = document.getElementById("nav-home");
    const navReply = document.getElementById("nav-reply");
    const navMy    = document.getElementById("nav-my");
    const navFav   = document.getElementById("nav-fav");

    const MY_TONE_KEY = "aiCoach_myToneSamples";
    const FAV_KEY     = "aiCoach_favorites";

    function showScreen(name) {
      [scrHome, scrMake, scrResult, scrCapture, scrMyTone, scrFav]
        .forEach(s => s && s.classList.remove("active"));

      if (name === "home" && scrHome) scrHome.classList.add("active");
      else if (name === "make" && scrMake) scrMake.classList.add("active");
      else if (name === "capture" && scrCapture) scrCapture.classList.add("active");
      else if (name === "myTone" && scrMyTone) scrMyTone.classList.add("active");
      else if (name === "fav" && scrFav) {
        scrFav.classList.add("active");
        renderFavoritesScreen();
      } else if (scrResult) {
        scrResult.classList.add("active");
      }

      [navHome, navReply, navMy, navFav].forEach(b => b && b.classList.remove("active"));
      if (name === "home")      navHome.classList.add("active");
      else if (name === "make" || name === "capture" || name === "result") navReply.classList.add("active");
      else if (name === "myTone") navMy.classList.add("active");
      else if (name === "fav") navFav.classList.add("active");
    }

    // 홈 카드
    document.getElementById("feature-reply")
      .addEventListener("click", () => showScreen("make"));
    document.getElementById("feature-my-tone")
      .addEventListener("click", () => { renderMyToneScreen(); showScreen("myTone"); });
    document.getElementById("feature-favorites")
      .addEventListener("click", () => showScreen("fav"));
    document.getElementById("feature-capture")
      .addEventListener("click", () => showScreen("capture"));

    // 상단 뒤로가기
    document.getElementById("backToHome")
      .addEventListener("click", () => showScreen("home"));
    document.getElementById("backToMake")
      .addEventListener("click", () => showScreen("make"));
    document.getElementById("backToHomeFromCap")
      .addEventListener("click", () => showScreen("home"));
    document.getElementById("backToHomeFromTone")
      .addEventListener("click", () => showScreen("home"));
    document.getElementById("backToHomeFromFav")
      .addEventListener("click", () => showScreen("home"));

    // 하단 내비
    navHome.addEventListener("click", () => showScreen("home"));
    navReply.addEventListener("click", () => showScreen("make"));
    navMy.addEventListener("click", () => { renderMyToneScreen(); showScreen("myTone"); });
    navFav.addEventListener("click", () => showScreen("fav"));

    // ===== 톤 선택 및 상태 =====
    const toneButtons = Array.from(document.querySelectorAll(".tone-btn"));
    const toneChip    = document.getElementById("toneChip");
    const msgEl       = document.getElementById("message");
    const generateBtn = document.getElementById("generateBtn");
    const statusMake  = document.getElementById("statusMake");

    let selectedTone = "친구";
    let lastMessage  = "";
    let currentMode  = "text"; // text | capture

    toneButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        toneButtons.forEach(b => b.classList.remove("selected"));
        btn.classList.add("selected");
        selectedTone = btn.dataset.tone || "친구";
        if (toneChip) toneChip.textContent = selectedTone + " 톤";
        statusMake.textContent = "";
      });
    });
    const friendBtn = toneButtons.find(b => b.dataset.tone === "친구");
    if (friendBtn) friendBtn.classList.add("selected");

    // ===== 결과 화면 요소 =====
    const resultTopText    = document.getElementById("resultTopText");
    const resultStatusText = document.getElementById("resultStatusText");
    const resultOriginal   = document.getElementById("resultOriginalMsg");
    const answersEl        = document.getElementById("answers");
    const regenerateBtn    = document.getElementById("regenerateBtn");
    const homeBtn          = document.getElementById("homeBtn");

    function parseLine(line) {
      const parts = line.split("||").map(p => p.trim());
      return {
        text: parts[0] || "",
        risk: parts[1] || "",
        sense: parts[2] || "",
        comment: parts[3] || ""
      };
    }

    function showSkeleton() {
      answersEl.innerHTML = "";
      for (let i = 0; i < 3; i++) {
        const sk = document.createElement("div");
        sk.className = "skeleton-item";
        sk.innerHTML = `
          <div class="skeleton-line long"></div>
          <div class="skeleton-line mid"></div>
          <div class="skeleton-line short"></div>
        `;
        answersEl.appendChild(sk);
      }
    }

    // ===== localStorage: 말투 / 즐겨찾기 =====
    function loadMyToneSamples() {
      try {
        const raw = localStorage.getItem(MY_TONE_KEY);
        if (!raw) return [];
        const arr = JSON.parse(raw);
        return Array.isArray(arr) ? arr : [];
      } catch {
        return [];
      }
    }

    function saveMyToneSamples(list) {
      localStorage.setItem(MY_TONE_KEY, JSON.stringify(list));
    }

    function loadFavorites() {
      try {
        const raw = localStorage.getItem(FAV_KEY);
        if (!raw) return [];
        const arr = JSON.parse(raw);
        return Array.isArray(arr) ? arr : [];
      } catch {
        return [];
      }
    }

    function saveFavorites(list) {
      localStorage.setItem(FAV_KEY, JSON.stringify(list));
    }

    function renderMyToneScreen() {
      const myToneListEl = document.getElementById("myToneList");
      const samples = loadMyToneSamples();
      myToneListEl.innerHTML = "";
      if (samples.length === 0) {
        myToneListEl.innerHTML = '<div class="fav-empty">아직 저장된 말투 예시가 없습니다.</div>';
        return;
      }
      samples.forEach((text, idx) => {
        const item = document.createElement("div");
        item.className = "tone-sample-item";
        item.innerHTML = `
          <div class="tone-sample-text">${text}</div>
          <button class="tone-sample-del" data-idx="${idx}" type="button">삭제</button>
        `;
        const delBtn = item.querySelector(".tone-sample-del");
        delBtn.addEventListener("click", () => {
          const list = loadMyToneSamples();
          list.splice(idx, 1);
          saveMyToneSamples(list);
          renderMyToneScreen();
        });
        myToneListEl.appendChild(item);
      });
    }

    function renderFavoritesScreen() {
      const favListEl = document.getElementById("favList");
      const favs = loadFavorites();
      favListEl.innerHTML = "";
      if (favs.length === 0) {
        favListEl.innerHTML = '<div class="fav-empty">아직 즐겨찾기한 답장이 없습니다. 답장 결과 화면에서 "즐겨찾기" 버튼을 눌러보세요.</div>';
        return;
      }
      favs.forEach((f, idx) => {
        const item = document.createElement("div");
        item.className = "fav-item";
        item.innerHTML = `
          <div class="fav-top-row">
            <div class="fav-text">${f.text}</div>
            <div class="fav-meta">${f.tone || "톤 정보 없음"} · ${f.source === "capture" ? "캡쳐" : "텍스트"}</div>
          </div>
          <div class="chips">
            ${f.risk ? `<span class="chip chip-risk">${f.risk}</span>` : ""}
            ${f.sense ? `<span class="chip chip-sense">${f.sense}</span>` : ""}
          </div>
          ${f.comment ? `<div class="comment-text">${f.comment}</div>` : ""}
          <div class="fav-actions">
            <button class="btn-mini btn-fav-copy" type="button">복사</button>
            <button class="btn-mini btn-fav-del" data-idx="${idx}" type="button">삭제</button>
          </div>
        `;
        const copyBtn = item.querySelector(".btn-fav-copy");
        const delBtn  = item.querySelector(".btn-fav-del");
        copyBtn.addEventListener("click", () => {
          navigator.clipboard.writeText(f.text).then(() => {
            copyBtn.textContent = "복사됨";
            setTimeout(() => (copyBtn.textContent = "복사"), 1200);
          });
        });
        delBtn.addEventListener("click", () => {
          const list = loadFavorites();
          list.splice(idx, 1);
          saveFavorites(list);
          renderFavoritesScreen();
        });
        favListEl.appendChild(item);
      });
    }

    function isFavoriteText(text) {
      const favs = loadFavorites();
      return favs.some(f => f.text === text);
    }

    function addFavorite(entry) {
      const favs = loadFavorites();
      if (!favs.some(f => f.text === entry.text)) {
        favs.unshift(entry);
        saveFavorites(favs);
      }
    }

    function removeFavoriteText(text) {
      const favs = loadFavorites();
      const next = favs.filter(f => f.text !== text);
      saveFavorites(next);
    }

    // ===== 결과 렌더링 =====
    function renderReplies(replyText) {
      const lines = replyText
        .split("\n")
        .map(l => l.trim())
        .filter(Boolean)
        .slice(0, 3);

      answersEl.innerHTML = "";

      if (lines.length === 0) {
        resultStatusText.textContent = "생성된 답장이 없습니다. 내용을 조금 바꿔보세요.";
        return;
      }

      resultTopText.textContent    = "AI 추천 답장이 준비됐어요!";
      resultStatusText.textContent = "마음에 드는 답장을 골라서 복사해 사용해 보세요.";

      const currentFavs = loadFavorites();

      lines.forEach((line, idx) => {
        const { text: rawText, risk, sense, comment } = parseLine(line);
        const answerText = rawText.replace(/^\d+\.\s*/, "");

        const wrapper = document.createElement("div");
        wrapper.className = "answer-item";
        wrapper.innerHTML = `
          <div class="answer-top-row">
            <div class="answer-text">${idx + 1}. ${answerText}</div>
            <button class="favorite-btn" type="button">즐겨찾기</button>
            <button class="copy-btn" type="button">복사</button>
          </div>
          <div class="chips">
            ${risk  ? `<span class="chip chip-risk">${risk}</span>`   : ""}
            ${sense ? `<span class="chip chip-sense">${sense}</span>` : ""}
          </div>
          ${comment ? `<div class="comment-text">${comment}</div>` : ""}
        `;

        const favBtn  = wrapper.querySelector(".favorite-btn");
        const copyBtn = wrapper.querySelector(".copy-btn");

        const alreadyFav = currentFavs.some(f => f.text === answerText);
        if (alreadyFav) {
          favBtn.classList.add("active");
          favBtn.textContent = "즐겨찾기 해제";
        }

        favBtn.addEventListener("click", () => {
          const isActive = favBtn.classList.toggle("active");
          if (isActive) {
            favBtn.textContent = "즐겨찾기 해제";
            addFavorite({
              text: answerText,
              risk,
              sense,
              comment,
              tone: selectedTone,
              source: currentMode,
              createdAt: Date.now()
            });
          } else {
            favBtn.textContent = "즐겨찾기";
            removeFavoriteText(answerText);
          }
        });

        copyBtn.addEventListener("click", () => {
          navigator.clipboard.writeText(answerText).then(() => {
            copyBtn.textContent = "복사됨";
            setTimeout(() => (copyBtn.textContent = "복사"), 1200);
          });
        });

        answersEl.appendChild(wrapper);
      });
    }

    // ===== /reply 호출 : 어떤 형식이 와도 처리 =====
    async function callReplyAPI(text, tone) {
      try {
        const toneSamples = loadMyToneSamples();
        const res  = await fetch("/reply", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ text, tone, toneSamples })
        });
        const body = await res.text();
        let replyText = "";

        try {
          const data = JSON.parse(body);
          if (data && typeof data === "object") {
            if (typeof data.reply === "string") {
              replyText = data.reply;
            } else if (Array.isArray(data.choices) &&
                       data.choices[0]?.message?.content) {
              replyText = data.choices[0].message.content;
            }
          }
        } catch (e) {
          // JSON이 아니면 그대로 사용
        }
        if (!replyText) replyText = body || "";

        if (!res.ok && !replyText.trim()) {
          resultStatusText.textContent = "답장 생성 중 오류가 발생했습니다.";
          answersEl.innerHTML = "";
          return;
        }

        renderReplies(replyText);
      } catch (err) {
        console.error(err);
        resultStatusText.textContent = "서버와 통신 중 오류가 발생했습니다.";
        answersEl.innerHTML = "";
      }
    }

    // ===== /capture 호출 : 이미지 기반 =====
    const captureInput  = document.getElementById("captureInput");
    const captureBtn    = document.getElementById("captureBtn");
    const statusCapture = document.getElementById("statusCapture");

    async function callCaptureAPI(file) {
      try {
        const fd = new FormData();
        fd.append("image", file);

        const res  = await fetch("/capture", {
          method: "POST",
          body: fd
        });
        const body = await res.text();
        let replyText = "";

        try {
          const data = JSON.parse(body);
          if (data && typeof data === "object") {
            if (typeof data.reply === "string") {
              replyText = data.reply;
            } else if (Array.isArray(data.choices) &&
                       data.choices[0]?.message?.content) {
              replyText = data.choices[0].message.content;
            }
          }
        } catch (e) {}
        if (!replyText) replyText = body || "";

        if (!res.ok && !replyText.trim()) {
          resultStatusText.textContent = "캡쳐 기반 답장 생성 중 오류가 발생했습니다.";
          answersEl.innerHTML = "";
          return;
        }

        renderReplies(replyText);
      } catch (err) {
        console.error(err);
        resultStatusText.textContent = "서버와 통신 중 오류가 발생했습니다.";
        answersEl.innerHTML = "";
      }
    }

    // ===== 텍스트 답장 생성 플로우 =====
    function startGenerateFlow() {
      const text = msgEl.value.trim();
      if (!text) {
        statusMake.textContent = "먼저 상대방 메시지를 입력해 주세요.";
        return;
      }

      currentMode = "text";
      lastMessage = text;
      if (toneChip) toneChip.textContent = selectedTone + " 톤";

      resultTopText.textContent    = "AI 추천 답장이 준비되는 중이에요...";
      resultStatusText.textContent = "AI가 답장을 만드는 중이에요.";
      resultOriginal.textContent   = text;

      showScreen("result");
      showSkeleton();
      callReplyAPI(text, selectedTone);
    }

    generateBtn.addEventListener("click", startGenerateFlow);

    // ===== 캡쳐 답장 생성 플로우 =====
    function startCaptureFlow() {
      const file = captureInput && captureInput.files && captureInput.files[0];
      if (!file) {
        statusCapture.textContent = "먼저 캡쳐 이미지를 선택해 주세요.";
        return;
      }

      currentMode = "capture";
      lastMessage = "(캡쳐 이미지)";
      if (toneChip) toneChip.textContent = "캡쳐 모드";

      resultTopText.textContent    = "AI가 캡쳐를 분석하고 있어요...";
      resultStatusText.textContent = "이미지에서 텍스트를 읽어 답장을 만드는 중이에요.";
      resultOriginal.textContent   = "대화 캡쳐 이미지 기반으로 생성된 답장입니다.";

      statusCapture.textContent = "";
      showScreen("result");
      showSkeleton();
      callCaptureAPI(file);
    }

    captureBtn.addEventListener("click", startCaptureFlow);

    // ===== 내 말투 저장 =====
    const myToneInput = document.getElementById("myToneInput");
    const saveToneBtn = document.getElementById("saveToneBtn");
    const statusTone  = document.getElementById("statusTone");

    saveToneBtn.addEventListener("click", () => {
      const text = (myToneInput.value || "").trim();
      if (!text) {
        statusTone.textContent = "먼저 말투 예시를 입력해 주세요.";
        return;
      }
      const lines = text.split("\n").map(l => l.trim()).filter(Boolean);
      if (lines.length === 0) {
        statusTone.textContent = "저장할 내용이 없습니다.";
        return;
      }
      const current = loadMyToneSamples();
      lines.forEach(l => {
        if (!current.includes(l)) current.push(l);
      });
      saveMyToneSamples(current);
      myToneInput.value = "";
      statusTone.textContent = "말투 예시가 저장되었습니다.";
      renderMyToneScreen();
      setTimeout(() => (statusTone.textContent = ""), 1500);
    });

    // ===== 다시 생성 / 홈 =====
    regenerateBtn.addEventListener("click", () => {
      if (currentMode === "text") {
        if (!lastMessage) return;
        resultTopText.textContent    = "AI 추천 답장이 준비되는 중이에요...";
        resultStatusText.textContent = "AI가 답장을 다시 만드는 중이에요.";
        showSkeleton();
        callReplyAPI(lastMessage, selectedTone);
      } else {
        alert("캡쳐 답장은 이미지를 다시 선택해서 생성해 주세요.");
      }
    });

    homeBtn.addEventListener("click", () => {
      msgEl.value = "";
      statusMake.textContent = "";
      answersEl.innerHTML = "";
      showScreen("home");
    });
  </script>
</body>
</html>
