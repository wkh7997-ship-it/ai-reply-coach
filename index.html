<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>AI ëŒ€í™” ì½”ì¹˜ í…ŒìŠ¤íŠ¸</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    textarea {
      width: 100%;
      max-width: 500px;
    }
    #result > .reply-row {
      margin-bottom: 10px;
      padding: 6px 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .reply-main {
      font-weight: 600;
      margin-bottom: 4px;
    }
    .meta {
      font-size: 12px;
      color: #555;
    }
    .risk-low {
      color: #1a7f37;
    }
    .risk-mid {
      color: #d97706;
    }
    .risk-high {
      color: #b91c1c;
      font-weight: 700;
    }
    .copy-btn {
      padding: 2px 6px;
      font-size: 12px;
      cursor: pointer;
      margin-left: 4px;
    }
    #history .history-item {
      border-bottom: 1px solid #eee;
      padding: 6px 0;
      font-size: 13px;
    }
    #history .history-meta {
      color: #555;
    }
    #history button {
      font-size: 11px;
      padding: 2px 6px;
      margin-top: 4px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>AI ë‹µì¥ ìƒì„±ê¸°</h1>

  <!-- ìƒí™©(í†¤) ì„ íƒ -->
  <label for="toneSelect">ìƒí™© ì„ íƒ:</label>
  <select id="toneSelect">
    <option value="ê¸°ë³¸">ê¸°ë³¸</option>
    <option value="ì—°ì• ">ì—°ì• /ì¸</option>
    <option value="ì§ì¥">ì§ì¥ ìƒì‚¬/íšŒì‚¬</option>
    <option value="ì¹œêµ¬">ì¹œêµ¬</option>
    <option value="ê°€ì¡±">ê°€ì¡±</option>
  </select>

  <br><br>

  <!-- ìƒëŒ€ë°© ë©”ì‹œì§€ ì…ë ¥ -->
  <textarea id="inputText" rows="5" cols="40" placeholder="ìƒëŒ€ë°© ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”"></textarea>
  <br><br>
  <button onclick="sendText()">ë‹µì¥ ìƒì„±</button>

  <h3>AI ì¶”ì²œ ë‹µì¥</h3>
  <div id="result"></div>

  <h3>ìµœê·¼ ëŒ€í™” ê¸°ë¡</h3>
  <div id="history"></div>

  <script>
    function riskClass(score) {
      if (score >= 70) return "risk-high";
      if (score >= 30) return "risk-mid";
      return "risk-low";
    }

    // ğŸ”¹ íˆìŠ¤í† ë¦¬ ì €ì¥
    function saveHistory(inputText, tone, lines) {
      try {
        const key = "reply_history_v1";
        const raw = localStorage.getItem(key);
        let arr = [];
        if (raw) {
          arr = JSON.parse(raw);
        }

        const item = {
          time: Date.now(),
          tone,
          input: inputText,
          replies: lines   // "ë¬¸ì¥ || ìœ„í—˜ë„ || ..." í˜•ì‹ ê·¸ëŒ€ë¡œ ì €ì¥
        };

        arr.unshift(item);          // ì•ì— ì¶”ê°€
        if (arr.length > 20) {      // ìµœëŒ€ 20ê°œë§Œ ìœ ì§€
          arr = arr.slice(0, 20);
        }

        localStorage.setItem(key, JSON.stringify(arr));
      } catch (e) {
        console.error("íˆìŠ¤í† ë¦¬ ì €ì¥ ì˜¤ë¥˜:", e);
      }
    }

    // ğŸ”¹ íˆìŠ¤í† ë¦¬ ë Œë”ë§
    function loadHistory() {
      const key = "reply_history_v1";
      const historyDiv = document.getElementById("history");
      historyDiv.innerHTML = "";

      try {
        const raw = localStorage.getItem(key);
        if (!raw) {
          historyDiv.textContent = "ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.";
          return;
        }

        const arr = JSON.parse(raw);
        if (!arr.length) {
          historyDiv.textContent = "ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.";
          return;
        }

        arr.forEach((item, idx) => {
          const wrap = document.createElement("div");
          wrap.className = "history-item";

          const date = new Date(item.time);
          const timeStr = date.toLocaleString();

          const meta = document.createElement("div");
          meta.className = "history-meta";
          meta.textContent =
            `${idx + 1}. [${item.tone}] ${timeStr}`;

          const preview = document.createElement("div");
          const inputPreview =
            item.input.length > 30
              ? item.input.slice(0, 30) + "..."
              : item.input;
          preview.textContent = `ë©”ì‹œì§€: ${inputPreview}`;

          const btn = document.createElement("button");
          btn.textContent = "ë¶ˆëŸ¬ì˜¤ê¸°";
          btn.onclick = () => {
            document.getElementById("toneSelect").value = item.tone;
            document.getElementById("inputText").value = item.input;

            const resultDiv = document.getElementById("result");
            resultDiv.innerHTML = "";
            item.replies.forEach((line, idx2) => {
              const row = document.createElement("div");
              row.className = "reply-row";
              const main = document.createElement("div");
              main.className = "reply-main";

              const parts = line.split("||").map(p => p.trim());
              const textPart = parts[0] || line;

              main.textContent = `${idx2 + 1}. ${textPart}`;
              row.appendChild(main);
              resultDiv.appendChild(row);
            });
          };

          wrap.appendChild(meta);
          wrap.appendChild(preview);
          wrap.appendChild(btn);

          historyDiv.appendChild(wrap);
        });
      } catch (e) {
        historyDiv.textContent = "íˆìŠ¤í† ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
        console.error(e);
      }
    }

    async function sendText() {
      const text = document.getElementById("inputText").value.trim();
      const tone = document.getElementById("toneSelect").value;
      const resultDiv = document.getElementById("result");

      if (!text) {
        alert("ë¨¼ì € ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”!");
        return;
      }

      resultDiv.textContent = "ìƒì„± ì¤‘...";

      try {
        const res = await fetch("/reply", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ text, tone })
        });

        const data = await res.json();

        if (res.ok && data.reply) {
          const lines = data.reply
            .split("\n")
            .map(l => l.trim())
            .filter(l => l.length > 0);

          resultDiv.innerHTML = "";

          if (lines.length === 0) {
            resultDiv.textContent = "ìƒì„±ëœ ë‹µì¥ì´ ì—†ìŠµë‹ˆë‹¤.";
            return;
          }

          // í™”ë©´ì— í‘œì‹œ + ë³µì‚¬/ìˆ˜ì • ë²„íŠ¼
          lines.forEach((line, idx) => {
            const parts = line.split("||").map(p => p.trim());
            let textPart   = parts[0] || line;
            const riskStr    = parts[1] || "0";
            const senseStr   = parts[2] || "0";
            const commentStr = parts[3] || "";

            const risk = parseInt(riskStr) || 0;
            const sense = parseInt(senseStr) || 0;

            const row = document.createElement("div");
            row.className = "reply-row";

            const main = document.createElement("div");
            main.className = "reply-main";
            main.textContent = `${idx + 1}. ${textPart}`;

            // ë³µì‚¬ ë²„íŠ¼
            const copyBtn = document.createElement("button");
            copyBtn.className = "copy-btn";
            copyBtn.textContent = "ë³µì‚¬";
            copyBtn.onclick = async () => {
              try {
                await navigator.clipboard.writeText(textPart);
                copyBtn.textContent = "ë³µì‚¬ë¨!";
                setTimeout(() => (copyBtn.textContent = "ë³µì‚¬"), 1200);
              } catch (e) {
                alert("ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: " + e);
              }
            };
            main.appendChild(copyBtn);

            // ğŸ”¥ ìœ„í—˜ë„ê°€ ë†’ìœ¼ë©´ 'ì•ˆì „í•˜ê²Œ ìˆ˜ì •' ë²„íŠ¼ ì¶”ê°€
            if (risk >= 70) {
              const fixBtn = document.createElement("button");
              fixBtn.className = "copy-btn";
              fixBtn.textContent = "âš  ì•ˆì „í•˜ê²Œ ìˆ˜ì •";
              fixBtn.onclick = async () => {
                try {
                  fixBtn.textContent = "ìˆ˜ì • ì¤‘...";
                  const toneNow = document.getElementById("toneSelect").value;
                  const resFix = await fetch("/fix", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ text: textPart, tone: toneNow })
                  });
                  const fixData = await resFix.json();
                  if (resFix.ok && fixData.fixed) {
                    textPart = fixData.fixed;
                    main.firstChild.textContent = `${idx + 1}. ${textPart}`;
                    fixBtn.textContent = "ìˆ˜ì • ì™„ë£Œ";
                  } else {
                    alert("ìˆ˜ì • ì‹¤íŒ¨: " + JSON.stringify(fixData));
                    fixBtn.textContent = "âš  ì•ˆì „í•˜ê²Œ ìˆ˜ì •";
                  }
                } catch (e) {
                  alert("ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + e);
                  fixBtn.textContent = "âš  ì•ˆì „í•˜ê²Œ ìˆ˜ì •";
                }
              };
              main.appendChild(fixBtn);
            }

            const meta = document.createElement("div");
            meta.className = "meta";

            const riskSpan = document.createElement("span");
            riskSpan.textContent = `ìœ„í—˜ë„: ${risk}`;
            riskSpan.className = riskClass(risk);

            const senseSpan = document.createElement("span");
            senseSpan.textContent = ` / ì„¼ìŠ¤: ${sense}`;

            const commentSpan = document.createElement("span");
            if (commentStr) {
              commentSpan.textContent = ` / ì„¤ëª…: ${commentStr}`;
            }

            meta.appendChild(riskSpan);
            meta.appendChild(senseSpan);
            if (commentStr) meta.appendChild(commentSpan);

            row.appendChild(main);
            row.appendChild(meta);
            resultDiv.appendChild(row);
          });

          // ğŸ”¹ íˆìŠ¤í† ë¦¬ ì €ì¥ & ê°±ì‹ 
          saveHistory(text, tone, lines);
          loadHistory();

        } else {
          resultDiv.textContent =
            "API ì—ëŸ¬: " + JSON.stringify(data, null, 2);
        }
      } catch (err) {
        resultDiv.textContent = "ìš”ì²­ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + err;
      }
    }

    // í˜ì´ì§€ ì²˜ìŒ ì—´ë¦´ ë•Œ íˆìŠ¤í† ë¦¬ ë¡œë”©
    window.onload = loadHistory;
  </script>
</body>
</html>
