<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>AI 대화 코치</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <link rel="manifest" href="/manifest.json" />

  <style>
    :root {
      --primary: #6366f1;
      --primary-dark: #4f46e5;
      --card-bg: rgba(8, 12, 32, 0.96);
      --text-main: #f9fafb;
      --text-sub: #a5b4fc;
      --border: rgba(148, 163, 184, 0.35);
      --safe: #22c55e;
      --warn: #eab308;
      --danger: #ef4444;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    html, body {
      height: 100%;
    }

    body {
      min-height: 100vh;
      background:
        radial-gradient(circle at top, #4c1d95 0, rgba(76, 29, 149, 0.25) 18%, transparent 35%),
        radial-gradient(circle at bottom, #0b1120 0, #020617 55%, #000 100%);
      color: var(--text-main);
      display: flex;
      justify-content: center;
      align-items: center;
      padding: calc(32px + env(safe-area-inset-top, 0px)) 16px 40px;
      -webkit-text-size-adjust: 100%;
    }

    .app {
      width: 100%;
      max-width: 480px;
    }

    .card {
      background: var(--card-bg);
      border-radius: 28px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      padding: 22px 18px 22px;
      box-shadow:
        0 26px 60px rgba(15, 23, 42, 0.95),
        0 0 0 1px rgba(15, 23, 42, 0.9);
      backdrop-filter: blur(18px);
    }

    /* 공통 헤더 */

    .header {
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .header-icon {
      width: 42px;
      height: 42px;
      border-radius: 18px;
      padding: 2px;
      background: radial-gradient(circle at 30% 20%, #9f8cff 0, #4c1d95 45%, #111827 100%);
      box-shadow:
        0 8px 18px rgba(79, 70, 229, 0.9),
        0 0 0 1px rgba(30, 64, 175, 0.45);
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .header-icon img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 14px;
    }

    .header-text-main {
      font-size: 21px;
      font-weight: 800;
      letter-spacing: -0.02em;
    }

    .header-text-sub {
      margin-top: 4px;
      font-size: 14px;
      color: var(--text-sub);
    }

    /* 화면 전환 */

    .screen {
      display: none;
    }
    .screen.active {
      display: block;
    }

    /* ====== 첫 화면 (상황 선택) ====== */

    .tone-title-main {
      margin-top: 18px;
      font-size: 18px;
      font-weight: 700;
    }

    .tone-title-sub {
      margin-top: 8px;
      font-size: 15px;
    }

    .tone-desc {
      margin-top: 4px;
      font-size: 13px;
      color: #a5b4fc;
    }

    .tone-grid {
      margin-top: 18px;
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
    }

    .tone-btn {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.45);
      background: rgba(15, 23, 42, 0.96);
      color: var(--text-main);
      padding: 12px 10px;
      font-size: 15px;
      text-align: center;
      cursor: pointer;
    }

    .tone-btn.selected {
      border-color: #a5b4fc;
      box-shadow: 0 0 0 1px rgba(99, 102, 241, 0.6);
      background: radial-gradient(circle at top, rgba(79,70,229,0.55), rgba(15,23,42,0.98));
    }

    .tone-hint {
      margin-top: 8px;
      font-size: 12px;
      color: #94a3b8;
    }

    .btn-primary {
      width: 100%;
      border: none;
      border-radius: 20px;
      padding: 14px 16px;
      font-size: 16px;
      font-weight: 700;
      color: white;
      background: linear-gradient(90deg, var(--primary), var(--primary-dark));
      box-shadow:
        0 18px 38px rgba(79, 70, 229, 0.85),
        0 0 0 1px rgba(129, 140, 248, 0.7);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      margin-top: 22px;
    }

    .btn-primary:active {
      transform: translateY(1px);
      box-shadow:
        0 10px 26px rgba(79, 70, 229, 0.75),
        0 0 0 1px rgba(129, 140, 248, 0.7);
    }

    .status-text {
      font-size: 13px;
      color: #a5b4fc;
      min-height: 18px;
      margin-top: 6px;
    }

    /* ====== 두 번째 화면 (전체 기능) ====== */

    .back-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 10px;
    }

    .back-btn {
      border: none;
      background: none;
      color: #e5e7ff;
      font-size: 13px;
      display: inline-flex;
      align-items: center;
      gap: 3px;
      cursor: pointer;
      padding: 4px 0;
    }

    .back-btn span.arrow {
      font-size: 16px;
      transform: translateY(1px);
    }

    .tone-chip-current {
      margin-left: auto;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      font-size: 11px;
      color: #c7d2fe;
      background: rgba(15, 23, 42, 0.9);
      white-space: nowrap;
    }

    .tabs {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 6px;
      margin: 10px 0 14px;
      padding: 4px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.5);
    }

    .tab-btn {
      border-radius: 999px;
      border: none;
      font-size: 12px;
      padding: 6px 4px;
      color: #cbd5f5;
      background: transparent;
      cursor: pointer;
    }

    .tab-btn.active {
      background: linear-gradient(90deg, var(--primary), var(--primary-dark));
      color: white;
      box-shadow: 0 6px 14px rgba(79, 70, 229, 0.9);
    }

    .tab-panel {
      display: none;
    }
    .tab-panel.active {
      display: block;
    }

    .field-label {
      font-size: 14px;
      margin-bottom: 6px;
      color: #c7d2fe;
    }

    .textarea-wrap {
      position: relative;
      margin-bottom: 10px;
    }

    textarea {
      width: 100%;
      border-radius: 18px;
      border: 1px solid var(--border);
      background: rgba(15, 23, 42, 0.98);
      color: var(--text-main);
      font-size: 16px;
      padding: 12px 14px;
      min-height: 72px;
      line-height: 1.5;
      resize: vertical;
      outline: none;
      transition: border-color 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
    }

    textarea:focus {
      border-color: #818cf8;
      box-shadow: 0 0 0 1px rgba(129, 140, 248, 0.75);
      background: rgba(15, 23, 42, 1);
    }

    .hint {
      font-size: 13px;
      color: #94a3b8;
      margin-bottom: 12px;
    }

    .btn-generate {
      width: 100%;
      border: none;
      border-radius: 20px;
      padding: 13px 16px;
      font-size: 16px;
      font-weight: 700;
      color: white;
      background: linear-gradient(90deg, var(--primary), var(--primary-dark));
      box-shadow:
        0 18px 38px rgba(79, 70, 229, 0.85),
        0 0 0 1px rgba(129, 140, 248, 0.7);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      margin-bottom: 4px;
    }

    .btn-generate:active {
      transform: translateY(1px);
      box-shadow:
        0 10px 26px rgba(79, 70, 229, 0.75),
        0 0 0 1px rgba(129, 140, 248, 0.7);
    }

    .option-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
    }

    .length-group {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .pill {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(15, 23, 42, 0.9);
      color: #cbd5f5;
      font-size: 11px;
      padding: 4px 8px;
      cursor: pointer;
    }
    .pill.active {
      border-color: #a5b4fc;
      background: rgba(79, 70, 229, 0.9);
      color: white;
    }

    .again-wrap {
      text-align: center;
      margin-top: 14px;
    }

    .again-btn {
      border: none;
      background: none;
      color: #a5b4fc;
      font-size: 14px;
      text-decoration: underline;
      cursor: pointer;
    }

    /* ====== 결과 카드 / 공통 ====== */

    .result-wrapper {
      margin-top: 10px;
      border-radius: 22px;
      background:
        radial-gradient(circle at top, rgba(79, 70, 229, 0.25) 0, rgba(15, 23, 42, 0.98) 55%);
      border: 1px solid rgba(148, 163, 184, 0.45);
      padding: 14px 12px 12px;
    }

    .result-header-row {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 10px;
    }

    .result-header-title {
      font-size: 15px;
      font-weight: 700;
      letter-spacing: -0.01em;
    }

    .result-header-sub {
      font-size: 12px;
      color: #cbd5f5;
      margin-top: 2px;
    }

    .result-header-right {
      font-size: 12px;
      color: #a5b4fc;
      white-space: nowrap;
    }

    .answer-item {
      padding: 9px 9px 8px;
      border-radius: 14px;
      background: rgba(15, 23, 42, 0.96);
      border: 1px solid rgba(51, 65, 85, 0.9);
      margin-bottom: 8px;
      box-shadow: 0 6px 14px rgba(15, 23, 42, 0.9);
    }

    .answer-top-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 4px;
    }

    .answer-text {
      font-size: 15px;
    }

    .answer-meta {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 12px;
      color: #9ca3af;
    }

    .chips {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
      align-items: center;
    }

    .chip {
      padding: 3px 9px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.9);
      font-size: 12px;
    }

    .chip.score {
      white-space: nowrap;
    }

    .chip.safe {
      border-color: var(--safe);
      color: var(--safe);
      background: rgba(34, 197, 94, 0.12);
    }

    .chip.warn {
      border-color: var(--warn);
      color: var(--warn);
      background: rgba(234, 179, 8, 0.12);
    }

    .chip.danger {
      border-color: var(--danger);
      color: var(--danger);
      background: rgba(239, 68, 68, 0.12);
    }

    .copy-btn,
    .fav-btn {
      border-radius: 999px;
      border: none;
      padding: 5px 12px;
      font-size: 11px;
      cursor: pointer;
      white-space: nowrap;
    }

    .copy-btn {
      background: rgba(79, 70, 229, 0.9);
      color: #e5e7ff;
      min-width: 52px;
      text-align: center;
    }
    .copy-btn:active {
      transform: translateY(1px);
      background: rgba(79, 70, 229, 1);
    }

    .fav-btn {
      background: rgba(15, 23, 42, 0.9);
      color: #f97316;
      border: 1px solid rgba(249, 115, 22, 0.8);
      min-width: 44px;
    }
    .fav-btn.active {
      background: rgba(249, 115, 22, 0.18);
    }

    /* 로딩 스켈레톤 */

    .skeleton-item {
      padding: 9px 9px 7px;
      border-radius: 14px;
      background: rgba(15, 23, 42, 0.96);
      border: 1px solid rgba(51, 65, 85, 0.85);
      margin-bottom: 8px;
      overflow: hidden;
    }

    .skeleton-line {
      height: 10px;
      border-radius: 999px;
      background: linear-gradient(
        110deg,
        rgba(148, 163, 184, 0.25) 8%,
        rgba(148, 163, 184, 0.45) 18%,
        rgba(148, 163, 184, 0.18) 33%
      );
      background-size: 200% 100%;
      animation: shimmer 1.2s infinite;
      margin-bottom: 6px;
    }

    .skeleton-line.short { width: 40%; }
    .skeleton-line.mid   { width: 65%; }
    .skeleton-line.long  { width: 90%; }

    @keyframes shimmer {
      0% { background-position: -150% 0; }
      100% { background-position: 150% 0; }
    }

    .answer-item.fade-in {
      animation: fadeIn 0.22s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(4px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    /* 톡 캡처, 말투, 즐겨찾기용 약간의 스타일 */

    .upload-box {
      border-radius: 18px;
      border: 1px dashed rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.9);
      padding: 14px 12px;
      text-align: center;
      font-size: 13px;
      color: #cbd5f5;
      margin-bottom: 10px;
    }

    .upload-box input {
      margin-top: 8px;
      font-size: 12px;
    }

    .small-text {
      font-size: 12px;
      color: #94a3b8;
      margin-top: 4px;
    }

    .style-list {
      margin-top: 8px;
      font-size: 13px;
      color: #cbd5f5;
    }

    .style-badge {
      display: inline-block;
      margin-top: 4px;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.8);
      font-size: 11px;
      background: rgba(15, 23, 42, 0.9);
    }

    .favorite-empty {
      margin-top: 10px;
      font-size: 13px;
      color: #94a3b8;
      text-align: center;
    }

    /* ====== 세 번째 화면(결과 전용) 전용 스타일 ====== */

    .result-screen-header {
      margin-bottom: 10px;
    }

    .result-screen-title {
      font-size: 18px;
      font-weight: 700;
      margin-top: 8px;
    }

    .result-screen-sub {
      font-size: 13px;
      color: #a5b4fc;
      margin-top: 4px;
    }

    .result-progress {
      height: 4px;
      border-radius: 999px;
      background: linear-gradient(
        90deg,
        rgba(129, 140, 248, 0.2),
        rgba(129, 140, 248, 0.9),
        rgba(129, 140, 248, 0.2)
      );
      background-size: 200% 100%;
      animation: progressMove 1s infinite;
      margin: 10px 0 6px;
    }

    @keyframes progressMove {
      0% { background-position: 0% 0; }
      100% { background-position: 200% 0; }
    }

    .result-original {
      margin-bottom: 10px;
      padding: 8px 9px 7px;
      border-radius: 14px;
      background: rgba(15, 23, 42, 0.98);
      border: 1px solid rgba(55, 65, 81, 0.9);
    }

    .result-original-label {
      font-size: 12px;
      color: #9ca3af;
      margin-bottom: 4px;
    }

    .result-original-text {
      font-size: 14px;
      color: #e5e7eb;
    }

    .result-btn-row {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 12px;
      flex-wrap: wrap;
    }

    .result-nav-btn {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.8);
      background: rgba(15, 23, 42, 0.95);
      color: #e5e7ff;
      padding: 7px 14px;
      font-size: 13px;
      cursor: pointer;
    }

    .result-nav-btn.primary {
      border-color: transparent;
      background: linear-gradient(90deg, var(--primary), var(--primary-dark));
      box-shadow: 0 10px 24px rgba(79, 70, 229, 0.9);
    }

    @media (max-height: 680px) {
      body {
        align-items: flex-start;
        padding-top: 20px;
      }
    }
  </style>
</head>
<body>
  <main class="app">
    <!-- ====== 화면 1: 상황 선택 ====== -->
    <section class="card screen active" id="screen-tone">
      <header class="header">
        <div class="header-icon">
          <img src="/icon-192.png" alt="AI 대화 코치 아이콘" />
        </div>
        <div>
          <div class="header-text-main">AI 대화 코치</div>
          <div class="header-text-sub">먼저 대화 상황을 선택해 주세요</div>
        </div>
      </header>

      <div class="tone-title-main">어떤 상황의 답장을 도와드릴까요?</div>
      <p class="tone-title-sub">상황에 따라 톤을 다르게 추천해드려요.</p>
      <p class="tone-desc">아래에서 가장 가까운 상황을 골라 주세요.</p>

      <div class="tone-grid" id="toneGrid">
        <button type="button" class="tone-btn" data-tone="연애">연애</button>
        <button type="button" class="tone-btn" data-tone="썸">썸</button>
        <button type="button" class="tone-btn" data-tone="친구">친구</button>
        <button type="button" class="tone-btn" data-tone="직장">직장</button>
        <button type="button" class="tone-btn" data-tone="가족">가족</button>
        <button type="button" class="tone-btn" data-tone="기타">기타</button>
      </div>

      <p class="tone-hint">언제든지 뒤로 돌아와서 상황을 다시 바꿀 수 있어요.</p>

      <button class="btn-primary" type="button" id="nextBtn">
        다음 (답장 쓰러가기)
      </button>
      <div class="status-text" id="statusTone"></div>
    </section>

    <!-- ====== 화면 2: 기능 탭 ====== -->
    <section class="card screen" id="screen-main">
      <div class="back-row">
        <button class="back-btn" type="button" id="backBtn">
          <span class="arrow">←</span><span>다시 상황 선택</span>
        </button>
        <div class="tone-chip-current" id="toneChip">연애 톤</div>
      </div>

      <header class="header" style="margin-bottom:10px;">
        <div class="header-icon">
          <img src="/icon-192.png" alt="AI 대화 코치 아이콘" />
        </div>
        <div>
          <div class="header-text-main">AI 대화 코치</div>
          <div class="header-text-sub">답장 후보를 3가지로 추천해드려요</div>
        </div>
      </header>

      <!-- 탭 버튼 -->
      <div class="tabs" id="tabs">
        <button class="tab-btn active" data-tab="reply">AI 답장</button>
        <button class="tab-btn" data-tab="capture">톡 캡처</button>
        <button class="tab-btn" data-tab="favorite">즐겨찾기</button>
        <button class="tab-btn" data-tab="style">내 말투</button>
      </div>

      <!-- ===== 탭 1: AI 답장 ===== -->
      <section class="tab-panel active" id="tab-reply">
        <div class="field">
          <div class="field-label">상대방 메시지</div>
          <div class="textarea-wrap">
            <textarea id="message" placeholder="예) 오늘 뭐해?"></textarea>
          </div>
        </div>
        <p class="hint">카톡 내용을 그대로 붙여 넣어주세요.</p>

        <div class="option-row">
          <div class="length-group" id="lengthGroup">
            <span class="pill active" data-length="short">짧게</span>
            <span class="pill" data-length="normal">보통</span>
            <span class="pill" data-length="long">길게</span>
            <span class="pill" data-length="chat">대화형</span>
          </div>
        </div>

        <button class="btn-generate" id="generateBtn" type="button">
          AI 추천 답장 생성
        </button>
        <div class="status-text" id="statusReply"></div>

        <div class="again-wrap">
          <button class="again-btn" id="againBtn" type="button">입력 내용 지우기</button>
        </div>
      </section>

      <!-- ===== 탭 2: 톡 캡처 ===== -->
      <section class="tab-panel" id="tab-capture">
        <div class="field-label">톡 캡처 업로드</div>
        <div class="upload-box">
          캡처한 이미지를 업로드하면<br />텍스트를 자동으로 읽고 답장을 추천해줘요.
          <div>
            <input type="file" id="captureInput" accept="image/*" />
          </div>
          <div class="small-text">카카오톡, 인스타 DM, 문자 캡처 모두 가능</div>
        </div>

        <p class="hint">이미지를 선택하면 자동으로 분석을 시작합니다.</p>
        <div class="status-text" id="statusCapture"></div>

        <section id="resultCapture" style="display:none;">
          <div class="result-wrapper">
            <div class="result-header-row">
              <div>
                <div class="result-header-title">캡처 기반 AI 답장</div>
                <div class="result-header-sub">
                  마지막 대화 흐름을 보고 답장을 추천해드려요
                </div>
              </div>
            </div>
            <div id="answersCapture"></div>
          </div>
        </section>
      </section>

      <!-- ===== 탭 3: 즐겨찾기 ===== -->
      <section class="tab-panel" id="tab-favorite">
        <div class="field-label">즐겨찾기한 답장</div>
        <p class="hint">답장 카드의 하트 버튼을 눌러 저장할 수 있어요.</p>
        <div id="favoriteList"></div>
        <div class="favorite-empty" id="favoriteEmpty" style="display:none;">
          아직 즐겨찾기한 답장이 없어요.
        </div>
      </section>

      <!-- ===== 탭 4: 내 말투 학습 ===== -->
      <section class="tab-panel" id="tab-style">
        <div class="field-label">내 말투 예시</div>
        <div class="textarea-wrap">
          <textarea id="styleExamples" placeholder="예) 
1. 오늘 뭐해? 나 심심해 ㅎㅎ
2. 오~ 완전 좋지! 언제 볼까?
3. 나 좀 늦을 것 같아 미안 ㅠㅠ"></textarea>
        </div>
        <p class="hint">내가 평소에 자주 쓰는 말투, 이모티콘, 문장 스타일을 여러 줄로 적어주세요.</p>

        <button class="btn-generate" id="styleSaveBtn" type="button">
          내 말투 분석하기
        </button>
        <div class="status-text" id="statusStyle"></div>

        <div class="style-list" id="styleInfo" style="display:none;">
          <div>현재 적용된 말투:</div>
          <div class="style-badge" id="styleBadge">분석 중...</div>
          <div class="small-text">AI 답장에 이 말투가 최대한 반영됩니다.</div>
        </div>
      </section>
    </section>

    <!-- ====== 화면 3: 결과 전용 ====== -->
    <section class="card screen" id="screen-result">
      <div class="back-row">
        <button class="back-btn" type="button" id="resultBackBtn">
          <span class="arrow">←</span><span>답장 수정하기</span>
        </button>
        <div class="tone-chip-current" id="resultToneChip">연애 톤</div>
      </div>

      <div class="result-screen-header">
        <header class="header">
          <div class="header-icon">
            <img src="/icon-192.png" alt="AI 대화 코치 아이콘" />
          </div>
          <div>
            <div class="header-text-main">AI 추천 답장</div>
            <div class="header-text-sub">지금 대화에 딱 맞는 답장을 만들고 있어요</div>
          </div>
        </header>
        <div class="result-progress"></div>
        <div class="result-screen-sub" id="statusResult">
          AI가 답장을 생각 중입니다...
        </div>
      </div>

      <div class="result-wrapper">
        <div class="result-header-row">
          <div>
            <div class="result-header-title">추천 결과</div>
            <div class="result-header-sub">
              위험도·센스 점수는 가볍게 참고만 해주세요
            </div>
          </div>
          <div class="result-header-right">
            최대 3개까지 추천
          </div>
        </div>

        <div class="result-original">
          <div class="result-original-label">상대방 메시지</div>
          <div class="result-original-text" id="resultOriginalMessage"></div>
        </div>

        <div id="answersResult"></div>
      </div>

      <div class="result-btn-row">
        <button class="result-nav-btn primary" id="resultEditBtn" type="button">
          답장 다시 수정하기
        </button>
        <button class="result-nav-btn" id="resultHomeBtn" type="button">
          처음으로 돌아가기
        </button>
      </div>
    </section>
  </main>

  <script>
    // ===== 화면 전환 =====
    const screenTone   = document.getElementById("screen-tone");
    const screenMain   = document.getElementById("screen-main");
    const screenResult = document.getElementById("screen-result");

    function showScreen(name) {
      screenTone.classList.toggle("active", name === "tone");
      screenMain.classList.toggle("active", name === "main");
      screenResult.classList.toggle("active", name === "result");
    }

    // ===== 첫 화면: 톤 선택 =====
    const toneButtons = Array.from(document.querySelectorAll(".tone-btn"));
    const statusTone  = document.getElementById("statusTone");
    const toneChip    = document.getElementById("toneChip");
    const resultToneChip = document.getElementById("resultToneChip");
    let selectedTone  = "연애";

    toneButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        toneButtons.forEach(b => b.classList.remove("selected"));
        btn.classList.add("selected");
        selectedTone = btn.dataset.tone || "연애";
        statusTone.textContent = "";
      });
    });

    if (toneButtons[0]) toneButtons[0].classList.add("selected");

    document.getElementById("nextBtn").addEventListener("click", () => {
      if (!selectedTone) {
        statusTone.textContent = "먼저 상황을 하나 선택해 주세요.";
        return;
      }
      toneChip.textContent = selectedTone + " 톤";
      showScreen("main");
      document.getElementById("message").focus();
    });

    document.getElementById("backBtn").addEventListener("click", () => {
      showScreen("tone");
    });

    // ===== 탭 전환 =====
    const tabButtons = Array.from(document.querySelectorAll(".tab-btn"));
    const tabPanels  = {
      reply:   document.getElementById("tab-reply"),
      capture: document.getElementById("tab-capture"),
      favorite: document.getElementById("tab-favorite"),
      style:   document.getElementById("tab-style")
    };

    tabButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        const tab = btn.dataset.tab;
        tabButtons.forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        Object.entries(tabPanels).forEach(([key, panel]) => {
          panel.classList.toggle("active", key === tab);
        });
      });
    });

    // ===== 길이 옵션 =====
    const lengthGroup = document.getElementById("lengthGroup");
    let selectedLength = "short";

    lengthGroup.addEventListener("click", (e) => {
      const pill = e.target.closest(".pill");
      if (!pill) return;
      selectedLength = pill.dataset.length || "short";
      Array.from(lengthGroup.querySelectorAll(".pill")).forEach(p => p.classList.remove("active"));
      pill.classList.add("active");
    });

    // ===== 공통 파서 / 레벨 =====
    function parseLine(line) {
      const parts = line.split("||").map(p => p.trim());
      return {
        text: parts[0] || "",
        risk: parts[1] || "",
        sense: parts[2] || "",
        comment: parts[3] || ""
      };
    }

    function parseLevel(raw, kind, fallbackLevel) {
      const s = (raw || "").toString();
      let level = "";

      if (s.includes("낮음")) level = "낮음";
      else if (s.includes("중간")) level = "중간";
      else if (s.includes("높음")) level = "높음";

      if (!level && fallbackLevel) level = fallbackLevel;
      if (!level) level = "낮음";

      let score = "";
      if (level === "낮음") score = "25";
      else if (level === "중간") score = "55";
      else if (level === "높음") score = "85";

      if (kind === "risk") {
        return { level, score, text: `위험도 ${score}점 · ${level}` };
      } else {
        return { level, score, text: `센스 ${score}점 · ${level}` };
      }
    }

    function levelClass(level) {
      if (level === "낮음") return "safe";
      if (level === "중간") return "warn";
      if (level === "높음") return "danger";
      return "warn";
    }

    // ===== 즐겨찾기 (localStorage) =====
    const FAVORITE_KEY = "ai_reply_favorites_v1";

    function loadFavorites() {
      try {
        const raw = localStorage.getItem(FAVORITE_KEY);
        return raw ? JSON.parse(raw) : [];
      } catch {
        return [];
      }
    }

    function saveFavorites(list) {
      localStorage.setItem(FAVORITE_KEY, JSON.stringify(list));
    }

    function renderFavorites() {
      const listEl = document.getElementById("favoriteList");
      const emptyEl = document.getElementById("favoriteEmpty");
      const favorites = loadFavorites();

      listEl.innerHTML = "";
      if (favorites.length === 0) {
        emptyEl.style.display = "block";
        return;
      }
      emptyEl.style.display = "none";

      favorites.forEach((item, idx) => {
        const wrapper = document.createElement("div");
        wrapper.className = "answer-item";

        wrapper.innerHTML = `
          <div class="answer-top-row">
            <div class="answer-text">${idx + 1}. ${item.text}</div>
            <button class="copy-btn" type="button">복사</button>
          </div>
          <div class="answer-meta">
            <div class="chips">
              <span class="chip score ${levelClass(item.riskLevel)}">${item.riskText}</span>
              <span class="chip score">${item.senseText}</span>
              ${item.comment ? `<span class="chip">${item.comment}</span>` : ""}
            </div>
          </div>
        `;
        const copyBtn = wrapper.querySelector(".copy-btn");
        copyBtn.addEventListener("click", () => {
          navigator.clipboard.writeText(item.text).then(() => {
            copyBtn.textContent = "복사됨";
            setTimeout(() => (copyBtn.textContent = "복사"), 1200);
          });
        });

        listEl.appendChild(wrapper);
      });
    }

    document.querySelector('[data-tab="favorite"]').addEventListener("click", renderFavorites);

    // ===== 스켈레톤 =====
    function showSkeleton(target) {
      target.innerHTML = "";
      for (let i = 0; i < 3; i++) {
        const sk = document.createElement("div");
        sk.className = "skeleton-item";
        sk.innerHTML = `
          <div class="skeleton-line long"></div>
          <div class="skeleton-line mid"></div>
          <div class="skeleton-line short"></div>
        `;
        target.appendChild(sk);
      }
    }

    function clearSkeleton(target) {
      target.innerHTML = "";
    }

    // ===== 말투 프로필 =====
    const styleInfoDiv  = document.getElementById("styleInfo");
    const styleBadge    = document.getElementById("styleBadge");
    const statusStyle   = document.getElementById("statusStyle");
    const styleExamples = document.getElementById("styleExamples");
    const styleSaveBtn  = document.getElementById("styleSaveBtn");
    const STYLE_KEY     = "ai_reply_style_profile_v1";
    let cachedStyle     = null;

    function loadStyle() {
      try {
        const raw = localStorage.getItem(STYLE_KEY);
        if (!raw) return null;
        return JSON.parse(raw);
      } catch {
        return null;
      }
    }

    function saveStyle(profile) {
      localStorage.setItem(STYLE_KEY, JSON.stringify(profile));
    }

    function renderStyleInfo() {
      const profile = loadStyle();
      if (!profile) {
        styleInfoDiv.style.display = "none";
        cachedStyle = null;
        return;
      }
      cachedStyle = profile;
      styleInfoDiv.style.display = "block";
      styleBadge.textContent = profile.label || "내 말투 프로필";
    }

    renderStyleInfo();

    styleSaveBtn.addEventListener("click", async () => {
      const examples = styleExamples.value.trim();
      if (!examples) {
        statusStyle.textContent = "먼저 내 말투 예시를 여러 줄로 입력해 주세요.";
        return;
      }

      statusStyle.textContent = "내 말투를 분석 중입니다...";
      try {
        const res = await fetch("/style", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ examples })
        });

        const data = await res.json();
        if (!res.ok) {
          statusStyle.textContent = data.error || "말투 분석 중 오류가 발생했습니다.";
          return;
        }

        const profile = {
          id: data.styleId || "local-style",
          label: data.label || "내 말투"
        };
        saveStyle(profile);
        renderStyleInfo();
        statusStyle.textContent = "내 말투가 성공적으로 저장되었습니다.";
      } catch (err) {
        console.error(err);
        statusStyle.textContent = "서버와 통신 중 오류가 발생했습니다.";
      }
    });

    // ===== 답장 카드 생성 =====
    function createAnswerCard(answerText, riskInfo, senseInfo, comment, isFavorite) {
      const wrapper = document.createElement("div");
      wrapper.className = "answer-item fade-in";

      wrapper.innerHTML = `
        <div class="answer-top-row">
          <div class="answer-text">${answerText}</div>
          <div style="display:flex; gap:6px;">
            <button class="fav-btn ${isFavorite ? "active" : ""}" type="button">♥</button>
            <button class="copy-btn" type="button">복사</button>
          </div>
        </div>
        <div class="answer-meta">
          <div class="chips">
            <span class="chip score ${levelClass(riskInfo.level)}">${riskInfo.text}</span>
            <span class="chip score">${senseInfo.text}</span>
            ${comment ? `<span class="chip">${comment}</span>` : ""}
          </div>
        </div>
      `;

      const copyBtn = wrapper.querySelector(".copy-btn");
      copyBtn.addEventListener("click", () => {
        const textOnly = answerText.replace(/^\d+\.\s*/, "");
        navigator.clipboard.writeText(textOnly).then(() => {
          copyBtn.textContent = "복사됨";
          setTimeout(() => (copyBtn.textContent = "복사"), 1200);
        });
      });

      const favBtn = wrapper.querySelector(".fav-btn");
      favBtn.addEventListener("click", () => {
        const textOnly = answerText.replace(/^\d+\.\s*/, "");
        const list = loadFavorites();
        const existsIndex = list.findIndex(item => item.text === textOnly);
        if (existsIndex >= 0) {
          list.splice(existsIndex, 1);
          favBtn.classList.remove("active");
        } else {
          list.push({
            text: textOnly,
            riskLevel: riskInfo.level,
            riskText: riskInfo.text,
            senseText: senseInfo.text,
            comment
          });
          favBtn.classList.add("active");
        }
        saveFavorites(list);
      });

      return wrapper;
    }

    // ===== 2페이지: AI 답장 생성 → 3페이지로 전환 =====
    const msgEl           = document.getElementById("message");
    const generateBtn     = document.getElementById("generateBtn");
    const statusReply     = document.getElementById("statusReply");
    const againBtn        = document.getElementById("againBtn");

    const statusResult    = document.getElementById("statusResult");
    const resultOriginalMessage = document.getElementById("resultOriginalMessage");
    const answersResultEl = document.getElementById("answersResult");

    generateBtn.addEventListener("click", async () => {
      const text = msgEl.value.trim();
      if (!text) {
        statusReply.textContent = "먼저 상대방 메시지를 입력해 주세요.";
        return;
      }

      statusReply.textContent = "";
      statusResult.textContent = "AI가 답장을 생각 중입니다...";
      resultToneChip.textContent = selectedTone + " 톤";
      resultOriginalMessage.textContent = text;

      showScreen("result");
      showSkeleton(answersResultEl);

      try {
        const body = {
          text,
          tone: selectedTone || "기본",
          length: selectedLength,
          mode: selectedLength === "chat" ? "conversation" : "single",
          styleId: cachedStyle ? cachedStyle.id : null
        };

        const res = await fetch("/reply", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });

        const data = await res.json();

        if (!res.ok) {
          clearSkeleton(answersResultEl);
          statusResult.textContent = data.error || "답장 생성 중 오류가 발생했습니다.";
          return;
        }

        const lines = (data.reply || "")
          .split("\n")
          .map(l => l.trim())
          .filter(Boolean)
          .slice(0, 3);

        clearSkeleton(answersResultEl);

        if (lines.length === 0) {
          statusResult.textContent = "생성된 답장이 없습니다.";
          return;
        }

        statusResult.textContent = "AI 추천 답장이 준비됐어요.";

        const favorites = loadFavorites();

        lines.forEach((line, idx) => {
          const { text: rawText, risk, sense, comment } = parseLine(line);
          const textOnly = rawText.replace(/^\d+\.\s*/, "");

          const riskInfo  = parseLevel(risk, "risk");
          const senseInfo = parseLevel(sense, "sense", riskInfo.level);
          const isFavorite = favorites.some(f => f.text === textOnly);

          const card = createAnswerCard(`${idx + 1}. ${textOnly}`, riskInfo, senseInfo, comment, isFavorite);
          answersResultEl.appendChild(card);
        });
      } catch (err) {
        console.error(err);
        clearSkeleton(answersResultEl);
        statusResult.textContent = "서버와 통신 중 오류가 발생했습니다.";
      }
    });

    againBtn.addEventListener("click", () => {
      msgEl.value = "";
      statusReply.textContent = "";
      msgEl.focus();
    });

    // ===== 3페이지 내 네비게이션 =====
    const resultBackBtn = document.getElementById("resultBackBtn");
    const resultEditBtn = document.getElementById("resultEditBtn");
    const resultHomeBtn = document.getElementById("resultHomeBtn");

    function goBackToEdit() {
      showScreen("main");
      document.querySelector('[data-tab="reply"]').click();
      msgEl.focus();
    }

    resultBackBtn.addEventListener("click", goBackToEdit);
    resultEditBtn.addEventListener("click", goBackToEdit);

    resultHomeBtn.addEventListener("click", () => {
      showScreen("tone");
    });

    // ===== 톡 캡처 탭 =====
    const captureInput   = document.getElementById("captureInput");
    const statusCapture  = document.getElementById("statusCapture");
    const resultCapture  = document.getElementById("resultCapture");
    const answersCapture = document.getElementById("answersCapture");

    captureInput.addEventListener("change", async () => {
      const file = captureInput.files[0];
      if (!file) return;

      statusCapture.textContent = "이미지에서 텍스트를 읽고 있어요...";
      resultCapture.style.display = "block";
      showSkeleton(answersCapture);

      try {
        const formData = new FormData();
        formData.append("image", file);

        const resOcr = await fetch("/ocr", {
          method: "POST",
          body: formData
        });

        const dataOcr = await resOcr.json();
        if (!resOcr.ok || !dataOcr.text) {
          clearSkeleton(answersCapture);
          statusCapture.textContent = dataOcr.error || "이미지에서 텍스트를 읽지 못했어요.";
          return;
        }

        const ocrText = dataOcr.text;
        statusCapture.textContent = "대화 흐름을 분석 중입니다...";

        const res = await fetch("/reply", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            text: ocrText,
            tone: selectedTone || "기본",
            length: "short",
            mode: "capture",
            styleId: cachedStyle ? cachedStyle.id : null
          })
        });

        const data = await res.json();

        if (!res.ok) {
          clearSkeleton(answersCapture);
          statusCapture.textContent = data.error || "답장 생성 중 오류가 발생했습니다.";
          return;
        }

        statusCapture.textContent = "";
        const lines = (data.reply || "")
          .split("\n")
          .map(l => l.trim())
          .filter(Boolean)
          .slice(0, 3);

        clearSkeleton(answersCapture);

        if (lines.length === 0) {
          statusCapture.textContent = "생성된 답장이 없습니다.";
          resultCapture.style.display = "none";
          return;
        }

        const favorites = loadFavorites();

        lines.forEach((line, idx) => {
          const { text: rawText, risk, sense, comment } = parseLine(line);
          const textOnly = rawText.replace(/^\d+\.\s*/, "");

          const riskInfo  = parseLevel(risk, "risk");
          const senseInfo = parseLevel(sense, "sense", riskInfo.level);
          const isFavorite = favorites.some(f => f.text === textOnly);

          const card = createAnswerCard(`${idx + 1}. ${textOnly}`, riskInfo, senseInfo, comment, isFavorite);
          answersCapture.appendChild(card);
        });
      } catch (err) {
        console.error(err);
        clearSkeleton(answersCapture);
        statusCapture.textContent = "서버와 통신 중 오류가 발생했습니다.";
      } finally {
        captureInput.value = "";
      }
    });
  </script>
</body>
</html>
