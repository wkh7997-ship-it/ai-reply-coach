<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>AI 대화 코치</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <link rel="manifest" href="/manifest.json" />

  <style>
    :root {
      --primary: #6366f1;
      --primary-dark: #4f46e5;
      --card-bg: rgba(8, 12, 32, 0.96);
      --text-main: #f9fafb;
      --text-sub: #a5b4fc;
      --border: rgba(148, 163, 184, 0.35);
      --safe: #22c55e;
      --warn: #eab308;
      --danger: #ef4444;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      min-height: 100vh;
      background:
        radial-gradient(circle at top, #4c1d95 0, rgba(76, 29, 149, 0.25) 18%, transparent 35%),
        radial-gradient(circle at bottom, #0b1120 0, #020617 55%, #000 100%);
      color: var(--text-main);
      padding: 30px 16px 40px;
      display: flex;
      justify-content: center;
    }

    .app { width: 100%; max-width: 480px; }

    .screen { display: none; }
    .screen.active { display: block; }

    .card {
      background: var(--card-bg);
      border-radius: 28px;
      border: 1px solid rgba(148,163,184,0.35);
      padding: 22px 18px;
      box-shadow: 0 26px 60px rgba(15,23,42,0.95);
    }

    .header {
      display: flex;
      align-items: center;
      gap: 14px;
      margin-bottom: 12px;
    }

    .header-icon {
      width: 42px; height: 42px;
      border-radius: 18px;
      padding: 2px;
      background: radial-gradient(circle at 30% 20%, #9f8cff, #4c1d95 45%, #111827);
      box-shadow: 0 8px 18px rgba(79,70,229,0.9);
      display: flex; align-items: center; justify-content: center;
    }

    .header-icon img { width: 100%; height: 100%; border-radius: 14px; }

    .header-text-main { font-size: 20px; font-weight: 800; }
    .header-text-sub  { margin-top: 2px; font-size: 13px; color: var(--text-sub); }

    .field-label { font-size:14px; color:#c7d2fe; margin: 14px 0 6px; }
    textarea {
      width: 100%; padding:12px 14px; border-radius:18px;
      border:1px solid var(--border); background:#0f172a; color:white;
      font-size:16px; min-height:80px;
    }
    textarea:focus {
      border-color:#818cf8; box-shadow:0 0 0 1px rgba(129,140,248,0.75);
    }
    .btn-primary {
      width:100%; margin-top:16px; padding:14px;
      border-radius:20px; border:none;
      background: linear-gradient(90deg, var(--primary), var(--primary-dark));
      font-size:16px; font-weight:700; color:white;
    }

    /* 3페이지 */
    .result-wrapper {
      margin-top:14px; padding:14px 12px; border-radius:22px;
      background:rgba(15,23,42,0.96);
      border:1px solid rgba(148,163,184,0.45);
    }

    .answer-item {
      padding:10px; border-radius:16px;
      background:#0f172a;
      border:1px solid rgba(51,65,85,0.9);
      margin-top:10px;
    }

    .copy-btn {
      border:none; border-radius:999px;
      background:#4f46e5; color:white;
      padding:4px 12px; cursor:pointer;
    }

    /* 스켈레톤 */
    .skeleton-item {
      padding:12px; margin-top:10px;
      border-radius:16px;
      background:#0f172a;
      border:1px solid rgba(51,65,85,0.9);
      overflow:hidden;
    }

    .skeleton-line {
      height:10px; border-radius:999px;
      background: linear-gradient(110deg, rgba(148,163,184,0.25), rgba(148,163,184,0.45), rgba(148,163,184,0.25));
      background-size:200% 100%;
      animation: shimmer 1.2s infinite;
      margin-bottom:6px;
    }
    .short{width:40%} .mid{width:65%} .long{width:90%}

    @keyframes shimmer {
      0% {background-position:-150% 0;}
      100% {background-position:150% 0;}
    }

    .chip {
      padding:3px 8px; border-radius:999px;
      border:1px solid rgba(148,163,184,0.7);
      background:rgba(15,23,42,0.9);
      font-size:12px; margin-right:4px;
    }
    .safe{color:#22c55e;border-color:#22c55e;}
    .warn{color:#eab308;border-color:#eab308;}
    .danger{color:#ef4444;border-color:#ef4444;}
  </style>
</head>

<body>
<main class="app">

<!-- ===================== 2페이지 ===================== -->
<section class="card screen active" id="screen-input">
  <header class="header">
    <div class="header-icon"><img src="/icon-192.png" /></div>
    <div>
      <div class="header-text-main">AI 대화 코치</div>
      <div class="header-text-sub" id="inputSubtitle">AI 추천 답장을 3가지로 추천해드려요</div>
    </div>
  </header>

  <div class="field-label">상대방 메시지</div>
  <textarea id="message" placeholder="예) 내일 뭐해?"></textarea>

  <button class="btn-primary" id="generateBtn">AI 추천 답장 생성</button>
  <div class="status-text" id="statusReply" style="margin-top:8px; font-size:13px; color:#a5b4fc;"></div>
</section>

<!-- ===================== 3페이지 ===================== -->
<section class="card screen" id="screen-result">
  <header class="header">
    <div class="header-icon"><img src="/icon-192.png" /></div>
    <div>
      <div class="header-text-main">AI 추천 답장</div>
      <div class="header-text-sub" id="resultStatus">AI가 답장을 만드는 중이에요…</div>
    </div>
  </header>

  <div class="result-wrapper">
    <div style="font-size:13px; margin-bottom:6px; color:#c7d2fe;">상대방 메시지</div>
    <div id="originalText" style="font-size:14px; margin-bottom:16px;">-</div>

    <div id="answers"></div>
  </div>
</section>

</main>

<script>
  const screenInput  = document.getElementById("screen-input");
  const screenResult = document.getElementById("screen-result");
  const generateBtn  = document.getElementById("generateBtn");
  const inputSubtitle = document.getElementById("inputSubtitle");
  const msgEl         = document.getElementById("message");
  const resultStatus  = document.getElementById("resultStatus");
  const originalText  = document.getElementById("originalText");
  const answersEl     = document.getElementById("answers");

  function showScreen(name) {
    if (name === "input") {
      screenInput.classList.add("active");
      screenResult.classList.remove("active");
    } else {
      screenInput.classList.remove("active");
      screenResult.classList.add("active");
    }
  }

  function showSkeleton() {
    answersEl.innerHTML = "";
    for (let i = 0; i < 3; i++) {
      const sk = document.createElement("div");
      sk.className = "skeleton-item";
      sk.innerHTML = `
        <div class="skeleton-line long"></div>
        <div class="skeleton-line mid"></div>
        <div class="skeleton-line short"></div>
      `;
      answersEl.appendChild(sk);
    }
  }

  function parseLine(line) {
    const p = line.split("||").map(s=>s.trim());
    return { text:p[0], risk:p[1], sense:p[2], comment:p[3] };
  }

  function parseLevel(raw){
    const s = (raw||"");
    if (s.includes("높음")) return {level:"높음", score:"85"};
    if (s.includes("중간")) return {level:"중간", score:"55"};
    return {level:"낮음", score:"25"};
  }

  function levelClass(level){
    if(level==="낮음")return"safe";
    if(level==="중간")return"warn";
    return"danger";
  }

  generateBtn.addEventListener("click", () => {
    const text = msgEl.value.trim();
    if (!text) {
      alert("상대방 메시지를 입력해주세요.");
      return;
    }

    // ① 2페이지 문구 변경
    inputSubtitle.textContent = "AI 추천 답장을 생성 중이에요…";

    // ② 3페이지 초기 로딩 설정
    resultStatus.textContent = "AI가 답장을 만드는 중이에요…";
    originalText.textContent = text;
    answersEl.innerHTML = "";
    showSkeleton();

    // ③ 화면 전환
    showScreen("result");

    // ④ 실제 AI 호출
    generateReplies(text);
  });

  async function generateReplies(text){
    try {
      const res = await fetch("/reply", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({text})
      });

      const data = await res.json();

      const lines = data.reply
        .split("\n")
        .map(l=>l.trim())
        .filter(Boolean)
        .slice(0,3);

      resultStatus.textContent = "AI 추천 답장이 준비됐어요!";
      answersEl.innerHTML = "";

      lines.forEach((line, idx)=>{
        const {text, risk, sense, comment} = parseLine(line);
        const r = parseLevel(risk);
        const s = parseLevel(sense);

        const item = document.createElement("div");
        item.className = "answer-item";
        item.innerHTML = `
          <div style="font-size:15px; margin-bottom:6px;">
            ${idx+1}. ${text}
          </div>
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <div>
              <span class="chip ${levelClass(r.level)}">위험도 ${r.score}</span>
              <span class="chip">센스 ${s.score}</span>
              ${comment ? `<span class="chip">${comment}</span>` : ""}
            </div>
            <button class="copy-btn">복사</button>
          </div>
        `;

        item.querySelector(".copy-btn").addEventListener("click",()=>{
          navigator.clipboard.writeText(text);
          alert("복사되었습니다!");
        });

        answersEl.appendChild(item);
      });

    } catch (err) {
      resultStatus.textContent = "오류가 발생했습니다. 다시 시도해주세요.";
      answersEl.innerHTML = "";
    } finally {
      // 2페이지 문구 원래대로 복구
      inputSubtitle.textContent = "AI 추천 답장을 3가지로 추천해드려요";
    }
  }
</script>

</body>
</html>
